/*!
 * Mobile Recording Library for biological data collection. 
 * Version: 3.0.0-alpha
 *
 * https://github.com/NERC-CEH/morel
 *
 * Author 2015 Karols Kazlauskis
 * Released under the GNU GPL v3 * license.
 */
!function(a){var b="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global;if("function"==typeof define&&define.amd)define(["jquery","exports"],function(c,d){b.morel=a(b,d,c)});else if("undefined"!=typeof exports){try{$=require("jquery")}catch(c){}a(b,exports,$)}else b.morel=a(b,{},b.$||b.jQuery)}(function(a,b,c){"use strict";return b.VERSION="3.0.0-alpha",b.CONF={},b.TRUE=1,b.FALSE=0,b.ERROR=-1,b.SETTINGS_KEY="morel-settings",b.initSettings=function(){b.storage.set(b.SETTINGS_KEY,{})},b.reset=function(){b.storage.clear(),b.storage.tmpClear(),b.db.clear()},b.objClone=function(a){if(null===a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)a.hasOwnProperty(c)&&(b[c]=objClone(a[c]));return b},b.getNewUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},b.dataURItoBlob=function(a,b){for(var c=atob(a.split(",")[1]),d=[],e=0;e<c.length;e++)d.push(c.charCodeAt(e));return new Blob([new Uint8Array(d)],{type:b})},b.isDataURL=function(a){if(!a)return!1;a=a.toString();var b=/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i;return!!a.match(b)},b.isPlainObject=function(a){function b(a){for(var b={},c="Boolean Number String Function Array Date RegExp Object".split(" "),d=0;d<c.length;d++)b["[object "+c[d]+"]"]=c[d].toLowerCase();return null==a?String(a):b[toString.call(a)]||"object"}function c(a){return a&&"object"==typeof a&&"setInterval"in a}if(!a||"object"!==b(a)||a.nodeType||c(a))return!1;if(a.constructor&&!hasOwn.call(a,"constructor")&&!hasOwn.call(a.constructor.prototype,"isPrototypeOf"))return!1;var d;for(d in a);return void 0===d||hasOwn.call(a,d)},b.isEmptyObject=function(a){for(var b in a)return!1;return!0},b.extend=function(a,c){function d(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}return"function"==typeof c&&(c=c()),"string"==typeof a?(b[a]||(b[a]={}),d(b[a],c)):d(a,c)},b.formatDate=function(a){var b=a||new Date,c=("0"+b.getDate()).slice(-2),d=("0"+(b.getMonth()+1)).slice(-2);return c+"/"+d+"/"+b.getFullYear()},b.Occurrence=function(){var a=function(){this.id=b.getNewUUID(),this.attributes={},this.images=[]};return a.KEYS={TAXON:{name:"occurrence:taxa_taxon_list_id"},COMMENT:{name:"occurrence:comment"}},b.extend(a.prototype,{set:function(a,b){var c=this.key(a),d=this.value(a,b);this.attributes[c]=d},get:function(a){var b=this.key(a);return this.attributes[b]},remove:function(a){var b=this.key(a);delete this.attributes[b]},clear:function(){this.attributes={}},has:function(a){var b=this.get(a);return void 0!==b&&null!==b},removeAllImages:function(){this.images=[]},key:function(b){b=b.toUpperCase();var c=a.KEYS[b];return c&&c.name?c.name:(console.warn("morel.Occurrence: no such key: "+c),b)},value:function(b,c){var d=null;return b=b.toUpperCase(),"string"==typeof c&&a.KEYS[b]&&a.KEYS[b].values?(d=a.KEYS[b].values[c],d?d:(console.warn("morel.Occurrence: no such "+b+" value: "+c),c)):c},toJSON:function(){var a={sample:this.sample};return a}}),a}(),b.OccurrenceCollection=function(){var a=function(){this.occurrences=[]};return b.extend(a.prototype,{Occurrence:b.Occurrence,add:function(a){return this.set(a)},set:function(a){var b=[],c=null;a=a instanceof Array?a:[a];for(var d=0;d<a.length;d++)(c=this.get(a[d]))?(c.set(a[d].attributes),b.push(a[d])):(this.occurrences.push(a[d]),b.push(a[d]));return b},get:function(a){for(var b=a.id||a,c=0;c<this.occurrences.length;c++)if(this.occurrences[c].id==b)return this.occurrences[c];return null},create:function(){var a=new this.Occurrence;return this.add(a),a},remove:function(a){for(var a=a instanceof Array?a:[a],b=[],c=0;c<a.length;c++){var d=this.get(a[c]);if(d){for(var e=-1,f=0;e<this.occurrences.length;f++)if(this.occurrences[f].id===d.id){e=f;break}f>-1&&(this.occurrences.splice(e,1),b.push(d))}}return b},has:function(a){var b=this.get(a);return void 0!==b&&null!==b},size:function(){return this.occurrences.length}}),a}(),b.Sample=function(){var a=function(){this.id=b.getNewUUID(),this.occurrences=new b.OccurrenceCollection,this.attributes={};var a=new Date;this.set("DATE",b.formatDate(a)),this.set("LOCATION_TYPE","LATLON")};return a.KEYS={ID:{name:"sample:id"},SURVEY:{name:"sample:survey_id"},DATE:{name:"sample:date"},COMMENT:{name:"sample:comment"},IMAGE:{name:"sample:image"},LOCATION:{name:"sample:entered_sref"},LOCATION_TYPE:{name:"sample:entered_sref_system",values:{BRITISH:"OSGB",IRISH:"OSIE",LATLON:4326}},LOCATION_NAME:{name:"sample:location_name"},DELETED:{name:"sample:deleted"}},b.extend(a.prototype,{set:function(a,b){var c=this.key(a),d=this.value(a,b);this.attributes[c]=d},get:function(a){var b=this.key(a);return this.attributes[b]},remove:function(a){var b=this.key(a);delete this.attributes[b]},clear:function(){this.attributes={}},has:function(a){var b=this.get(a);return void 0!==b&&null!==b},key:function(b){b=b.toUpperCase();var c=a.KEYS[b];return c&&c.name?c.name:(console.warn("morel.Sample: no such key: "+c),b)},value:function(b,c){var d=null;return b=b.toUpperCase(),"string"==typeof c&&a.KEYS[b]&&a.KEYS[b].values?(d=a.KEYS[b].values[c],d?d:(console.warn("morel.Sample: no such "+b+" value: "+c),c)):c},toJSON:function(){var a={sample:this.sample};return a}}),a}(),b.Storage=function(){var a=function(){this.storage={}};return b.extend(a.prototype,{NAME:"Storage",get:function(a,b){var c=this.storage[a];b(null,c)},getAll:function(a){var b=this.storage;a(null,b)},set:function(a,b,c){this.storage[a]=b,c&&c(null,b)},remove:function(a,b){delete this.storage[a],b&&b()},has:function(a,b){this.get(a,function(a,c){b(null,void 0!==c&&null!==c)})},clear:function(a){this.storage={},a&&a(null,this.storage)},size:function(a){var b=Object.keys(this.storage).length;a(null,b)}}),a}(),b.LocalStorage=function(){var a=function(){};return b.extend(a.prototype,{NAME:"LocalStorage",get:function(a,b){var c=localStorage.getItem(a);c=JSON.parse(c),b(null,c)},getAll:function(a){for(var b={},c="",d=0,e=localStorage.length;e>d;++d)c=localStorage.key(d),b[c]=localStorage.getItem(c);a(null,b)},set:function(a,b,c){b=JSON.stringify(b),localStorage.setItem(a,b),c&&c(null,b)},remove:function(a,b){localStorage.removeItem(a),b&&b()},has:function(a,c){var d=this.get(a,function(a,e){e=b.isPlainObject(d)?!b.isEmptyObject(d):d,c(null,void 0!==e&&null!==e)})},clear:function(a){localStorage.clear(),a&&a()},size:function(a){a(null,localStorage.length)},hasSpace:function(a,b){var c=JSON.stringify(localStorage).length,d=5242880-c;d-a>0?b(null,1):b(null,0)}}),a}(),b.extend("Error",function(){var a=function(a){this.message=a};return a}),b.DatabaseStorage=function(){var a=function(){};return b.extend(a.prototype,{indexedDB:window._indexedDB||window.indexedDB,IDBKeyRange:window._IDBKeyRange||window.IDBKeyRange,VERSION:1,NAME:"DatabaseStorage",DB_NAME:"morel",STORE_NAME:"samples",set:function(a,c,d){this.open(function(e,f){if(e)return void(d&&d(e));var g=f.put(c,a);g.onsuccess=function(){d&&d(null,c)},g.onerror=function(a){var c="Database Problem: "+a.target.error.message,e=new b.Error(c);console.error(c),d(e)}})},get:function(a,c){this.open(function(d,e){if(d)return void c(d);var f=e.index("id").get(a);f.onsuccess=function(a){var b=a.target.result;c(null,b)},f.onerror=function(a){var d="Database Problem: "+a.target.error.message,e=new b.Error(d);console.error(d),c(e)}})},remove:function(a,c){var d=this;this.open(function(e,f){if(e)return void(c&&c(e));var g=f.openCursor(d.IDBKeyRange.only(a));g.onsuccess=function(){var a=g.result;a?(f["delete"](a.primaryKey),a["continue"]()):c&&c()},g.onerror=function(a){var d="Database Problem: "+a.target.error.message,e=new b.Error(d);console.error(d),c(e)}})},getAll:function(a){var c=this;this.open(function(d,e){if(d)return void a(d);var f=c.IDBKeyRange.lowerBound(0),g=e.openCursor(f),h={};g.onsuccess=function(b){var c=b.target.result;c?(h[c.key]=c.value,c["continue"]()):a(null,h)},g.onerror=function(c){var d="Database Problem: "+c.target.error.message,e=new b.Error(d);console.error(d),a(e)}})},has:function(a,b){this.get(a,function(a,c){return a?void b(a):void b(null,void 0!==c&&null!==c)})},clear:function(a){this.open(function(c,d){if(c)return void(a&&a(c));var e=d.clear();e.onsuccess=function(){a&&a()},e.onerror=function(c){var d="Database Problem: "+c.target.error.message,e=new b.Error(d);console.error(d),a&&a(e)}})},size:function(a){this.open(function(c,d){if(c)return void a(c);var e=d.count();e.onsuccess=function(){a(null,e.result)},e.onerror=function(c){var d="Database Problem: "+c.target.error.message,e=new b.Error(d);console.error(d),a(e)}})},open:function(a){var c=this,d=this.indexedDB.open(this.DB_NAME,this.VERSION);d.onsuccess=function(d){var e=d.target.result,f=e.transaction([c.STORE_NAME],"readwrite"),g=null,h=null;f&&(g=f.objectStore(c.STORE_NAME),g?a(null,g):(h=new b.Error("Database Problem: no such store"),a(h)))},d.onupgradeneeded=function(a){var b=a.target.result;b.createObjectStore(c.STORE_NAME)},d.onerror=function(c){var d="Database Problem: "+c.target.error.message,e=new b.Error(d);console.error(d),a(e)},d.onblocked=function(c){var d="Database Problem: "+c.target.error.message,e=new b.Error(d);console.error(d),a(e)}}}),a}(),b});