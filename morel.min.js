/*!
 * morel 3.0.0-alpha
 * Mobile Recording Library for biological data collection. 
 *
 * https://github.com/NERC-CEH/morel
 *
 * Author 2015 Karolis Kazlauskis
 * Released under the GNU GPL v3 license.
 * http://www.gnu.org/licenses/gpl.html
 */
!function(a){var b="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global;if("function"==typeof define&&define.amd)define(["jquery","exports"],function(c,d){b.morel=a(b,d,c)});else if("undefined"!=typeof exports){try{$=require("jquery")}catch(c){}a(b,exports,$)}else b.morel=a(b,{},b.$||b.jQuery)}(function(a,b,c){"use strict";return b.VERSION="3.0.0-alpha",b.CONF={},b.TRUE=1,b.FALSE=0,b.ERROR=-1,b.cloneDeep=function(a){if(null===a||"object"!=typeof a)return a;var c={};for(var d in a)a.hasOwnProperty(d)&&(c[d]=b.objClone(a[d]));return c},b.getNewUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},b.dataURItoBlob=function(a,b){for(var c=atob(a.split(",")[1]),d=[],e=0;e<c.length;e++)d.push(c.charCodeAt(e));return new Blob([new Uint8Array(d)],{type:b})},b.isDataURL=function(a){if(!a)return!1;a=a.toString();var b=/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i;return!!a.match(b)},b.isPlainObject=function(a){function b(a){for(var b={},c="Boolean Number String Function Array Date RegExp Object".split(" "),d=0;d<c.length;d++)b["[object "+c[d]+"]"]=c[d].toLowerCase();return null==a?String(a):b[toString.call(a)]||"object"}function c(a){return a&&"object"==typeof a&&"setInterval"in a}if(!a||"object"!==b(a)||a.nodeType||c(a))return!1;if(a.constructor&&!hasOwn.call(a,"constructor")&&!hasOwn.call(a.constructor.prototype,"isPrototypeOf"))return!1;var d;for(d in a);return void 0===d||hasOwn.call(a,d)},b.isEmptyObject=function(a){for(var b in a)return!1;return!0},b.extend=function(a,c){function d(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}return"function"==typeof c&&(c=c()),"string"==typeof a?(b[a]||(b[a]={}),d(b[a],c)):d(a,c)},b.formatDate=function(a){var b=new Date,c=0,d=0,e=/\d{2}\/\d{2}\/\d{4}$/,f=/\d{4}-\d{1,2}-\d{1,2}$/,g=/\d{1,2}-\d{1,2}-\d{4}$/,h=[];if("string"==typeof a){if(h=a.split("-"),e.test(a))return a;f.test(a)?a=new Date(parseInt(h[0]),parseInt(h[1])-1,parseInt(h[2])):g.test(a)&&(a=new Date(parseInt(h[2]),parseInt(h[1])-1,parseInt(h[0])))}return b=a||b,c=("0"+b.getDate()).slice(-2),d=("0"+(b.getMonth()+1)).slice(-2),c+"/"+d+"/"+b.getFullYear()},b.Events=function(){var a={on:function(a,b,c){var d=this._callbacks(a);d.push({callback:b,context:c})},off:function(a,b,c){},offAll:function(){this._events={}},trigger:function(a){for(var b=this._callbacks(a,!0),c=0;c<b.length;c++)b[c].callback.call(b[c].context||this)},_callbacks:function(a,b){a=a.toLowerCase();var c=a.split(":"),d=[];return this._events=this._events||{},this._events[c[0]]||(this._events[c[0]]={all:[]}),1===c.length?this._events[c[0]].all:(this._events[c[0]][c[1]]||(this._events[c[0]][c[1]]=[]),d=this._events[c[0]][c[1]],b&&(d=d.concat(this._events[c[0]].all)),d)}};return a}(),b.Image=function(){var a=function(a){return a||(a={}),this.id=a.id||b.getNewUUID(),"string"==typeof a?void(this.data=a):(this.url=a.url||"",void(this.data=a.data||""))};return b.extend(a,{toString:function(a,c){if(!window.FileReader){var d="No File Reader",e=new b.Error(d);return console.error(d),c(e)}var f=new FileReader;f.onload=function(b){c(null,b.target.result,a.type)},f.readAsDataURL(a)},resize:function(a,b,c,d,e){var f=new Image;f.onload=function(){var a=f.width,g=f.height,h=null,i=null;i=a>g?a/c:g/d,a/=i,g/=i,h=document.createElement("canvas"),h.width=a,h.height=g,h.getContext("2d").drawImage(f,0,0,a,g),e(null,f,h.toDataURL(b))},f.src=a}}),b.extend(a.prototype,{toJSON:function(){var a={id:this.id,url:this.url,data:this.data};return a}}),a}(),b.Collection=function(){var a=function(a){var c=null;if(this.Model=a.model,this.data=[],this.length=0,a.data instanceof Array)for(var d=0;d<a.data.length;d++)c=a.data[d],c instanceof this.Model?this.data.push(c):(b.extend(c,{plainAttributes:!0}),c=new this.Model(c),this.data.push(c)),this.length++;this.initialize()};return b.extend(a.prototype,{initialize:function(){},add:function(a){return this.set(a)},set:function(a){var b=[],c=null;a=a instanceof Array?a:[a];for(var d=0;d<a.length;d++)(c=this.get(a[d]))?c.attributes=a[d].attributes:("function"==typeof a[d].on&&a[d].on("change",this._modelEvent,this),this.data.push(a[d]),this.length++),b.push(a[d]);return this.trigger("update"),b},get:function(a){for(var b=a.id||a,c=0;c<this.data.length;c++)if(this.data[c].id==b)return this.data[c];return null},getFirst:function(){return this.data[0]},each:function(a){for(var b=0;b<this.data.length;b++)a(this.data[b])},create:function(){var a=new this.Model;return this.add(a),a},remove:function(a){for(var a=a instanceof Array?a:[a],b=[],c=0;c<a.length;c++){var d=this.get(a[c]);if(d){for(var e=-1,f=0;e<this.data.length;f++)if(this.data[f].id===d.id){e=f;break}f>-1&&(this.data.splice(e,1),this.length--,b.push(d))}}return this.trigger("update"),b},has:function(a){var b=this.get(a);return void 0!==b&&null!==b},size:function(){return this.data.length},clear:function(){this.data=[],this.length=0,this.trigger("update")},toJSON:function(){for(var a=[],b=0;b<this.data.length;b++)a.push(this.data[b].toJSON());return a},_modelEvent:function(){this.trigger("change")}}),b.extend(a.prototype,b.Events),a}(),b.Occurrence=function(){var a=function(a){var c=null,d=null,e=null;if(a||(a={}),this.id=a.id||b.getNewUUID(),this.attributes={},a.attributes)if(a.plainAttributes)this.attributes=a.attributes;else for(c in a.attributes)e=this.key(c),d=this.value(c,a.attributes[c]),this.attributes[e]=d;a.images?this.images=new b.Collection({model:b.Image,data:a.images}):this.images=new b.Collection({model:b.Image})};return a.KEYS={TAXON:{id:"taxa_taxon_list_id"},COMMENT:{id:"comment"}},b.extend(a.prototype,{set:function(a,b){var c=this.key(a),d=this.value(a,b),e=!1;this.attributes[c]!==d&&(e=!0),this.attributes[c]=d,e&&this.trigger("change:"+a)},get:function(a){var b=this.key(a);return this.attributes[b]},remove:function(a){var b=this.key(a);delete this.attributes[b],this.trigger("change:"+a)},clear:function(){this.attributes={},this.trigger("change")},has:function(a){var b=this.get(a);return void 0!==b&&null!==b},setImage:function(a,c){c=c||this.images.length,this.images[c]=new b.Image({data:a}),this.trigger("change:image")},removeImage:function(a){this.images=this.images.splice(a,1),this.trigger("change:image")},removeAllImages:function(){this.images=[],this.trigger("change:image")},key:function(b){b=b.toUpperCase();var c=a.KEYS[b];return c&&c.id?c.id:(console.warn("morel.Occurrence: no such key: "+b),b)},value:function(b,c){var d=null;return b=b.toUpperCase(),"object"==typeof c&&a.KEYS[b]&&a.KEYS[b].values?(d=a.KEYS[b].values[c],d?d:(console.warn("morel.Occurrence: no such "+b+" value: "+c),c)):c},toJSON:function(){var a={id:this.id,attributes:this.attributes,images:this.images.toJSON()};return a}}),b.extend(a.prototype,b.Events),a}(),b.Sample=function(){var a=function(a){var c=null,d=null,e=null;if(a||(a={}),this.id=a.id||b.getNewUUID(),this.attributes={},a.occurrences?this.occurrences=new b.Collection({model:b.Occurrence,data:a.occurrences}):this.occurrences=new b.Collection({model:b.Occurrence}),a.attributes)if(a.plainAttributes)this.attributes=a.attributes;else for(c in a.attributes)e=this.key(c),d=this.value(c,a.attributes[c]),this.attributes[e]=d;else{this.attributes={};var f=new Date;this.set("DATE",b.formatDate(f)),this.set("LOCATION_TYPE","LATLON")}};return a.KEYS={ID:{id:"id"},SURVEY:{id:"survey_id"},DATE:{id:"date"},COMMENT:{id:"comment"},IMAGE:{id:"image"},LOCATION:{id:"entered_sref"},LOCATION_TYPE:{id:"entered_sref_system",values:{BRITISH:"OSGB",IRISH:"OSIE",LATLON:4326}},LOCATION_NAME:{id:"location_name"},DELETED:{id:"deleted"}},b.extend(a.prototype,b.Events),b.extend(a.prototype,{set:function(a,b){var c=this.key(a),d=this.value(a,b),e=!1;this.attributes[c]!==d&&(e=!0),this.attributes[c]=d,e&&this.trigger("change:"+a)},get:function(a){var b=this.key(a);return this.attributes[b]},remove:function(a){var b=this.key(a);delete this.attributes[b],this.trigger("change:"+a)},clear:function(){this.attributes={},this.trigger("change")},has:function(a){var b=this.get(a);return void 0!==b&&null!==b},key:function(b){b=b.toUpperCase();var c=a.KEYS[b];return c&&c.id?c.id:(console.warn("morel.Sample: no such key: "+b),b)},value:function(b,c){var d=null;return b=b.toUpperCase(),"string"==typeof c&&a.KEYS[b]&&a.KEYS[b].values?(d=a.KEYS[b].values[c],d?d:(console.warn("morel.Sample: no such "+b+" value: "+c),c)):c},toJSON:function(){var a={id:this.id,attributes:this.attributes,occurrences:this.occurrences.toJSON()};return a},flatten:function(){var a=this.toJSON(),c={};b.extend(c,a.attributes);for(var d=0;d<a.occurrences.length;d++)b.extend(c,a.occurrences[d].attributes);return c},offAll:function(){this._events={},this.occurrences.offAll();for(var a=0;a<this.occurrences.data.length;a++)this.occurrences.data[a].offAll()}}),a}(),b.Auth=function(){var a=function(a){a||(a={}),b.extend(this.CONF,a)};return b.extend(a.prototype,{CONF:{appname:"",appsecret:"",survey_id:-1,website_id:-1},append:function(a){return this.appendApp(a),this.appendWarehouse(a),a},appendUser:function(a){if(this.isUser()){var b=this.getUser();a.append("email",b.email),a.append("usersecret",b.secret)}return a},appendApp:function(a){return a.append("appname",this.CONF.appname),a.append("appsecret",this.CONF.appsecret),a},appendWarehouse:function(a){return a.append("website_id",this.CONF.website_id),a.append("survey_id",this.CONF.survey_id),a},isUser:function(){var a=this.getUser();return 0!==Object.keys(a).length},getUser:function(){return b.settings(this.USER)||{}},setUser:function(a){b.settings(this.USER,a)},removeUser:function(){b.settings(this.USER,{})}}),a}(),b.PlainStorage=function(){var a=function(){this.storage={}};return b.extend(a.prototype,{NAME:"PlainStorage",get:function(a,b){var c=this.storage[a];b(null,c)},getAll:function(a){var b=this.storage;a(null,b)},set:function(a,b,c){this.storage[a]=b,c&&c(null,b)},remove:function(a,b){delete this.storage[a],b&&b()},has:function(a,b){this.get(a,function(a,c){b(null,void 0!==c&&null!==c)})},clear:function(a){this.storage={},a&&a(null,this.storage)},size:function(a){var b=Object.keys(this.storage).length;a(null,b)}}),a}(),b.LocalStorage=function(){var a=function(a){a||(a={}),this.storage=window.localStorage,this.NAME=a.appname?this.NAME+"-"+a.appname:this.NAME};return b.extend(a.prototype,{TYPE:"LocalStorage",NAME:"morel",get:function(a,b){var c=this.storage.getItem(this._getKey(a));c=JSON.parse(c),b(null,c)},getAll:function(a){for(var b={},c="",d=0,e=this.storage.length;e>d;++d)if(c=this.storage.key(d),-1!==c.indexOf(this._getPrefix())){var f=JSON.parse(this.storage.getItem(c));b[c]=f}a(null,b)},set:function(a,c,d){c=JSON.stringify(c);try{this.storage.setItem(this._getKey(a),c),d&&d(null,c)}catch(e){var f=this._isQuotaExceeded(e),g=f?"Storage exceed.":e.message;d&&d(new b.Error(g),c)}},remove:function(a,b){this.storage.removeItem(this._getKey(a)),b&&b()},has:function(a,b){this.get(a,function(a,c){b(null,void 0!==c&&null!==c)})},clear:function(a){this.storage.clear(),a&&a()},size:function(a){a(null,this.storage.length)},hasSpace:function(a,b){var c=JSON.stringify(this.storage).length,d=5242880-c;d-a>0?b(null,1):b(null,0)},_getKey:function(a){return this._getPrefix()+a},_getPrefix:function(){return this.NAME+"-"},_isQuotaExceeded:function(a){var b=!1;if(a)if(a.code)switch(a.code){case 22:b=!0;break;case 1014:"NS_ERROR_DOM_QUOTA_REACHED"===a.name&&(b=!0)}else-2147024882===a.number&&(b=!0);return b}}),a}(),b.Error=function(){var a=function(a){return"string"==typeof a?(this.number=-1,void(this.message=a)):(this.number=a.number||-1,void(this.message=a.message||""))};return a}(),b.DatabaseStorage=function(){var a=function(a){a||(a={}),this.NAME=a.appname?this.NAME+"-"+a.appname:this.NAME};return b.extend(a.prototype,{indexedDB:window._indexedDB||window.indexedDB,IDBKeyRange:window._IDBKeyRange||window.IDBKeyRange,VERSION:1,TYPE:"DatabaseStorage",NAME:"morel",STORE_NAME:"samples",set:function(a,c,d){this.open(function(e,f){if(e)return void(d&&d(e));c="function"==typeof c.toJSON?c.toJSON():c;var g=f.put(c,a);g.onsuccess=function(){d&&d(null,c)},g.onerror=function(a){var c="Database Problem: "+a.target.error.message,e=new b.Error(c);console.error(c),d(e)}})},get:function(a,c){this.open(function(d,e){if(d)return void c(d);var f=e.index("id").get(a);f.onsuccess=function(a){var b=a.target.result;c(null,b)},f.onerror=function(a){var d="Database Problem: "+a.target.error.message,e=new b.Error(d);console.error(d),c(e)}})},remove:function(a,c){var d=this;this.open(function(e,f){if(e)return void(c&&c(e));var g=f.openCursor(d.IDBKeyRange.only(a));g.onsuccess=function(){var a=g.result;a?(f["delete"](a.primaryKey),a["continue"]()):c&&c()},g.onerror=function(a){var d="Database Problem: "+a.target.error.message,e=new b.Error(d);console.error(d),c(e)}})},getAll:function(a){var c=this;this.open(function(d,e){if(d)return void a(d);var f=c.IDBKeyRange.lowerBound(0),g=e.openCursor(f),h={};g.onsuccess=function(b){var c=b.target.result;c?(h[c.key]=c.value,c["continue"]()):a(null,h)},g.onerror=function(c){var d="Database Problem: "+c.target.error.message,e=new b.Error(d);console.error(d),a(e)}})},has:function(a,b){this.get(a,function(a,c){return a?void b(a):void b(null,void 0!==c&&null!==c)})},clear:function(a){this.open(function(c,d){if(c)return void(a&&a(c));var e=d.clear();e.onsuccess=function(){a&&a()},e.onerror=function(c){var d="Database Problem: "+c.target.error.message,e=new b.Error(d);console.error(d),a&&a(e)}})},size:function(a){this.open(function(c,d){if(c)return void a(c);var e=d.count();e.onsuccess=function(){a(null,e.result)},e.onerror=function(c){var d="Database Problem: "+c.target.error.message,e=new b.Error(d);console.error(d),a(e)}})},open:function(a){var c=this,d=this.indexedDB.open(this.NAME,this.VERSION);d.onsuccess=function(d){var e=d.target.result,f=e.transaction([c.STORE_NAME],"readwrite"),g=null,h=null;f&&(g=f.objectStore(c.STORE_NAME),g?a(null,g):(h=new b.Error("Database Problem: no such store"),a(h)))},d.onupgradeneeded=function(a){var b=a.target.result;b.createObjectStore(c.STORE_NAME)},d.onerror=function(c){var d="Database Problem: "+c.target.error.message,e=new b.Error(d);console.error(d),a(e)},d.onblocked=function(c){var d="Database Problem: "+c.target.error.message,e=new b.Error(d);console.error(d),a(e)}}}),a}(),b.Storage=function(){var a=function(a){a||(a={});var c=this;this.Sample=a.Sample||b.Sample,this.Storage=a.Storage||b.LocalStorage,this.storage=new this.Storage({appname:a.appname}),this.cache={},this.initialized=!1,this.storage.getAll(function(a,d){for(var e=[],f=null,g=Object.keys(d),h=0;h<g.length;h++)f=new c.Sample(b.extend(d[g[h]],{plainAttributes:!0})),e.push(f);c.cache=new b.Collection({model:c.Sample,data:e}),c._attachListeners(),c.initialized=!0,c.trigger("init")})};return b.extend(a.prototype,{get:function(a,b){if(!this.initialized)return void this.on("init",function(){this.get(a,b)});var c="object"==typeof a?a.id:a;b(null,this.cache.get(c))},getAll:function(a){return this.initialized?void a(null,this.cache):void this.on("init",function(){this.getAll(a)})},set:function(a,b){if(!this.initialized)return void this.on("init",function(){this.set(a,b)});var c=this,d=a.id;this.storage.set(d,a,function(d){return d?void b(d):(c.cache.set(a),void(b&&b()))})},remove:function(a,b){if(!this.initialized)return void this.on("init",function(){this.remove(a,b)});var c=this,d="object"==typeof a?a.id:a;this.storage.remove(d,function(d){return d?void b(d):(c.cache.remove(a),void(b&&b()))})},has:function(a,b){if(!this.initialized)return void this.on("init",function(){this.has(a,b)});var c="object"==typeof a?a.id:a;this.cache.has(c,b)},clear:function(a){if(!this.initialized)return void this.on("init",function(){this.clear(item,a)});var b=this;this.storage.clear(function(c){return c?void a(c):(b.cache.clear(),void(a&&a()))})},_attachListeners:function(){var a=this;this.cache.on("update",function(){a.trigger("update")})}}),b.extend(a.prototype,b.Events),a}(),b.Manager=function(){var a=function(a){a||(a={}),this.CONF.url=a.url,this.CONF.appname=a.appname,this.auth=new b.Auth({appname:a.appname,appsecret:a.appsecret,survey_id:a.survey_id,website_id:a.website_id}),this.storage=new b.Storage({appname:a.appname,Storage:a.Storage}),this._attachListeners()};return b.extend(a.prototype,{CONF:{url:"",appname:""},get:function(a,b){this.storage.get(a,b)},getAll:function(a){this.storage.getAll(a)},set:function(a,b){this.storage.set(a,b)},remove:function(a,b){this.storage.remove(a,b)},has:function(a,b){this.storage.has(a,b)},clear:function(a){this.storage.clear(a)},sync:function(a,c){var d=this;return a instanceof b.Sample?void this.sendStored(a,c):void this.get(a,function(a,b){return a?void c(a):void d.sendStored(b,c)})},syncAll:function(a,b){this.sendAllStored(a,b)},sendAllStored:function(a,c){var d=this;this.getAll(function(e,f){if(e)return void c(e);for(var g=b.extend({},f.data),h=0;h<g.length;h++){var i=g[h];i.warehouse_id?delete g[h]:d.sendStored(i,function(b,d){return b?void(c&&c(b)):(delete g[h],void(0===g.length?c&&c(null):a&&a(null)))})}})},sendStored:function(a,b){var c=this;a.trigger("sync:request"),this.send(a,function(d,e){d?(a.trigger("sync:error"),b&&b(d)):(a.warehouse_id="done",c.set(a,function(c,d){a.trigger("sync:done"),b&&b(null,d)}))})},send:function(a,b){for(var c=a.flatten(),d=new FormData,e=Object.keys(c),f=0;f<e.length;f++)d.append(e[f],c[e[f]]);d=this.auth.append(d),this._post(d,b)},_post:function(a,c){var d=new XMLHttpRequest;d.onreadystatechange=function(){var a=null;if(d.readyState===XMLHttpRequest.DONE)switch(d.status){case 200:c(null,d.response);break;case 400:a=new b.Error(d.response),c(a);break;default:a=new b.Error("Unknown problem while sending request."),c&&c(a)}},d.open("POST",this.CONF.url,!0),d.setRequestHeader("Content-type","multipart/form-data"),d.send(a)},_attachListeners:function(){var a=this;this.storage.on("update",function(){a.trigger("update")})}}),b.extend(a.prototype,b.Events),a}(),b.extend("Geoloc",{CONF:{GPS_ACCURACY_LIMIT:100,HIGH_ACCURACY:!0,TIMEOUT:12e4},TIMEOUT_ERR:1,latitude:null,longitude:null,accuracy:-1,startTime:0,id:0,set:function(a,b,c){this.latitude=a,this.longitude=b,this.accuracy=c},get:function(){return{lat:this.latitude,lon:this.longitude,acc:this.accuracy}},clear:function(){this.set(null,null,-1)},isRunning:function(){return this.id},run:function(a,c,d){if(d=d||this.CONF.GPS_ACCURACY_LIMIT,!navigator.geolocation){var e=new b.Error("Geolocation is not supported.");return void(c&&c(e))}this.stop(),this.clear(),this.startTime=(new Date).getTime(),this.id=this.watchPosition(a,c,d)},stop:function(){navigator.geolocation.clearWatch(this.id),this.id=0},watchPosition:function(a,c,d){var e=this,f={enableHighAccuracy:this.CONF.HIGH_ACCURACY,maximumAge:0,timeout:this.CONF.TIMEOUT},g=function(f){var g=(new Date).getTime();if(g-e.startTime>e.TIMEOUT){e.stop();var h=new b.Error({number:e.TIMEOUT_ERR,message:"Geolocation timed out."});return void(c&&c(h))}var i={lat:f.coords.latitude,lon:f.coords.longitude,acc:f.coords.accuracy},j=e.accuracy;-1===j&&(j=i.acc+1),i.acc>-1&&i.acc<j&&(e.set(i.lat,i.lon,i.acc),i.acc<d?(e.stop(),c&&c(null,i)):a&&a(i))},h=function(a){var d=new b.Error(a.message);c&&c(d)};return navigator.geolocation.watchPosition(g,h,f)}}),b.extend(b.Geoloc,b.Events),b});