/*!
 * Mobile Recording Library for biological data collection. 
 * Version: 3.0.0-alpha
 *
 * https://github.com/NERC-CEH/morel
 *
 * Author 2015 Karols Kazlauskis
 * Released under the GNU GPL v3 * license.
 */
!function(a){var b="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global;if("function"==typeof define&&define.amd)define(["jquery","exports"],function(c,d){b.morel=a(b,d,c)});else if("undefined"!=typeof exports){try{$=require("jquery")}catch(c){}a(b,exports,$)}else b.morel=a(b,{},b.$||b.jQuery)}(function(a,b,c){"use strict";function d(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}return b.VERSION="3.0.0-alpha",b.CONF={},b.TRUE=1,b.FALSE=0,b.ERROR=-1,b.SETTINGS_KEY="morel-settings",b.extend=function(a,c){c="function"==typeof c?c(e):c||{};for(var d=a.split("."),e=b,f=0;f<d.length-1;f++)"object"!=typeof e[d[f]]&&(e[d[f]]={}),e=e[d[f]];return e[d[d.length-1]]=c,b[d[0]]},b.initSettings=function(){b.storage.set(b.SETTINGS_KEY,{})},b.settings=function(a,c){var d=b.storage.get(b.SETTINGS_KEY);return d||(b.initSettings(),d=b.storage.get(b.SETTINGS_KEY)),c?(d[a]=c,b.storage.set(b.SETTINGS_KEY,d)):a?d[a]:d},b.reset=function(){b.storage.clear(),b.storage.tmpClear(),b.db.clear()},b.extend("io",{CONF:{RECORD_URL:""},sendAllSavedRecords:function(a,d){var e=null,f=this;navigator.onLine?(e=function(c){var e=Object.keys(c)[0];if(e){var g=function(c){var e=this.callback_data.recordKey;b.db.remove(e),a&&a(),b.io.sendAllSavedRecords(a,d)};e=parseInt(e),f.sendSavedRecord(e,g)}else d&&d()},b.db.getAll(e)):(c.mobile.loading("show",{text:"Looks like you are offline!",theme:"b",textVisible:!0,textonly:!0}),setTimeout(function(){c.mobile.loading("hide")},3e3))},sendSavedRecord:function(a,c,d,e){function f(b){function f(a,b,c){var e="";e=a.responseText||c?a.status+" "+c+" "+a.responseText:"Error occurred while sending.";var f={message:e};d&&d(f)}var h={data:b,recordKey:a};g.postRecord(h,c,f,e)}var g=this;b.db.getData(a,f)},postRecord:function(a,d,e,f){var g={};if(a.data)g=a.data;else{var h=document.getElementById(a.id);g=new FormData(h)}g=b.auth.append(g),c.ajax({url:this.getRecordURL(),type:"POST",data:g,callback_data:a,cache:!1,enctype:"multipart/form-data",processData:!1,contentType:!1,success:d||function(a){this.callback_data.recordKey},error:e||function(a,b,c){},beforeSend:f||function(){}})},getRecordURL:function(){return this.CONF.RECORD_URL}}),b.extend("auth",{CONF:{APPNAME:"",APPSECRET:"",WEBSITE_ID:0,SURVEY_ID:0},USER:"user",append:function(a){return this.appendUser(a),this.appendApp(a),this.appendWarehouse(a),a},appendUser:function(a){if(this.isUser()){var b=this.getUser();a.append("email",b.email),a.append("usersecret",b.secret)}return a},appendApp:function(a){return a.append("appname",this.CONF.APPNAME),a.append("appsecret",this.CONF.APPSECRET),a},appendWarehouse:function(a){return a.append("website_id",this.CONF.WEBSITE_ID),a.append("survey_id",this.CONF.SURVEY_ID),a},isUser:function(){var a=this.getUser();return 0!==Object.keys(a).length},getUser:function(){return b.settings(this.USER)||{}},setUser:function(a){b.settings(this.USER,a)},removeUser:function(){b.settings(this.USER,{})}}),b.extend("geoloc",{CONF:{GPS_ACCURACY_LIMIT:26e3,HIGH_ACCURACY:!0,TIMEOUT:12e4},latitude:null,longitude:null,accuracy:-1,startTime:0,id:0,map:null,set:function(a,b,c){this.latitude=a,this.longitude=b,this.accuracy=c},get:function(){return{lat:this.latitude,lon:this.longitude,acc:this.accuracy}},clear:function(){this.set(null,null,-1)},getAccuracy:function(){return this.accuracy},run:function(a,c,d){return navigator.geolocation?(b.geoloc.stop(),b.geoloc.clear(),this.startTime=(new Date).getTime(),void(this.id=b.geoloc.watchPosition(a,c,d))):void(d&&d({message:"Geolocation is not supported!"}))},stop:function(){navigator.geolocation.clearWatch(b.geoloc.id)},watchPosition:function(a,c,d){var e=function(e){var f=(new Date).getTime();if(f-b.geoloc.startTime>b.geoloc.TIMEOUT)return b.geoloc.stop(),void(d&&d({message:"Geolocation timed out!"}));var g={lat:e.coords.latitude,lon:e.coords.longitude,acc:e.coords.accuracy},h=b.geoloc.getAccuracy();-1===h&&(h=g.acc+1),g.acc>-1&&g.acc<h&&(b.geoloc.set(g.lat,g.lon,g.acc),g.acc<b.geoloc.CONF.GPS_ACCURACY_LIMIT?(b.geoloc.stop(),b.settings("location",g),c&&c(g)):a&&a(g))},f=function(a){d&&d({message:a.message})},g={enableHighAccuracy:this.CONF.HIGH_ACCURACY,maximumAge:0,timeout:this.CONF.TIMEOUT};return navigator.geolocation.watchPosition(e,f,g)},valid:function(){var a=this.getAccuracy();return-1===a?b.ERROR:a>this.CONF.GPS_ACCURACY_LIMIT?b.FALSE:b.TRUE}}),b.objClone=function(a){if(null===a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)a.hasOwnProperty(c)&&(b[c]=objClone(a[c]));return b},b.getNewUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},b.dataURItoBlob=function(a,b){for(var c=atob(a.split(",")[1]),d=[],e=0;e<c.length;e++)d.push(c.charCodeAt(e));return new Blob([new Uint8Array(d)],{type:b})},b.isDataURL=function(a){if(!a)return!1;a=a.toString();var b=/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i;return!!a.match(b)},b.isPlainObject=function(a){function b(a){for(var b={},c="Boolean Number String Function Array Date RegExp Object".split(" "),d=0;d<c.length;d++)b["[object "+c[d]+"]"]=c[d].toLowerCase();return null==a?String(a):b[toString.call(a)]||"object"}function c(a){return a&&"object"==typeof a&&"setInterval"in a}if(!a||"object"!==b(a)||a.nodeType||c(a))return!1;if(a.constructor&&!hasOwn.call(a,"constructor")&&!hasOwn.call(a.constructor.prototype,"isPrototypeOf"))return!1;var d;for(d in a);return void 0===d||hasOwn.call(a,d)},b.isEmptyObject=function(a){for(var b in a)return!1;return!0},b.extend("image",{MAX_IMG_HEIGHT:800,MAX_IMG_WIDTH:800,extractAll:function(a,c,d){var e=b.image.findAll(a);e.length>0?b.image.toStringAll(e,c,d):c()},toString:function(a,c,d){if(a){var e=new FileReader;e.onload=function(){var f=new Image;f.onload=function(d){var e,g=f.width,h=f.height;e=g>h?g/b.image.MAX_IMG_WIDTH:h/b.image.MAX_IMG_HEIGHT,g/=e,h/=e;var i=document.createElement("canvas");i.width=g,i.height=h;var j=i.getContext("2d");j.drawImage(f,0,0,g,h);var k=i.toDataURL(a.type);_log("IMAGE: done shrinking file ("+k.length/1024+"KB).",b.LOG_DEBUG),c(k)},e.onerror=function(a){a.message=a.getMessage(),d(a)},f.src=e.result},e.readAsDataURL(a)}},toStringAll:function(a,c,d){function e(a,f){if(f=f||{},a.length>0){var g=a.pop(),h=g.file,i=g.input_field_name,j=function(b){f[i]=b,e(a,f,j)};b.image.toString(h,j,d)}else c(f)}e(a,null)},findAll:function(a){a||(a=window.document);for(var c=[],d=a.getElementsByTagName("input"),e=0;e<d.length;e++){var f=d[e];if("file"===f.getAttribute("type")&&f.files.length>0){var g=b.image.find(f);c.push(g)}}return c},find:function(a){var b={file:a.files[0],input_field_name:a.attributes.name.value};return b}}),b.extend("record",{RECORD:"record",MULTIPLE_GROUP_KEY:"multiple_",COUNT:"record_count",STORAGE:"record_",PIC:"_pic_",DATA:"data",FILES:"files",SETTINGS:"morel",LASTID:"lastId",totalFiles:0,init:function(){var a=this.getSettings();return a?null:(a={},a[this.LASTID]=0,this.setSettings(a),a)},setSettings:function(a){b.storage.set(this.SETTINGS,a)},initSettings:function(){var a={};return a[this.LASTID]=0,this.setSettings(a),a},getSettings:function(){var a=b.storage.get(this.SETTINGS)||this.initSettings();return a},get:function(){return b.storage.tmpGet(this.RECORD)||{}},set:function(a){b.storage.tmpSet(this.RECORD,a)},clear:function(){b.storage.tmpRemove(this.RECORD)},extractFromRecord:function(a){var b,d,e,f,g,h=[];return a.find("input").each(function(a,i){switch(b=c(i).attr("name"),d=c(i).attr("value"),e=c(i).attr("type"),f=c(i).attr("id"),g=!0,e){case"checkbox":g=c(i).is(":checked");break;case"text":d=c(i).val();break;case"radio":g=c(i).is(":checked");break;case"button":case"file":g=!1;break;case"hidden":}g&&""!==d&&h.push({name:b,value:d,type:e})}),a.find("textarea").each(function(a,f){b=c(f).attr("name"),d=c(f).val(),e="textarea",""!==d&&h.push({name:b,value:d,type:e})}),a.find("select").each(function(a,f){b=c(f).attr("name"),d=c(f).find(":selected").val(),e="select",""!==d&&h.push({name:b,value:d,type:e})}),h}}),b.extend("db",{indexedDB:window._indexedDB||window.indexedDB,IDBKeyRange:window._IDBKeyRange||window.IDBKeyRange,RECORDS:"records",DB_VERSION:1,DB_MAIN:"morel",STORE_RECORDS:"records",open:function(a,c){var d=b.CONF.NAME+"-"+this.DB_MAIN,e=this.indexedDB.open(d,this.DB_VERSION),f=this;e.onsuccess=function(b){var c=b.target.result,d=c.transaction([f.STORE_RECORDS],"readwrite"),e=d.objectStore(f.STORE_RECORDS);a&&a(e)},e.onupgradeneeded=function(a){var b=a.target.result,c=b.createObjectStore(f.STORE_RECORDS,{keyPath:"id"});c.createIndex("id","id",{unique:!0})},e.onerror=function(a){a.message="Database NOT opened successfully.",c&&c(a)},e.onblocked=function(a){c&&c(a)}},add:function(a,b,c,d){this.open(function(d){a.id=b;var e=d.add(a);e.onsuccess=function(a){c&&c()},d.transaction.db.close()},d)},get:function(a,b,c){this.open(function(c){var d=c.index("id").get(a);d.onsuccess=function(a){var c=a.target.result;b&&b(c)}},c)},remove:function(a,b,c){var d=this;this.open(function(c){var e=c.openCursor(d.IDBKeyRange.only(a));e.onsuccess=function(){var a=e.result;a?(c["delete"](a.primaryKey),a["continue"]()):b&&b()}},c)},getAll:function(a,b){var c=this;this.open(function(b){var d=c.IDBKeyRange.lowerBound(0),e=b.openCursor(d),f={};e.onsuccess=function(b){var c=b.target.result;c?(f[c.key]=c.value,c["continue"]()):a&&a(f)}},b)},is:function(a,b,c){function d(a){isPlainObject(a)?b&&b(!isEmptyObject(a)):b&&b(a)}this.get(a,d,c)},clear:function(a,b){this.open(function(b){b.clear(),a&&a()},b)},getData:function(a,b,c){function d(a){for(var c=new FormData,d=Object.keys(a),e=0;e<d.length;e++){var f=d[e],g=a[d[e]];if(isDataURL(g)){var h=g,i=h.split(";")[0].split(":")[1],j=i.split("/")[1];c.append(f,dataURItoBlob(h,i),"pic."+j)}else c.append(f,g)}b(c)}this.get(a,d,c)},save:function(a,c,e){var f=a||b.record.get(),g=this,h=b.record.getSettings(),i=++h[b.record.LASTID],j=function(a){function j(){b.record.setSettings(h),c&&c(i)}d(f,a),g.add(f,i,j,e)};return b.image.extractAll(null,j,e),b.TRUE},saveForm:function(a,c){var d=this.getAll(),e=this,f=b.record.getSettings(),g=++f[b.record.LASTID],h=document.getElementById(a),i=function(a){var i=b.record.extractFromRecord(h);i=i.concat(a);try{d[g]=i,e.setAll(d),b.record.setSettings(f)}catch(j){return b.ERROR}c&&c(g)};return b.image.getAll(i),b.TRUE}}),b.extend("record.inputs",{KEYS:{SREF:"sample:entered_sref",SREF_SYSTEM:"sample:entered_sref_system",SREF_ACCURACY:"smpAttr:273",TAXON:"occurrence:taxa_taxon_list_id",DATE:"sample:date",COMMENT:"sample:comment"},set:function(a,c){var d=b.record.get();d[a]=c,b.record.set(d)},get:function(a){var c=b.record.get();return c[a]},remove:function(a){var c=b.record.get();delete c[a],b.record.set(c)},is:function(a){var c=this.get(a);return b.isPlainObject(c)?!b.isEmptyObject(c):c}}),b.extend("storage",{hasSpace:function(a){return localStorageHasSpace(a)},get:function(a){a=b.CONF.NAME+"-"+a;var c=localStorage.getItem(a);return c=JSON.parse(c)},set:function(a,c){return a=b.CONF.NAME+"-"+a,c=JSON.stringify(c),localStorage.setItem(a,c)},remove:function(a){return a=b.CONF.NAME+"-"+a,localStorage.removeItem(a)},is:function(a){var c=this.get(a);return b.isPlainObject(c)?!b.isEmptyObject(c):c},clear:function(){localStorage.clear()},tmpGet:function(a){a=b.CONF.NAME+"-"+a;var c=sessionStorage.getItem(a);return c=JSON.parse(c)},tmpSet:function(a,c){return a=b.CONF.NAME+"-"+a,c=JSON.stringify(c),sessionStorage.setItem(a,c)},tmpRemove:function(a){return a=b.CONF.NAME+"-"+a,sessionStorage.removeItem(a)},tmpIs:function(a){var c=this.tmpGet(a);return b.isPlainObject(c)?!b.isEmptyObject(c):c},tmpClear:function(){sessionStorage.clear()},localStorageHasSpace:function(a){var b=JSON.stringify(localStorage).length,c=5242880-b;return c-a>0?1:0}}),b});