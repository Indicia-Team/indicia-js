/*!
 * Mobile Recording Library for biological data collection. 
 * Version: 2.0.0-beta.2
 *
 * https://github.com/NERC-CEH/morel
 *
 * Author 2015 Karols Kazlauskis
 * Released under the GNU GPL v3 * license.
 */
function objClone(a){"use strict";if(null===a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)a.hasOwnProperty(c)&&(b[c]=objClone(a[c]));return b}function dataURItoBlob(a,b){"use strict";for(var c=atob(a.split(",")[1]),d=[],e=0;e<c.length;e++)d.push(c.charCodeAt(e));return new Blob([new Uint8Array(d)],{type:b})}function isDataURL(a){"use strict";if(!a)return!1;a=a.toString();var b=/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i;return!!a.match(b)}var morel=function(){"use strict";var a={};return a.VERSION="2.0.0-beta.2",a.CONF={},a.TRUE=1,a.FALSE=0,a.ERROR=-1,a.SETTINGS_KEY="morel-settings",a.extend=function(b,c){for(var d=b.split("."),e=a[d[0]]=a[d[0]]||{},f=1;f<d.length;f++)"object"!==e[d[f]]&&(e[d[f]]={}),e=e[d[f]];return e="function"==typeof c?c(e):c||{}},a.initSettings=function(){morel.storage.set(a.SETTINGS_KEY,{})},a.settings=function(b,c){var d=morel.storage.get(a.SETTINGS_KEY);return d||(morel.initSettings(),d=morel.storage.get(a.SETTINGS_KEY)),c?(d[b]=c,morel.storage.set(a.SETTINGS_KEY,d)):b?d[b]:d},a.reset=function(){morel.storage.clear(),morel.storage.tmpClear(),morel.record.db.clear()},a}();morel.extend("io",function(a){"use strict";return a.CONF={RECORD_URL:""},a.sendAllSavedRecords=function(b,c){var d=null;navigator.onLine?(d=function(d){var e=Object.keys(d)[0];if(e){var f=function(){var a=this.callback_data.recordKey;morel.record.db.remove(a),b&&b(),morel.io.sendAllSavedRecords(b,c)};e=Number.parseInt(e),a.sendSavedRecord(e,f)}else c&&c()},morel.record.db.getAll(d)):($.mobile.loading("show",{text:"Looks like you are offline!",theme:"b",textVisible:!0,textonly:!0}),setTimeout(function(){$.mobile.loading("hide")},3e3))},a.sendSavedRecord=function(b,c,d,e){function f(f){function g(a,b,c){var e="";e=a.responseText||c?a.status+" "+c+" "+a.responseText:"Error occurred while sending.";var f={message:e};d&&d(f)}var h={data:f,recordKey:b};a.postRecord(h,c,g,e)}morel.record.db.getData(b,f)},a.postRecord=function(b,c,d,e){var f={};if(b.data)f=b.data;else{var g=document.getElementById(b.id);f=new FormData(g)}f=morel.auth.append(f),$.ajax({url:a.getRecordURL(),type:"POST",data:f,callback_data:b,cache:!1,enctype:"multipart/form-data",processData:!1,contentType:!1,success:c||function(){this.callback_data.recordKey},error:d||function(){},beforeSend:e||function(){}})},a.getRecordURL=function(){return a.CONF.RECORD_URL},a}),morel.extend("db",function(a){"use strict";return a.DB_VERSION=1,a.DB_MAIN="morel",a.STORE_MAIN="main",a.open=function(b,c,d){var e=window.indexedDB.open(b,a.DB_VERSION);e.onsuccess=function(a){var b=a.target.result,e=b.transaction([c],"readwrite"),f=e.objectStore(c);d&&d(f)},e.onupgradeneeded=function(a){var b=a.target.result;b.deleteObjectStore(morel.db.STORE_MAIN),b.createObjectStore(morel.db.STORE_MAIN)},e.onerror=function(){},e.onblocked=function(){}},a.add=function(b,c,d){var e=morel.CONF.NAME+"-"+a.DB_MAIN;a.open(e,a.STORE_MAIN,function(a){a.add(b,c),a.transaction.db.close(),d&&d()})},a.get=function(b,c){var d=morel.CONF.NAME+"-"+a.DB_MAIN;a.open(d,a.STORE_MAIN,function(a){var d=a.get(b);c&&c(d)})},a.getAll=function(b){var c=morel.CONF.NAME+"-"+a.DB_MAIN;a.open(c,a.STORE_MAIN,function(a){var c=IDBKeyRange.lowerBound(0),d=a.openCursor(c),e=[];d.onsuccess=function(a){var c=a.target.result;c?(e.push(c.value),c["continue"]()):b&&b(e)}})},a.is=function(){},a.clear=function(b){var c=morel.CONF.NAME+"-"+a.DB_MAIN;a.open(c,a.STORE_RECORDS,function(a){a.clear(),b&&b()})},a}),morel.extend("auth",function(a){"use strict";return a.CONF={APPNAME:"",APPSECRET:"",WEBSITE_ID:0,SURVEY_ID:0},a.USER="user",a.append=function(b){return a.appendUser(b),a.appendApp(b),a.appendWarehouse(b),b},a.appendUser=function(b){if(a.isUser()){var c=a.getUser();b.append("email",c.email),b.append("usersecret",c.secret)}return b},a.appendApp=function(a){return a.append("appname",this.CONF.APPNAME),a.append("appsecret",this.CONF.APPSECRET),a},a.appendWarehouse=function(a){return a.append("website_id",this.CONF.WEBSITE_ID),a.append("survey_id",this.CONF.SURVEY_ID),a},a.isUser=function(){var b=a.getUser();return 0!==Object.keys(b).length},a.getUser=function(){return morel.settings(a.USER)||{}},a.setUser=function(b){morel.settings(a.USER,b)},a.removeUser=function(){morel.settings(a.USER,{})},a}),morel.extend("record",function(a){"use strict";return a.RECORD="record",a.MULTIPLE_GROUP_KEY="multiple_",a.COUNT="record_count",a.STORAGE="record_",a.PIC="_pic_",a.DATA="data",a.FILES="files",a.SETTINGS="morel",a.LASTID="lastId",a.totalFiles=0,a.init=function(){var b=a.getSettings();return b?null:(b={},b[a.LASTID]=0,a.setSettings(b),b)},a.setSettings=function(b){morel.storage.set(a.SETTINGS,b)},a.initSettings=function(){var b={};return b[a.LASTID]=0,a.setSettings(b),b},a.getSettings=function(){var b=morel.storage.get(a.SETTINGS)||a.initSettings();return b},a.get=function(){return morel.storage.tmpGet(a.RECORD)||{}},a.set=function(b){morel.storage.tmpSet(a.RECORD,b)},a.clear=function(){morel.storage.tmpRemove(a.RECORD)},a.extractFromRecord=function(a){var b,c,d,e,f,g=[];return a.find("input").each(function(a,h){switch(b=$(h).attr("name"),c=$(h).attr("value"),d=$(h).attr("type"),e=$(h).attr("id"),f=!0,d){case"checkbox":f=$(h).is(":checked");break;case"text":c=$(h).val();break;case"radio":f=$(h).is(":checked");break;case"button":case"file":f=!1;break;case"hidden":}f&&""!==c&&g.push({name:b,value:c,type:d})}),a.find("textarea").each(function(a,e){b=$(e).attr("name"),c=$(e).val(),d="textarea",""!==c&&g.push({name:b,value:c,type:d})}),a.find("select").each(function(a,e){b=$(e).attr("name"),c=$(e).find(":selected").val(),d="select",""!==c&&g.push({name:b,value:c,type:d})}),g},a}),morel.extend("record.db",function(a){"use strict";return a.RECORDS="records",a.DB_VERSION=5,a.DB_MAIN="morel",a.STORE_RECORDS="records",a.open=function(b,c){var d=morel.CONF.NAME+"-"+a.DB_MAIN,e=window.indexedDB.open(d,a.DB_VERSION);e.onsuccess=function(c){var d=c.target.result,e=d.transaction([a.STORE_RECORDS],"readwrite"),f=e.objectStore(a.STORE_RECORDS);b&&b(f)},e.onupgradeneeded=function(b){var c=b.target.result,d=c.createObjectStore(a.STORE_RECORDS,{keyPath:"id"});d.createIndex("id","id",{unique:!0})},e.onerror=function(a){a.message="Database NOT opened successfully.",c&&c(a)},e.onblocked=function(a){c&&c(a)}},a.add=function(b,c,d,e){a.open(function(a){b.id=c;var e=a.add(b);e.onsuccess=function(){d&&d()},a.transaction.db.close()},e)},a.get=function(b,c,d){a.open(function(a){var d=a.index("id").get(b);d.onsuccess=function(a){var b=a.target.result;c&&c(b)}},d)},a.remove=function(b,c,d){a.open(function(a){var d=a.openCursor(IDBKeyRange.only(b));d.onsuccess=function(){var b=d.result;b?(a["delete"](b.primaryKey),b["continue"]()):c&&c()}},d)},a.getAll=function(b,c){a.open(function(a){var c=IDBKeyRange.lowerBound(0),d=a.openCursor(c),e={};d.onsuccess=function(a){var c=a.target.result;c?(e[c.key]=c.value,c["continue"]()):b&&b(e)}},c)},a.is=function(a,b,c){function d(a){$.isPlainObject(a)?b&&b(!$.isEmptyObject(a)):b&&b(a)}this.get(a,d,c)},a.clear=function(b,c){a.open(function(a){a.clear(),b&&b()},c)},a.getData=function(a,b,c){function d(a){for(var c=new FormData,d=Object.keys(a),e=0;e<d.length;e++){var f=d[e],g=a[d[e]];if(isDataURL(g)){var h=g,i=h.split(";")[0].split(":")[1],j=i.split("/")[1];c.append(f,dataURItoBlob(h,i),"pic."+j)}else c.append(f,g)}b(c)}this.get(a,d,c)},a.save=function(b,c,d){var e=b||morel.record.get(),f=morel.record.getSettings(),g=++f[morel.record.LASTID],h=function(b){function h(){morel.record.setSettings(f),c&&c(g)}jQuery.extend(e,b),a.add(e,g,h,d)};return morel.image.extractAll(null,h,d),morel.TRUE},a.saveForm=function(b,c){var d=this.getAll(),e=morel.record.getSettings(),f=++e[morel.record.LASTID],g=$(b),h=function(b){var h=morel.record.extractFromRecord(g);h=h.concat(b);try{d[f]=h,a.setAll(d),morel.record.setSettings(e)}catch(i){return morel.ERROR}c&&c(f)};return morel.image.getAll(h),morel.TRUE},a}),morel.extend("record.inputs",function(a){"use strict";return a.KEYS={SREF:"sample:entered_sref",SREF_SYSTEM:"sample:entered_sref_system",SREF_ACCURACY:"smpAttr:273",TAXON:"occurrence:taxa_taxon_list_id",DATE:"sample:date",COMMENT:"sample:comment"},a.set=function(a,b){var c=morel.record.get();c[a]=b,morel.record.set(c)},a.get=function(a){var b=morel.record.get();return b[a]},a.remove=function(a){var b=morel.record.get();delete b[a],morel.record.set(b)},a.is=function(a){var b=this.get(a);return $.isPlainObject(b)?!$.isEmptyObject(b):b},a}),morel.extend("geoloc",function(a){"use strict";return a.CONF={GPS_ACCURACY_LIMIT:26e3,HIGH_ACCURACY:!0,TIMEOUT:12e4},a.latitude=null,a.longitude=null,a.accuracy=-1,a.startTime=0,a.id=0,a.map=null,a.set=function(a,b,c){this.latitude=a,this.longitude=b,this.accuracy=c},a.get=function(){return{lat:this.latitude,lon:this.longitude,acc:this.accuracy}},a.clear=function(){a.set(null,null,-1)},a.getAccuracy=function(){return this.accuracy},a.run=function(a,b,c){return navigator.geolocation?(morel.geoloc.stop(),morel.geoloc.clear(),this.startTime=(new Date).getTime(),void(this.id=morel.geoloc.watchPosition(a,b,c))):void(c&&c({message:"Geolocation is not supported!"}))},a.stop=function(){navigator.geolocation.clearWatch(morel.geoloc.id)},a.watchPosition=function(b,c,d){var e=function(a){var e=(new Date).getTime();if(e-morel.geoloc.startTime>morel.geoloc.TIMEOUT)return morel.geoloc.stop(),void(d&&d({message:"Geolocation timed out!"}));var f={lat:a.coords.latitude,lon:a.coords.longitude,acc:a.coords.accuracy},g=morel.geoloc.getAccuracy();-1===g&&(g=f.acc+1),f.acc>-1&&f.acc<g&&(morel.geoloc.set(f.lat,f.lon,f.acc),f.acc<morel.geoloc.CONF.GPS_ACCURACY_LIMIT?(morel.geoloc.stop(),morel.settings("location",f),c&&c(f)):b&&b(f))},f=function(a){d&&d({message:a.message})},g={enableHighAccuracy:a.CONF.HIGH_ACCURACY,maximumAge:0,timeout:a.CONF.TIMEOUT};return navigator.geolocation.watchPosition(e,f,g)},a.valid=function(){var a=this.getAccuracy();return-1===a?morel.ERROR:a>this.CONF.GPS_ACCURACY_LIMIT?morel.FALSE:morel.TRUE},a}),morel.extend("storage",function(a){"use strict";function b(a){var b=JSON.stringify(localStorage).length,c=5242880-b;return c-a>0?1:0}return a.hasSpace=function(a){return b(a)},a.get=function(a){a=morel.CONF.NAME+"-"+a;var b=localStorage.getItem(a);return b=JSON.parse(b)},a.set=function(a,b){return a=morel.CONF.NAME+"-"+a,b=JSON.stringify(b),localStorage.setItem(a,b)},a.remove=function(a){return a=morel.CONF.NAME+"-"+a,localStorage.removeItem(a)},a.is=function(a){var b=this.get(a);return $.isPlainObject(b)?!$.isEmptyObject(b):b},a.clear=function(){localStorage.clear()},a.tmpGet=function(a){a=morel.CONF.NAME+"-"+a;var b=sessionStorage.getItem(a);return b=JSON.parse(b)},a.tmpSet=function(a,b){return a=morel.CONF.NAME+"-"+a,b=JSON.stringify(b),sessionStorage.setItem(a,b)},a.tmpRemove=function(a){return a=morel.CONF.NAME+"-"+a,sessionStorage.removeItem(a)},a.tmpIs=function(a){var b=this.tmpGet(a);return $.isPlainObject(b)?!$.isEmptyObject(b):b},a.tmpClear=function(){sessionStorage.clear()},a}),morel.extend("image",function(a){"use strict";return a.MAX_IMG_HEIGHT=800,a.MAX_IMG_WIDTH=800,a.extractAll=function(a,b,c){var d=morel.image.findAll(a);d.length>0?morel.image.toStringAll(d,b,c):b()},a.toString=function(a,b,c){if(a){var d=new FileReader;d.onload=function(){var e=new Image;e.onload=function(){var c,d=e.width,f=e.height;c=d>f?d/morel.image.MAX_IMG_WIDTH:f/morel.image.MAX_IMG_HEIGHT,d/=c,f/=c;var g=document.createElement("canvas");g.width=d,g.height=f;var h=g.getContext("2d");h.drawImage(e,0,0,d,f);var i=g.toDataURL(a.type);_log("IMAGE: done shrinking file ("+i.length/1024+"KB).",morel.LOG_DEBUG),b(i)},d.onerror=function(a){a.message=a.getMessage(),c(a)},e.src=d.result},d.readAsDataURL(a)}},a.toStringAll=function(a,b,c){function d(a,e){if(e=e||{},a.length>0){var f=a.pop(),g=f.file,h=f.input_field_name,i=function(b){e[h]=b,d(a,e,i)};morel.image.toString(g,i,c)}else b(e)}d(a,null)},a.findAll=function(a){a||(a=$(document));var b=[];return $(a).find("input").each(function(a,c){if("file"===$(c).attr("type")&&c.files.length>0){var d=morel.image.find(c);b.push(d)}}),b},a.find=function(a){var b={file:a.files[0],input_field_name:a.attributes.name.value};return b},a});