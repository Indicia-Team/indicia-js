/*!
 * 
 * morel 3.1.3
 * Mobile Recording Library for biological data collection.
 * https://github.com/NERC-CEH/morel
 * Author Karolis Kazlauskis
 * Released under the GNU GPL v3 license.
 * http://www.gnu.org/licenses/gpl.html
 * 
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("underscore"),require("backbone"),require("jquery")):"function"==typeof define&&define.amd?define("Morel",["_","Backbone","$"],t):"object"==typeof exports?exports.Morel=t(require("underscore"),require("backbone"),require("jquery")):e.Morel=t(e._,e.Backbone,e.$)}(this,function(e,t,n){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(1),s=r(o),u=n(2),c=r(u),l=n(3),d=r(l),f=n(9),h=r(f),v=n(11),p=r(v),g=n(13),y=r(g),m=n(12),b=r(m),w=n(6),_=r(w),S=n(8),x=r(S),O=n(4),k=r(O),I=n(5),D=r(I),E=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];i(this,e),this.options=t,this.storage=new p["default"]({appname:t.appname,Sample:t.Sample,Storage:t.Storage,manager:this}),this.onSend=t.onSend,this._attachListeners(),this.synchronising=!1}return a(e,[{key:"get",value:function(e,t,n){this.storage.get(e,t,n)}},{key:"getAll",value:function(e,t){this.storage.getAll(e,t)}},{key:"set",value:function(e,t,n){e.manager=this,this.storage.set(e,t,n)}},{key:"remove",value:function(e,t,n){this.storage.remove(e,t,n)}},{key:"has",value:function(e,t,n){this.storage.has(e,t,n)}},{key:"clear",value:function(e,t){this.storage.clear(e,t)}},{key:"syncAll",value:function(e,t){function n(e){var t=[];e.each(function(e){var n=e.save(null,{remote:!0,timeout:r.timeout}),i=void 0;i=n?new Promise(function(e){n.then(function(){e()})["catch"](function(){e()})}):Promise.resolve(),t.push(i)}),Promise.all(t).then(function(){i(),r.success&&r.success()})}var r=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],i=void 0,a=void 0,o=new Promise(function(e,t){i=e,a=t});return t?(n(t),o):(this.getAll(function(e,t){return e?(a(),void(r.error&&r.error(e))):void n(t)}),o)}},{key:"sync",value:function(t,n){var r=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];if(n.getSyncStatus()===k["default"].SYNCED||n.getSyncStatus()===k["default"].SYNCHRONISING)return!1;r.url=n.manager.options.url;var i=r.success;r.success=function(e){e.save().then(function(){e.trigger("sync"),i&&i()})};var a=e.prototype.post.apply(n.manager,[n,r]);return a}},{key:"post",value:function(e,t){var n=this,r=e.onSend||this.onSend,i=r&&r(e);if(i)return!1;e.synchronising=!0;var a=t.success;t.success=function(){e.synchronising=!1,e.metadata.warehouse_id=1,e.metadata.server_on=e.metadata.updated_on=e.metadata.synced_on=new Date,a&&a(e,null,t)};var o=t.error;t.error=function(n,r,i){e.synchronising=!1,e.trigger("error"),t.textStatus=r,t.errorThrown=i,o&&o.call(t.context,n,r,i)};var s=new Promise(function(r,i){n._getModelFormData(e,function(n,a){var o=t.xhr=c["default"].ajax({url:t.url,type:"POST",data:a,processData:!1,contentType:!1,timeout:t.timeout||3e4,success:t.success,error:t.error});o.done(function(e,t,n){r(e,t,n)}),o.fail(function(e,t,n){i(e,t,n)}),e.trigger("request",e,o,t)})});return s}},{key:"_attachListeners",value:function(){var e=this;this.storage.on("update",function(){e.trigger("update")})}},{key:"_getModelFormData",value:function(e,t){var n=this,r=e.flatten(this._flattener),i=new FormData,a=0,o=[];e.occurrences.each(function(e){var t=a,n=0,r=[];e.images.each(function(e){function a(e,r,a,s){var u="sc:"+t+"::photo"+n,l=c,d=c;c.match(/image.*/)?l=c.split("/")[1]:d="image/"+d,s||(s=D["default"].dataURItoBlob(a,d)),i.append(u,s,"pic."+l),n++,o()}var o=void 0,s=new Promise(function(e){o=e});r.push(s);var u=e.getURL(),c=e.get("type");D["default"].isDataURL(u)?a(null,null,u):!function(){var e=new XMLHttpRequest;e.open("GET",u,!0),e.responseType="blob",e.onload=function(){a(null,null,null,e.response)},e.send()}()}),o.push(Promise.all(r)),a++}),Promise.all(o).then(function(){for(var e=Object.keys(r),a=0;a<e.length;a++)i.append(e[a],r[e[a]]);i=n.appendAuth(i),t(null,i)})}},{key:"_flattener",value:function(t,n){var r=n.flattened||{},i=n.keys||{},a=n.count,o=null,u=null,c=null,l="",d="sample:",f="smpAttr:";this instanceof h["default"]&&(l="sc:",d="::occurrence:",f="::occAttr:");var v=this.cid||this.id;v&&(this instanceof h["default"]?r[l+a+d+"external_key"]=v:r[d+"external_key"]=this.cid||this.id);for(o in t)if(i[o]){if(u=i[o].id,u?(u=parseInt(u,10)>=0?f+u:d+u,l&&(u=l+a+u)):u=l+a+"::present",t[o]){if(c=t[o],i[o].values)if("function"==typeof i[o].values){var p=s["default"].extend(n,{flattener:e.prototype._flattener,flattened:r});c=i[o].values(c,p)}else c=i[o].values[c];c&&(r[u]=c)}}else"email"!==o&&"usersecret"!==o&&console.warn("Morel: no such key: "+o),r[o]=t[o];return r}},{key:"appendAuth",value:function(e){return this._appendAppAuth(e),this._appendWarehouseAuth(e),e}},{key:"_appendAppAuth",value:function(e){return e.append("appname",this.options.appname),e.append("appsecret",this.options.appsecret),e}},{key:"_appendWarehouseAuth",value:function(e){return e.append("website_id",this.options.website_id),e.append("survey_id",this.options.survey_id),e}}]),e}();s["default"].extend(E.prototype,c["default"].Events),s["default"].extend(E,k["default"],{VERSION:"3.1.3",Sample:d["default"],Occurrence:h["default"],DatabaseStorage:y["default"],LocalStorage:b["default"],Image:_["default"],Error:x["default"]}),t["default"]=E},function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},a=n(2),o=r(a),s=n(1),u=r(s),c=n(4),l=r(c),d=n(5),f=r(d),h=n(6),v=r(h),p=n(9),g=r(p),y=n(10),m=r(y),b=o["default"].Model.extend({Image:v["default"],Occurrence:g["default"],constructor:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=this,i=t,a={date:new Date,location_type:"latlon"};if(i=u["default"].extend(a,i),this.cid=n.cid||n.id||f["default"].getNewUUID(),this.manager=n.manager||this.manager,this.manager&&(this.sync=this.manager.sync),n.Image&&(this.Image=n.Image),n.Occurrence&&(this.Occurrence=n.Occurrence),n.onSend&&(this.onSend=n.onSend),this.attributes={},n.collection&&(this.collection=n.collection),n.parse&&(i=this.parse(i,n)||{}),i=u["default"].defaults({},i,u["default"].result(this,"defaults")),this.set(i,n),this.changed={},n.metadata)this.metadata=n.metadata;else{var o=new Date;this.metadata={created_on:o,updated_on:o,warehouse_id:null,synced_on:null,server_on:null}}n.occurrences?!function(){var t=[];u["default"].each(n.occurrences,function(e){if(e instanceof r.Occurrence)e.setSample(r),t.push(e);else{var n=u["default"].extend(e,{sample:r});t.push(new r.Occurrence(e.attributes,n))}}),e.occurrences=new m["default"](t,{model:e.Occurrence})}():this.occurrences=new m["default"]([],{model:this.Occurrence}),n.images?!function(){var t=[];u["default"].each(n.images,function(n){if(n instanceof e.Image)n.setParent(r),t.push(n);else{var i=u["default"].extend(n,{parent:r});t.push(new e.Image(n.attributes,i))}}),e.images=new m["default"](t,{model:e.Image})}():this.images=new m["default"]([],{model:this.Image}),this.initialize.apply(this,arguments)},save:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=this,a=void 0;if(!this.manager)return!1;if(!n.remote){var s=function(){var e=void 0,i=void 0;return a=new Promise(function(t,n){e=t,i=n}),t.manager.set(t,function(t){return t?(i(t),void(n.error&&n.error(t))):(e(r,{},n),void(n.success&&n.success(r,{},n)))}),{v:a}}();if("object"===("undefined"==typeof s?"undefined":i(s)))return s.v}return a=o["default"].Model.prototype.save.apply(this,arguments)},destroy:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=void 0,n=new Promise(function(e){t=e});return this.manager&&!e.noSave?this.manager.remove(this,function(n){return n?void(e.error&&e.error(n)):(t(),void(e.success&&e.success()))}):(this.stopListening(),this.trigger("destroy",this,this.collection,e),t(),e.success&&e.success()),n},addOccurrence:function(e){e&&(e.setSample(this),this.occurrences.push(e))},addImage:function(e){e&&(e.setParent(this),this.images.add(e))},validate:function(e){var t=u["default"].extend({},this.attributes,e),n={},r={};if(t.location||(n.location="can't be blank"),t.location_type||(n.location_type="can't be blank"),t.date){var i=new Date(t.date);("Invalid Date"===i||i>new Date)&&(n.date=new Date(i)>new Date?"future date":"invalid")}else n.date="can't be blank";if(0===this.occurrences.length?n.occurrences="no occurrences":this.occurrences.each(function(e){var t=e.validate();if(t){var n=e.id||e.cid;r[n]=t}}),!u["default"].isEmpty(n)||!u["default"].isEmpty(r)){var a={sample:n,occurrences:r};return a}return null},flatten:function(e){var t=e.apply(this,[this.attributes,{keys:b.keys}]);return u["default"].extend(t,this.occurrences.flatten(e)),t},toJSON:function(){var e=void 0,t=this.occurrences;t?e=t.toJSON():(e=[],console.warn("toJSON occurrences missing"));var n=void 0,r=this.images;r?n=r.toJSON():(n=[],console.warn("toJSON images missing"));var i={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,occurrences:e,images:n};return i},getSyncStatus:function(){var e=this.metadata;return this.synchronising?l["default"].SYNCHRONISING:e.warehouse_id?e.synced_on?e.synced_on<e.updated_on?e.synced_on<e.server_on?l["default"].CONFLICT:l["default"].CHANGED_LOCALLY:e.synced_on<e.server_on?l["default"].CHANGED_SERVER:l["default"].SYNCED:l["default"].SERVER:l["default"].LOCAL},offAll:function(){this._events={},this.occurrences.offAll();for(var e=0;e<this.occurrences.data.length;e++)this.occurrences.models[e].offAll()}});b.keys={id:{id:"id"},survey:{id:"survey_id"},date:{id:"date"},comment:{id:"comment"},image:{id:"image"},location:{id:"entered_sref"},location_type:{id:"entered_sref_system",values:{british:"OSGB",irish:"OSIE",latlon:4326}},location_name:{id:"location_name"},form:{id:"input_form"},group:{id:"group_id"},deleted:{id:"deleted"}},t["default"]=b},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t["default"]={SYNCHRONISING:0,SYNCED:1,LOCAL:2,SERVER:3,CHANGED_LOCALLY:4,CHANGED_SERVER:5,CONFLICT:-1}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},r=function(e){if(null===e||"object"!==("undefined"==typeof e?"undefined":n(e)))return e;var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=objClone(e[r]));return t},i=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"===e?t:3&t|8;return n.toString(16)})},a=function(e,t){for(var n=atob(e.split(",")[1]),r=[],i=0;i<n.length;i++)r.push(n.charCodeAt(i));return new Blob([new Uint8Array(r)],{type:t})},o=function(e){if(!e)return!1;var t=e.toString(),n=/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i;return!!t.match(n)},s=function(e){function t(e){for(var t={},n="Boolean Number String Function Array Date RegExp Object".split(" "),r=0;r<n.length;r++)t["[object "+n[r]+"]"]=n[r].toLowerCase();return null==e?String(e):t[toString.call(e)]||"object"}function r(e){return e&&"object"===("undefined"==typeof e?"undefined":n(e))&&"setInterval"in e}if(!e||"object"!==t(e)||e.nodeType||r(e))return!1;if(e.constructor&&!hasOwn.call(e,"constructor")&&!hasOwn.call(e.constructor.prototype,"isPrototypeOf"))return!1;var i=void 0;for(i in e);return void 0===i||hasOwn.call(e,i)},u=function(e){for(var t in e)return!1;return!0},c=function(e){var t=e,n=new Date,r=0,i=0,a=/\d{2}\/\d{2}\/\d{4}$/,o=/\d{4}-\d{1,2}-\d{1,2}$/,s=/\d{1,2}-\d{1,2}-\d{4}$/,u=[];if("string"==typeof t){if(u=t.split("-"),a.test(t))return t;o.test(t)?t=new Date(window.parseInt(u[0]),window.parseInt(u[1])-1,window.parseInt(u[2])):s.test(t)&&(t=new Date(window.parseInt(u[2]),window.parseInt(u[1])-1,window.parseInt(u[0])))}return n=t||n,r=("0"+n.getDate()).slice(-2),i=("0"+(n.getMonth()+1)).slice(-2),r+"/"+i+"/"+n.getFullYear()};t["default"]={cloneDeep:r,getNewUUID:i,dataURItoBlob:a,isDataURL:o,isPlainObject:s,isEmptyObject:u,formatDate:c}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},a=n(7),o=(r(a),n(2)),s=r(o),u=n(1),c=r(u),l=n(5),d=r(l),f=n(8),h=r(f),v=100,p=100,g=s["default"].Model.extend({constructor:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=e;if("string"==typeof e){var r=e;return void(n={data:r})}this.cid=t.cid||t.id||d["default"].getNewUUID(),this.setParent(t.parent||this.parent),this.attributes={},t.collection&&(this.collection=t.collection),t.parse&&(n=this.parse(n,t)||{}),n=c["default"].defaults({},n,c["default"].result(this,"defaults")),this.set(n,t),this.changed={},t.metadata?this.metadata=t.metadata:this.metadata={created_on:new Date},this.initialize.apply(this,arguments)},save:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return!!this.parent&&this.parent.save(e,t)},destroy:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=void 0,r=new Promise(function(e){n=e});return this.stopListening(),this.trigger("destroy",this,this.collection,t),this.parent&&!t.noSave?!function(){var r=t.success;t.success=function(){n(),r&&r()},e.save(null,t)}():(n(),t.success&&t.success()),r},getURL:function(){return this.get("data")},setParent:function(e){if(e){var t=this;this.parent=e,this.parent.on("destroy",function(){t.destroy({noSave:!0})})}},resize:function(e,t,n){var r=this;g.resize(this.getURL(),this.get("type"),e,t,function(e,t,i){return e?void(n&&n(e)):(r.set("data",i),void(n&&n(null,t,i)))})},addThumbnail:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=this,r=/^data:/i;return r.test(this.getURL())?void g.resize(this.getURL(),this.get("type"),v||t.width,v||t.width,function(t,r,i){n.set("thumbnail",i),e&&e()}):void g.getDataURI(this.getURL(),function(t,r){n.set("thumbnail",r),e&&e()},{width:v||t.width,height:p||t.height})},toJSON:function(){var e={id:this.id,metadata:this.metadata,attributes:this.attributes};return e}});c["default"].extend(g,{getDataURI:function(e,t){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];if("string"==typeof e){var r=function(){var r=e.replace(/.*\.([a-z]+)$/i,"$1");return"jpg"===r&&(r="jpeg"),g.resize(e,r,n.width,n.height,function(e,n,i){t(null,i,r,n.width,n.height)}),{v:void 0}}();if("object"===("undefined"==typeof r?"undefined":i(r)))return r.v}if(!window.FileReader){var a="No File Reader",o=new h["default"](a);return console.error(a),void t(o)}var s=new FileReader;s.onload=function(r){n.width||n.height?g.resize(r.target.result,e.type,n.width,n.height,function(n,r,i){t(null,i,e.type,r.width,r.height)}):!function(){var n=new window.Image;n.onload=function(){var i=e.type.replace(/.*\/([a-z]+)$/i,"$1");t(null,r.target.result,i,n.width,n.height)},n.src=r.target.result}()},s.readAsDataURL(e)},resize:function(e,t,n,r,i){var a=new window.Image;a.onload=function(){var e=a.width,o=a.height,s=n||e,u=r||o,c=null,l=null;l=e>o?e/s:o/u,e/=l,o/=l,c=document.createElement("canvas"),c.width=e,c.height=o,c.getContext("2d").drawImage(a,0,0,e,o),i(null,a,c.toDataURL(t))},a.src=e}}),t["default"]=g},function(e,t){e.exports=n},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function i(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return n(this,i),"string"==typeof e?(this.code=-1,void(this.message=e)):(this.code=e.code||-1,void(this.message=e.message||""))};t["default"]=r},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var i=n(7),a=(r(i),n(2)),o=r(a),s=n(1),u=r(s),c=n(5),l=r(c),d=n(6),f=r(d),h=n(10),v=r(h),p=o["default"].Model.extend({Image:f["default"],constructor:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=this,i=t;this.cid=n.cid||n.id||l["default"].getNewUUID(),this.setSample(n.sample||this.sample),n.Image&&(this.Image=n.Image),this.attributes={},n.collection&&(this.collection=n.collection),n.parse&&(i=this.parse(i,n)||{}),i=u["default"].defaults({},i,u["default"].result(this,"defaults")),this.set(i,n),this.changed={},n.metadata?this.metadata=n.metadata:this.metadata={created_on:new Date},n.images?!function(){var t=[];u["default"].each(n.images,function(n){if(n instanceof e.Image)n.setParent(r),t.push(n);else{var i=u["default"].extend(n,{parent:r});t.push(new e.Image(n.attributes,i))}}),e.images=new v["default"](t,{model:e.Image})}():this.images=new v["default"]([],{model:this.Image}),this.initialize.apply(this,arguments)},save:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return!!this.sample&&this.sample.save(e,t)},destroy:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=void 0,r=new Promise(function(e){n=e});return this.stopListening(),this.trigger("destroy",this,this.collection,t),this.sample&&!t.noSave?!function(){var r=t.success;t.success=function(){n(),r&&r()},e.save(null,t)}():(n(),t.success&&t.success()),r},setSample:function(e){if(e){var t=this;this.sample=e,this.sample.on("destroy",function(){t.destroy({noSave:!0})})}},addImage:function(e){e&&(e.setParent(this),this.images.add(e))},validate:function(e){var t=u["default"].extend({},this.attributes,e),n={};return t.taxon||(n.taxon="can't be blank"),u["default"].isEmpty(n)?null:n},toJSON:function(){var e=void 0,t=this.images;t?e=t.toJSON():(e=[],console.warn("toJSON images missing"));var n={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,images:e};return n},flatten:function(e,t){return e.apply(this,[this.attributes,{keys:p.keys,count:t}])}});p.keys={taxon:{id:""},comment:{id:"comment"}},t["default"]=p},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var i=n(2),a=r(i),o=n(1),s=r(o),u=a["default"].Collection.extend({flatten:function(e){for(var t={},n=0;n<this.length;n++)s["default"].extend(t,this.models[n].flatten(e,n));return t},comparator:function(e){return e.metadata.created_on}});t["default"]=u},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=n(1),u=r(s),c=n(2),l=r(c),d=n(8),f=r(d),h=n(3),v=r(h),p=n(10),g=r(p),y=n(12),m=r(y),b=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];i(this,e);var n=this;this.Sample=t.Sample||v["default"],this.manager=t.manager,this.Storage=t.Storage||m["default"],this.storage=new this.Storage({appname:t.appname}),this.cache={},this.initialized=!1,this.storage.getAll(function(e,t){t||(t={});for(var r=[],i=null,a=Object.keys(t),o=0;o<a.length;o++){var s=t[a[o]],c=u["default"].extend(s,{manager:n.manager});i=new n.Sample(s.attributes,c),r.push(i)}n.cache=new g["default"](r,{model:n.Sample}),n._attachListeners(),n.initialized=!0,n.trigger("init")})}return o(e,[{key:"get",value:function(e,t){var n=this,r=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],i=this;if(!this.initialized)return void this.on("init",function(){n.get(e,t,r)});var o="object"===("undefined"==typeof e?"undefined":a(e))?e.id||e.cid:e;return r.nonCached?void this.storage.get(o,function(e,n){if(e)return void t(e);var r=u["default"].extend(n,{manager:i.manager}),a=new i.Sample(n.attributes,r);t(null,a)}):void t(null,this.cache.get(o))}},{key:"getAll",value:function(e){var t=this;return this.initialized?void e(null,this.cache):void this.on("init",function(){t.getAll(e)})}},{key:"set",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=arguments[1];if(!t.id&&!t.cid){var r=new f["default"]("Invalid model passed to storage");return void n(r)}if(!this.initialized)return void this.on("init",function(){e.set(t,n)});var i=this,a=t.id||t.cid;this.storage.set(a,t,function(e){return e?void(n&&n(e)):(i.cache.set(t,{remove:!1}),void(n&&n(null,t)))})}},{key:"remove",value:function(e,t){var n=this;if(!this.initialized)return void this.on("init",function(){n.remove(e,t)});var r="object"===("undefined"==typeof e?"undefined":a(e))?e.id||e.cid:e;this.storage.remove(r,function(n){return n?void(t&&t(n)):(delete e.manager,void e.destroy().then(t))})}},{key:"has",value:function(e,t){var n=this;return this.initialized?void this.get(e,function(e,n){var r="object"===("undefined"==typeof n?"undefined":a(n));t(null,r)}):void this.on("init",function(){n.has(e,t)},this)}},{key:"clear",value:function(e){var t=this;if(!this.initialized)return void this.on("init",function(){t.clear(e)});var n=this;this.storage.clear(function(t){return t?void(e&&e(t)):(n.cache.reset(),void(e&&e()))})}},{key:"size",value:function(e){this.storage.size(e)}},{key:"_attachListeners",value:function(){var e=this;this.cache.on("update",function(){e.trigger("update")})}}]),e}();u["default"].extend(b.prototype,l["default"].Events),t["default"]=b},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(8),s=r(o),u=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];i(this,e),this.TYPE="LocalStorage",this.NAME="morel",this.storage=window.localStorage,this.NAME=t.appname?this.NAME+"-"+t.appname:this.NAME}return a(e,[{key:"get",value:function(e,t){var n=this.storage.getItem(this._getKey(e));n=JSON.parse(n),t(null,n)}},{key:"getAll",value:function(e){for(var t={},n="",r=0,i=this.storage.length;r<i;++r)if(n=this.storage.key(r),n.indexOf(this._getPrefix())!==-1){var a=JSON.parse(this.storage.getItem(n));t[n]=a}e(null,t)}},{key:"set",value:function(e,t,n){var r=JSON.stringify(t);try{this.storage.setItem(this._getKey(e),r),n&&n(null,r)}catch(i){var a=this._isQuotaExceeded(i),o=a?"Storage exceed.":i.message;n&&n(new s["default"](o),r)}}},{key:"remove",value:function(e,t){this.storage.removeItem(this._getKey(e)),t&&t()}},{key:"has",value:function(e,t){this.get(e,function(e,n){t(null,void 0!==n&&null!==n)})}},{key:"clear",value:function(e){this.storage.clear(),e&&e()}},{key:"size",value:function(e){e(null,this.storage.length)}},{key:"hasSpace",value:function(e,t){var n=JSON.stringify(this.storage).length,r=5242880-n;r-e>0?t(null,1):t(null,0)}},{key:"_getKey",value:function(e){return this._getPrefix()+e}},{key:"_getPrefix",value:function(){return this.NAME+"-"}},{key:"_isQuotaExceeded",value:function(e){var t=!1;if(e)if(e.code)switch(e.code){case 22:t=!0;break;case 1014:"NS_ERROR_DOM_QUOTA_REACHED"===e.name&&(t=!0)}else e.number===-2147024882&&(t=!0);return t}}]),e}();t["default"]=u},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(8),s=r(o),u=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];i(this,e),this.indexedDB=window._indexedDB||window.indexedDB,this.IDBKeyRange=window._IDBKeyRange||window.IDBKeyRange,this.VERSION=1,this.TYPE="DatabaseStorage",this.NAME="morel",this.STORE_NAME="samples",this.NAME=t.appname?this.NAME+"-"+t.appname:this.NAME}return a(e,[{key:"set",value:function(e,t,n){this.open(function(r,i){if(r)return void(n&&n(r));try{!function(){var r="function"==typeof t.toJSON?t.toJSON():t,a=i.put(r,e);a.onsuccess=function(){n&&n(null,r)},a.onerror=function(e){console.error("Database error."),console.error(e.target.error);var t=new s["default"](e.target.error);n&&n(t)}}()}catch(r){n&&n(r)}})}},{key:"get",value:function(e,t){this.open(function(n,r){if(n)return void t(n);try{var i=r.index("id").get(e);i.onsuccess=function(e){var n=e.target.result;t(null,n)},i.onerror=function(e){console.error("Database error."),console.error(e.target.error);var n=new s["default"](e.target.error);t(n)}}catch(n){t&&t(n)}})}},{key:"remove",value:function(e,t){var n=this;this.open(function(r,i){if(r)return void(t&&t(r));try{!function(){var r=i.openCursor(n.IDBKeyRange.only(e));r.onsuccess=function(){try{var e=r.result;e?(i["delete"](e.primaryKey),e["continue"]()):t&&t()}catch(n){t&&t(n)}},r.onerror=function(e){console.error("Database error."),console.error(e.target.error);var n=new s["default"](e.target.error);t&&t(n)}}()}catch(r){t&&t(r)}})}},{key:"getAll",value:function(e){var t=this;this.open(function(n,r){if(n)return void e(n);try{!function(){var n=t.IDBKeyRange.lowerBound(0),i=r.openCursor(n),a={};i.onsuccess=function(t){try{var n=t.target.result;n?(a[n.key]=n.value,n["continue"]()):e(null,a)}catch(r){e&&e(r)}},i.onerror=function(t){console.error("Database error."),console.error(t.target.error);var n=new s["default"](t.target.error);e(n)}}()}catch(n){e&&e(n)}})}},{key:"has",value:function(e,t){this.get(e,function(e,n){return e?void t(e):void t(null,void 0!==n&&null!==n)})}},{key:"clear",value:function(e){this.open(function(t,n){if(t)return void(e&&e(t));try{var r=n.clear();r.onsuccess=function(){e&&e()},r.onerror=function(t){console.error("Database error."),console.error(t.target.error);var n=new s["default"](t.target.error);e&&e(n)}}catch(t){e&&e(t)}})}},{key:"size",value:function(e){this.getAll(function(t,n){if(t)return void e(t);var r=Object.keys(n).length;e(null,r)})}},{key:"open",value:function(e){var t=this,n=null;try{n=this.indexedDB.open(this.NAME,this.VERSION),n.onsuccess=function(n){try{var r=n.target.result,i=r.transaction([t.STORE_NAME],"readwrite");if(i){var a=i.objectStore(t.STORE_NAME);if(a)e(null,a);else{var o=new s["default"]("Database Problem: no such store");e(o)}}}catch(o){e(o)}},n.onupgradeneeded=function(n){try{var r=n.target.result;r.createObjectStore(t.STORE_NAME)}catch(i){e&&e(i)}},n.onerror=function(t){console.error("Database error."),console.error(t.target.error);var n=new s["default"](t.target.error);e(n)},n.onblocked=function(t){console.error("Database error."),console.error(t.target.error);var n=new s["default"](t.target.error);e(n)}}catch(r){e(r)}}}]),e}();t["default"]=u}])});