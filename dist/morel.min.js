/*!
 * 
 * morel 3.2.0
 * Mobile Recording Library for biological data collection.
 * https://github.com/NERC-CEH/morel
 * Author Karolis Kazlauskis
 * Released under the GNU GPL v3 license.
 * http://www.gnu.org/licenses/gpl.html
 * 
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("underscore"),require("backbone"),require("localforage")):"function"==typeof define&&define.amd?define("Morel",["_","Backbone","localforage"],t):"object"==typeof exports?exports.Morel=t(require("underscore"),require("backbone"),require("localforage")):e.Morel=t(e._,e.Backbone,e.localforage)}(this,function(e,t,n){return function(e){function t(r){if(n[r])return n[r].exports;var a=n[r]={exports:{},id:r,loaded:!1};return e[r].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function a(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=n(1),c=a(u),d=n(2),l=a(d),f=n(3),h=a(f),v=n(8),p=a(v),m=n(10),y=a(m),g=n(6),b=a(g),w=n(7),_=a(w),S=n(4),x=r(S),O=n(5),P=a(O),k=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e),this.options=t,t.manager=this,this.storage=new y.default(t),this.onSend=t.onSend,this.user=t.user,this.password=t.password,this._attachListeners(),this.synchronising=!1}return s(e,[{key:"get",value:function(e,t){return this.storage.get(e,t)}},{key:"getAll",value:function(e){return this.storage.getAll(e)}},{key:"set",value:function(e,t){return e instanceof h.default&&(e.manager=this),this.storage.set(e,t)}},{key:"remove",value:function(e,t){return this.storage.remove(e,t)}},{key:"has",value:function(e,t){return this.storage.has(e,t)}},{key:"clear",value:function(e){return this.storage.clear(e)}},{key:"syncAll",value:function(e,t){function n(e){var t=[];return e.each(function(e){var n=e.save({remote:!0,timeout:r.timeout}),a=void 0;a=n?new Promise(function(e){n.then(e,e)}):Promise.resolve(),t.push(a)}),Promise.all(t)}var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return t?n(t):this.getAll().then(n)}},{key:"sync",value:function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(n.getSyncStatus()===x.SYNCED||n.getSyncStatus()===x.SYNCHRONISING)return!1;var a=new Promise(function(t,a){r.host=n.manager.options.host,e.prototype.post.apply(n.manager,[n,r]).then(function(e){e.save().then(function(){e.trigger("sync"),t(e)})}).catch(a)});return a}},{key:"post",value:function(e,t){var n=this,r=e.onSend||this.onSend,a=r&&r(e);return!a&&(e.synchronising=!0,n._getModelFormData(e).then(function(r){return n._ajaxModel(r,e,t)}))}},{key:"_ajaxModel",value:function(e,t,n){var r=this,a=new Promise(function(a,i){function s(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t={};return e.forEach(function(e){t[e.external_key]=e.id,e.occurrences&&c.default.extend(t,s(e.occurrences))}),t}function u(e,t){e.id=t[e.cid],e.occurrences&&e.occurrences.each(function(e){u(e,t)})}var d=x.API_BASE+x.API_VER+x.API_SAMPLES_PATH,f=n.xhr=l.default.ajax({url:n.host+d,type:"POST",data:e,headers:{Authorization:"Basic  "+r.getUserAuth()},processData:!1,contentType:!1,timeout:n.timeout||3e4});f.done(function(e){t.synchronising=!1;var n={};n[e.data.external_key]=e.data.id,c.default.extend(n,s(e.data.subModels)),u(t,n);var r=new Date;t.metadata.server_on=r,t.metadata.updated_on=r,t.metadata.synced_on=r,t.save().then(a)}),f.fail(function(e,n,r){if(t.synchronising=!1,"Conflict"===r){var s=function(){var n={};e.responseJSON.errors.forEach(function(e){n[t.cid]=e.sample_id,n[e.external_key]=e.id}),u(t,n);var r=new Date;return t.metadata.server_on=r,t.metadata.updated_on=r,t.metadata.synced_on=r,t.save().then(a),{v:void 0}}();if("object"===("undefined"==typeof s?"undefined":o(s)))return s.v}t.trigger("error");var c=new _.default({code:e.status,message:r});i(c)}),t.trigger("request",t,f,n)});return a}},{key:"_attachListeners",value:function(){var e=this;this.storage.on("update",function(){e.trigger("update")})}},{key:"_getModelFormData",value:function(e){var t=this,n=new Promise(function(n){var r=e.flatten(t._flattener),a=new FormData,i=0,o=[];e.occurrences.each(function(e){var t=i,n=0,r=[];e.media.each(function(e){var i=new Promise(function(r){function i(e,i,o,u){var c="sc:"+t+"::photo"+n,d=s,l=s;s.match(/image.*/)?d=s.split("/")[1]:l="image/"+l,u||(u=P.default.dataURItoBlob(o,l)),a.append(c,u,"pic."+d),n++,r()}var o=e.getURL(),s=e.get("type");P.default.isDataURL(o)?i(null,null,o):!function(){var e=new XMLHttpRequest;e.open("GET",o,!0),e.responseType="blob",e.onload=function(){i(null,null,null,e.response)},e.send()}()});r.push(i)}),o.push(Promise.all(r)),i++}),Promise.all(o).then(function(){for(var e=Object.keys(r),i=0;i<e.length;i++)a.append(e[i],r[e[i]]);a=t.appendAuth(a),n(a)})});return n}},{key:"_flattener",value:function(t,n){var r=n.flattened||{},a=n.keys||{},i=n.count,o=null,s=null,u=null,d="",l="sample:",f="smpAttr:";this instanceof p.default&&(d="sc:",l="::occurrence:",f="::occAttr:");var h=this.cid;h&&(this instanceof p.default?r[d+i+l+"external_key"]=h:r[l+"external_key"]=this.cid);for(o in t)if(a[o]){if(s=a[o].id,s?(s=parseInt(s,10)>=0?f+s:l+s,d&&(s=d+i+s)):s=d+i+"::present",t[o]){if(u=t[o],a[o].values)if("function"==typeof a[o].values){var v=c.default.extend(n,{flattener:e.prototype._flattener,flattened:r});u=a[o].values(u,v)}else u=a[o].values[u];u&&(r[s]=u)}}else"email"!==o&&"usersecret"!==o&&console.warn("Morel: no such key: "+o),r[o]=t[o];return r}},{key:"appendAuth",value:function(e){return this._appendAppAuth(e),this._appendWarehouseAuth(e),e}},{key:"getUserAuth",value:function(){var e="function"==typeof this.options.user?this.options.user():this.options.user,t="function"==typeof this.options.password?this.options.password():this.options.password;if(!e||!t)throw new _.default("User or password must be specified for basic authentication.");return btoa(e+":"+t)}},{key:"_appendAppAuth",value:function(e){return e.append("api_key",this.options.api_key),e}},{key:"_appendWarehouseAuth",value:function(e){return e.append("website_id",this.options.website_id),e.append("survey_id",this.options.survey_id),e}}]),e}();c.default.extend(k.prototype,l.default.Events),c.default.extend(k,x,{VERSION:"3.2.0",Sample:h.default,Occurrence:p.default,Media:b.default,Error:_.default}),t.default=k},function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i,o=n(2),s=r(o),u=n(1),c=r(u),d=n(4),l=n(5),f=r(l),h=n(6),v=r(h),p=n(8),m=r(p),y=n(9),g=r(y),b=s.default.Model.extend((i={Media:v.default,Occurrence:m.default,constructor:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this,a=t,i={date:new Date,location_type:"latlon"};if(a=c.default.extend(i,a),this.id=n.id,this.cid=n.cid||f.default.getNewUUID(),this.setParent(n.parent||this.parent),this.manager=n.manager||this.manager,this.manager&&(this.sync=this.manager.sync),n.Media&&(this.Media=n.Media),n.Occurrence&&(this.Occurrence=n.Occurrence),n.onSend&&(this.onSend=n.onSend),this.attributes={},n.collection&&(this.collection=n.collection),n.parse&&(a=this.parse(a,n)||{}),a=c.default.defaults({},a,c.default.result(this,"defaults")),this.set(a,n),this.changed={},n.metadata)this.metadata=n.metadata;else{var o=new Date;this.metadata={created_on:o,updated_on:o,synced_on:null,server_on:null}}n.occurrences?!function(){var t=[];c.default.each(n.occurrences,function(e){if(e instanceof r.Occurrence)e.setParent(r),t.push(e);else{var n=c.default.extend(e,{parent:r}),a=new r.Occurrence(e.attributes,n);t.push(a)}}),e.occurrences=new g.default(t,{model:e.Occurrence})}():this.occurrences=new g.default([],{model:this.Occurrence}),n.samples?!function(){var t=[];c.default.each(n.samples,function(e){if(e instanceof b)e.setParent(r),t.push(e);else{var n=c.default.extend(e,{parent:r}),a=new b(e.attributes,n);t.push(a)}}),e.samples=new g.default(t,{model:b})}():this.samples=new g.default([],{model:b}),n.media?!function(){var t=[];c.default.each(n.media,function(n){if(n instanceof e.Media)n.setParent(r),t.push(n);else{var a=c.default.extend(n,{parent:r});t.push(new e.Media(n.attributes,a))}}),e.media=new g.default(t,{model:e.Media})}():this.media=new g.default([],{model:this.Media}),this.initialize.apply(this,arguments)},save:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.parent?this.parent.save(e):!!this.manager&&(e.remote?!this.validate()&&s.default.Model.prototype.save.apply(this,[null,e]):this.manager.set(this))},destroy:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=new Promise(function(n,r){e.manager&&!t.noSave?e.manager.remove(e).then(n,r):(e.stopListening(),e.trigger("destroy",e,e.collection,t),e.parent&&!t.noSave?e.save(t).then(n):n())});return n},setParent:function(e){if(e){var t=this;this.parent=e,this.parent.on("destroy",function(){t.destroy({noSave:!0})})}},addOccurrence:function(e){e&&(e.setParent(this),this.samples.push(e))}},a(i,"addOccurrence",function(e){e&&(e.setParent(this),this.occurrences.push(e))}),a(i,"addMedia",function(e){e&&(e.setParent(this),this.media.add(e))}),a(i,"validate",function(e){var t=c.default.extend({},this.attributes,e),n={},r={},a={},i={};if(t.location||(n.location="can't be blank"),t.location_type||(n.location_type="can't be blank"),t.date){var o=new Date(t.date);("Invalid Date"===o||o>new Date)&&(n.date=new Date(o)>new Date?"future date":"invalid")}else n.date="can't be blank";if(this.samples.length||this.occurrences.length||(n.occurrences="no occurrences"),this.samples.length&&this.samples.each(function(e){var t=e.validate();if(t){var n=e.cid;r[n]=t}}),this.occurrences.length&&this.occurrences.each(function(e){var t=e.validate();if(t){var n=e.cid;a[n]=t}}),!c.default.isEmpty(n)||!c.default.isEmpty(a)){var s={sample:n,samples:r,occurrences:a,media:i};return s}return null}),a(i,"flatten",function(e){var t=e.apply(this,[this.attributes,{keys:b.keys}]);return c.default.extend(t,this.occurrences.flatten(e)),t}),a(i,"toJSON",function(){var e=void 0;this.occurrences?e=this.occurrences.toJSON():(e=[],console.warn("toJSON occurrences missing"));var t=void 0;this.samples?t=this.samples.toJSON():(t=[],console.warn("toJSON samples missing"));var n=void 0;this.media?n=this.media.toJSON():(n=[],console.warn("toJSON media missing"));var r={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,occurrences:e,samples:t,media:n};return r}),a(i,"getSyncStatus",function(){var e=this.metadata;return this.synchronising?d.SYNCHRONISING:this.id>=0?e.synced_on?e.synced_on<e.updated_on?e.synced_on<e.server_on?d.CONFLICT:d.CHANGED_LOCALLY:e.synced_on<e.server_on?d.CHANGED_SERVER:d.SYNCED:d.SERVER:d.LOCAL}),a(i,"getOccurrence",function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.occurrences.at(e)}),a(i,"getSample",function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.samples.at(e)}),i));b.keys={id:{id:"id"},survey:{id:"survey_id"},date:{id:"date"},comment:{id:"comment"},media:{id:"media"},location:{id:"entered_sref"},location_type:{id:"entered_sref_system",values:{british:"OSGB",irish:"OSIE",latlon:4326}},location_name:{id:"location_name"},form:{id:"input_form"},group:{id:"group_id"},deleted:{id:"deleted"}},t.default=b},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.API_BASE="api/",t.API_VER="v0.1",t.API_SAMPLES_PATH="/samples",t.SYNCHRONISING=0,t.SYNCED=1,t.LOCAL=2,t.SERVER=3,t.CHANGED_LOCALLY=4,t.CHANGED_SERVER=5,t.CONFLICT=-1},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(e){if(null===e||"object"!==("undefined"==typeof e?"undefined":n(e)))return e;var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=objClone(e[r]));return t},a=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"===e?t:3&t|8;return n.toString(16)})},i=function(e,t){for(var n=atob(e.split(",")[1]),r=[],a=0;a<n.length;a++)r.push(n.charCodeAt(a));return new Blob([new Uint8Array(r)],{type:t})},o=function(e){if(!e)return!1;var t=e.toString(),n=/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i;return!!t.match(n)},s=function(e){function t(e){for(var t={},n="Boolean Number String Function Array Date RegExp Object".split(" "),r=0;r<n.length;r++)t["[object "+n[r]+"]"]=n[r].toLowerCase();return null==e?String(e):t[toString.call(e)]||"object"}function r(e){return e&&"object"===("undefined"==typeof e?"undefined":n(e))&&"setInterval"in e}if(!e||"object"!==t(e)||e.nodeType||r(e))return!1;if(e.constructor&&!hasOwn.call(e,"constructor")&&!hasOwn.call(e.constructor.prototype,"isPrototypeOf"))return!1;var a=void 0;for(a in e);return void 0===a||hasOwn.call(e,a)},u=function(e){for(var t in e)return!1;return!0},c=function(e){var t=e,n=new Date,r=0,a=0,i=/\d{2}\/\d{2}\/\d{4}$/,o=/\d{4}-\d{1,2}-\d{1,2}$/,s=/\d{1,2}-\d{1,2}-\d{4}$/,u=[];if("string"==typeof t){if(u=t.split("-"),i.test(t))return t;o.test(t)?t=new Date(window.parseInt(u[0]),window.parseInt(u[1])-1,window.parseInt(u[2])):s.test(t)&&(t=new Date(window.parseInt(u[2]),window.parseInt(u[1])-1,window.parseInt(u[0])))}return n=t||n,r=("0"+n.getDate()).slice(-2),a=("0"+(n.getMonth()+1)).slice(-2),r+"/"+a+"/"+n.getFullYear()};t.default={cloneDeep:r,getNewUUID:a,dataURItoBlob:i,isDataURL:o,isPlainObject:s,isEmptyObject:u,formatDate:c}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(){function e(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(a)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=n(2),s=r(o),u=n(1),c=r(u),d=n(5),l=r(d),f=n(7),h=r(f),v=100,p=100,m=s.default.Model.extend({constructor:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e;if("string"==typeof e){var r=e;return void(n={data:r})}this.id=t.id,this.cid=t.cid||l.default.getNewUUID(),this.setParent(t.parent||this.parent),this.attributes={},t.collection&&(this.collection=t.collection),t.parse&&(n=this.parse(n,t)||{}),n=c.default.defaults({},n,c.default.result(this,"defaults")),this.set(n,t),this.changed={},t.metadata?this.metadata=t.metadata:this.metadata={created_on:new Date},this.initialize.apply(this,arguments)},save:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return!!this.parent&&this.parent.save(e)},destroy:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=new Promise(function(n){return e.stopListening(),e.trigger("destroy",e,e.collection,t),e.parent&&!t.noSave?void e.save(t).then(n):void n()});return n},getURL:function(){return this.get("data")},setParent:function(e){if(e){var t=this;this.parent=e,this.parent.on("destroy",function(){t.destroy({noSave:!0})})}},resize:function(e,t){var n=this,r=this,a=new Promise(function(a,o){m.resize(n.getURL(),n.get("type"),e,t).then(function(e){var t=i(e,2),n=t[0],o=t[1];r.set("data",o),a([n,o])}).catch(o)});return a},addThumbnail:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=this,r=new Promise(function(r,a){var o=/^data:/i;return o.test(e.getURL())?void m.resize(e.getURL(),e.get("type"),v||t.width,v||t.width).then(function(e){var t=i(e,2),a=(t[0],t[1]);n.set("thumbnail",a),r()}).catch(a):void m.getDataURI(e.getURL(),{width:v||t.width,height:p||t.height}).then(function(e){n.set("thumbnail",e),r()}).catch(a)});return r},toJSON:function(){var e={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes};return e}});c.default.extend(m,{getDataURI:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=new Promise(function(n,r){if("string"==typeof e){var o=function(){var r=e.replace(/.*\.([a-z]+)$/i,"$1");return"jpg"===r&&(r="jpeg"),m.resize(e,r,t.width,t.height).then(function(e){var t=i(e,2),a=t[0],o=t[1];n([o,r,a.width,a.height])}),{v:void 0}}();if("object"===("undefined"==typeof o?"undefined":a(o)))return o.v}if(!window.FileReader){var s="No File Reader",u=new h.default(s);return console.error(s),void r(u)}var c=new FileReader;c.onload=function(r){t.width||t.height?m.resize(r.target.result,e.type,t.width,t.height).then(function(t){var r=i(t,2),a=r[0],o=r[1];n([o,e.type,a.width,a.height])}):!function(){var t=new window.Image;t.onload=function(){var a=e.type.replace(/.*\/([a-z]+)$/i,"$1");n([r.target.result,a,t.width,t.height])},t.src=r.target.result}()},c.readAsDataURL(e)});return n},resize:function(e,t,n,r){var a=new Promise(function(a,i){var o=new window.Image;o.onload=function(){var e=o.width,i=o.height,s=n||e,u=r||i,c=null,d=null;d=e>i?e/s:i/u,e/=d,i/=d,c=document.createElement("canvas"),c.width=e,c.height=i,c.getContext("2d").drawImage(o,0,0,e,i),a([o,c.toDataURL(t)])},o.src=e});return a}}),t.default=m},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return n(this,e),"string"==typeof t?(this.code=-1,void(this.message=t)):t instanceof Array?void(this.message=t.reduce(function(e,t){return""+e+t.title+"\n"},"")):(this.code=t.code||-1,void(this.message=t.message||""))};t.default=r},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=n(2),i=r(a),o=n(1),s=r(o),u=n(5),c=r(u),d=n(6),l=r(d),f=n(9),h=r(f),v=i.default.Model.extend({Media:l.default,constructor:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this,a=t;this.id=n.id,this.cid=n.cid||c.default.getNewUUID(),this.setParent(n.parent||this.parent),n.Media&&(this.Media=n.Media),this.attributes={},n.collection&&(this.collection=n.collection),n.parse&&(a=this.parse(a,n)||{}),a=s.default.defaults({},a,s.default.result(this,"defaults")),this.set(a,n),this.changed={},n.metadata?this.metadata=n.metadata:this.metadata={created_on:new Date},n.media?!function(){var t=[];s.default.each(n.media,function(n){if(n instanceof e.Media)n.setParent(r),t.push(n);else{var a=s.default.extend(n,{parent:r});t.push(new e.Media(n.attributes,a))}}),e.media=new h.default(t,{model:e.Media})}():this.media=new h.default([],{model:this.Media}),this.initialize.apply(this,arguments)},save:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return!!this.parent&&this.parent.save(e)},destroy:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=new Promise(function(n){e.stopListening(),e.trigger("destroy",e,e.collection,t),e.parent&&!t.noSave?e.save(t).then(n):n()});return n},setParent:function(e){if(e){var t=this;this.parent=e,this.parent.on("destroy",function(){t.destroy({noSave:!0})})}},addMedia:function(e){e&&(e.setParent(this),this.media.add(e))},validate:function(e){var t=s.default.extend({},this.attributes,e),n={};return t.taxon||(n.taxon="can't be blank"),s.default.isEmpty(n)?null:n},toJSON:function(){var e=void 0;this.media?e=this.media.toJSON():(e=[],console.warn("toJSON media missing"));var t={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,media:e};return t},flatten:function(e,t){return e.apply(this,[this.attributes,{keys:v.keys,count:t}])}});v.keys={taxon:{id:""},comment:{id:"comment"}},t.default=v},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=n(2),i=r(a),o=n(1),s=r(o),u=i.default.Collection.extend({flatten:function(e){for(var t={},n=0;n<this.length;n++)s.default.extend(t,this.models[n].flatten(e,n));return t},comparator:function(e){return e.metadata.created_on}});t.default=u},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=n(1),u=r(s),c=n(2),d=r(c),l=n(11),f=r(l),h=n(7),v=r(h),p=n(3),m=r(p),y=n(9),g=r(y),b=function(){function e(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};a(this,e);var r=this;this._initialized=!1,this.Sample=n.Sample||m.default,this.manager=n.manager;var o=n.storage||{};this.db=null;var s=new Promise(function(t,n){var a=new Promise(function(e){o.driverOrder&&"object"===i(o.driverOrder[0])?f.default.defineDriver(o.driverOrder[0]).then(e):e()});a.then(function(){var a={name:o.name||"morel",storeName:o.storeName||"samples"};o.version&&(a.version=o.version);var i=o.driverOrder||["indexeddb","websql","localstorage"],s=e._getDriverOrder(i),u=o.LocalForage||f.default;r.db=u.createInstance(a),r.db.setDriver(s).then(function(){t(r.db)}).catch(n)})});this._cache={},s.then(function(){var e=[];t.db.iterate(function(t){var n=u.default.extend(t,{manager:r.manager}),a=new r.Sample(t.attributes,n);e.push(a)}).then(function(){r._cache=new g.default(e,{model:r.Sample}),r._attachListeners(),r._initialized=!0,r.trigger("init")})})}return o(e,[{key:"ready",value:function(){return this._initialized}},{key:"get",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this,a=new Promise(function(a,o){if(!t.ready())return void t.on("init",function(){t.get(e,n).then(a,o)});var s="object"===("undefined"==typeof e?"undefined":i(e))?e.cid:e;if(n.nonCached)return void t.db.getItem(s).then(function(e){var t=u.default.extend(e,{manager:r.manager}),n=new r.Sample(e.attributes,t);a(n)}).catch(o);var c=t._cache.get(s);a(c)});return a}},{key:"getAll",value:function(){var e=this,t=new Promise(function(t,n){return e.ready()?void t(e._cache):void e.on("init",function(){e.getAll().then(t,n)})});return t}},{key:"set",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=new Promise(function(n,r){if(!t.cid){var a=new v.default("Invalid model passed to storage");return void r(a)}if(!e.ready())return void e.on("init",function(){e.set(t).then(n,r)});var i=e,o=t.cid,s="function"==typeof t.toJSON?t.toJSON():t;e.db.setItem(o,s).then(function(){if(t instanceof i.Sample)i._cache.set(t,{remove:!1});else{var e=u.default.extend(t,{manager:i.manager}),r=new i.Sample(t.attributes,e);i._cache.set(r,{remove:!1})}n(t)}).catch(r)});return n}},{key:"remove",value:function(e){var t=this,n=new Promise(function(n,r){if(!t.ready())return void t.on("init",function(){t.remove(e).then(n,r)});var a="object"===("undefined"==typeof e?"undefined":i(e))?e.cid:e;t.db.removeItem(a).then(function(){return delete e.manager,e.destroy().then(n)}).catch(r)});return n}},{key:"has",value:function(e){var t=this,n=new Promise(function(n,r){return t.ready()?void t.get(e).then(function(e){var t="object"===("undefined"==typeof e?"undefined":i(e));n(t)}):void t.on("init",function(){t.has(e).then(n,r)},t)});return n}},{key:"clear",value:function(){var e=this,t=new Promise(function(t,n){if(!e.ready())return void e.on("init",function(){e.clear().then(t,n)});var r=e;e.db.clear().then(function(){r._cache.reset(),t()}).catch(n)});return t}},{key:"size",value:function(){var e=this,t=new Promise(function(t,n){e.db.length().then(t,n)});return t}},{key:"_attachListeners",value:function(){var e=this;this._cache.on("update",function(){e.trigger("update")})}}],[{key:"_getDriverOrder",value:function(e){return e.map(function(e){switch(e){case"indexeddb":return f.default.INDEXEDDB;case"websql":return f.default.WEBSQL;case"localstorage":return f.default.LOCALSTORAGE;default:return"object"===("undefined"==typeof e?"undefined":i(e))&&e._driver?e._driver:console.error("No such db driver!")}})}}]),e}();u.default.extend(b.prototype,d.default.Events),t.default=b},function(e,t){e.exports=n}])});