/*!
 * morel 3.0.2
 * Mobile Recording Library for biological data collection. 
 *
 * https://github.com/NERC-CEH/morel
 *
 * Author 2016 Karolis Kazlauskis
 * Released under the GNU GPL v3 license.
 * http://www.gnu.org/licenses/gpl.html
 */
!function(a){var b="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global;if("function"==typeof define&&define.amd)define(["jquery","backbone","exports"],function(c,d,e){b.morel=a(b,e,c,d)});else if("undefined"!=typeof exports){try{$=require("jquery")}catch(c){}try{Backbone=require("backbone")}catch(c){}a(b,exports,$,Backbone)}else b.morel=a(b,{},b.jQuery||b.Zepto||b.ender||b.$,b.Backbone)}(function(a,b,c,d){"use strict";return b.VERSION="3.0.2",b.SYNCHRONISING=0,b.SYNCED=1,b.LOCAL=2,b.SERVER=3,b.CHANGED_LOCALLY=4,b.CHANGED_SERVER=5,b.CONFLICT=-1,b.cloneDeep=function(a){if(null===a||"object"!=typeof a)return a;var c={};for(var d in a)a.hasOwnProperty(d)&&(c[d]=b.objClone(a[d]));return c},b.getNewUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},b.dataURItoBlob=function(a,b){for(var c=atob(a.split(",")[1]),d=[],e=0;e<c.length;e++)d.push(c.charCodeAt(e));return new Blob([new Uint8Array(d)],{type:b})},b.isDataURL=function(a){if(!a)return!1;a=a.toString();var b=/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i;return!!a.match(b)},b.isPlainObject=function(a){function b(a){for(var b={},c="Boolean Number String Function Array Date RegExp Object".split(" "),d=0;d<c.length;d++)b["[object "+c[d]+"]"]=c[d].toLowerCase();return null==a?String(a):b[toString.call(a)]||"object"}function c(a){return a&&"object"==typeof a&&"setInterval"in a}if(!a||"object"!==b(a)||a.nodeType||c(a))return!1;if(a.constructor&&!hasOwn.call(a,"constructor")&&!hasOwn.call(a.constructor.prototype,"isPrototypeOf"))return!1;var d;for(d in a);return void 0===d||hasOwn.call(a,d)},b.isEmptyObject=function(a){for(var b in a)return!1;return!0},b.formatDate=function(a){var b=new Date,c=0,d=0,e=/\d{2}\/\d{2}\/\d{4}$/,f=/\d{4}-\d{1,2}-\d{1,2}$/,g=/\d{1,2}-\d{1,2}-\d{4}$/,h=[];if("string"==typeof a){if(h=a.split("-"),e.test(a))return a;f.test(a)?a=new Date(parseInt(h[0]),parseInt(h[1])-1,parseInt(h[2])):g.test(a)&&(a=new Date(parseInt(h[2]),parseInt(h[1])-1,parseInt(h[0])))}return b=a||b,c=("0"+b.getDate()).slice(-2),d=("0"+(b.getMonth()+1)).slice(-2),c+"/"+d+"/"+b.getFullYear()},b.Image=function(){var a=d.Model.extend({constructor:function(a,c){if("string"==typeof a){var d=a;return void(a={data:d})}var e=a||{};c||(c={}),this.cid=c.cid||b.getNewUUID(),this._occurrence=c._occurrence,this.attributes={},c.collection&&(this.collection=c.collection),c.parse&&(e=this.parse(e,c)||{}),e=_.defaults({},e,_.result(this,"defaults")),this.set(e,c),this.changed={},c.metadata?this.metadata=c.metadata:this.metadata={created_on:new Date},this.initialize.apply(this,arguments)},save:function(a){return this._occurrence?void this._occurrence.save(a):void(a&&a(new Error({message:"No occurrence."})))},destroy:function(a){this._occurrence?(this._occurrence.images.remove(this),this.save(function(){a&&a()})):d.Model.prototype.destroy.call(this)},resize:function(b,c,d){var e=this;a.resize(this.attributes.data,this.attributes.type,b,c,function(a,b,c){return a?void(d&&d(a)):(e.attributes.data=c,void(d&&d(null,b,c)))})},toJSON:function(){var a={id:this.id,metadata:this.metadata,attributes:this.attributes};return a}});return _.extend(a,{toString:function(a,c){if(!window.FileReader){var d="No File Reader",e=new b.Error(d);return console.error(d),c(e)}var f=new FileReader;f.onload=function(b){c(null,b.target.result,a.type)},f.readAsDataURL(a)},resize:function(a,b,c,d,e){var f=new Image;f.onload=function(){var a=f.width,g=f.height,h=null,i=null;i=a>g?a/c:g/d,a/=i,g/=i,h=document.createElement("canvas"),h.width=a,h.height=g,h.getContext("2d").drawImage(f,0,0,a,g),e(null,f,h.toDataURL(b))},f.src=a}}),a}(),b.Collection=function(){var a=d.Collection.extend({flatten:function(a){for(var b={},c=0;c<this.length;c++)_.extend(b,this.models[c].flatten(a,c));return b},comparator:function(a){return a.metadata.created_on}});return a}(),b.Occurrence=function(){var a=d.Model.extend({constructor:function(a,c){var d=this,e=a||{};if(c||(c={}),this.cid=c.cid||b.getNewUUID(),this._sample=c._sample,this.attributes={},c.collection&&(this.collection=c.collection),c.parse&&(e=this.parse(e,c)||{}),e=_.defaults({},e,_.result(this,"defaults")),this.set(e,c),this.changed={},c.metadata?this.metadata=c.metadata:this.metadata={created_on:new Date},c.images){var f=[];_.each(c.images,function(a){if(a instanceof b.Image)a._occurrence=d,f.push(a);else{var c=_.extend(a,{_occurrence:d});f.push(new b.Image(a.attributes,c))}}),this.images=new b.Collection(f,{model:b.Image})}else this.images=new b.Collection([],{model:b.Image});this.initialize.apply(this,arguments)},save:function(a){return this._sample?void this._sample.save(a):void(a&&a(new Error({message:"No sample."})))},destroy:function(a){this._sample?(this._sample.occurrences.remove(this),this.save(function(){a&&a()})):d.Model.prototype.destroy.call(this)},toJSON:function(){var a={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,images:this.images.toJSON()};return a},flatten:function(b,c){return b.apply(this,[this.attributes,{keys:a.keys,count:c}])}});return a.keys={taxon:{id:""},comment:{id:"comment"}},a}(),b.Sample=function(){var a=d.Model.extend({Occurrence:b.Occurrence,constructor:function(a,c){var d=a||{},e=this;if(a||(d={date:new Date,location_type:"latlon"}),c||(c={}),this.cid=c.cid||b.getNewUUID(),this._manager=c._manager,this.attributes={},c.collection&&(this.collection=c.collection),c.parse&&(d=this.parse(d,c)||{}),d=_.defaults({},d,_.result(this,"defaults")),this.set(d,c),this.changed={},c.metadata?this.metadata=c.metadata:this.metadata={created_on:new Date,updated_on:new Date,warehouse_id:null,synced_on:null,server_on:null},c.occurrences){var f=[];_.each(c.occurrences,function(a){if(a instanceof e.Occurrence)a._sample=e,f.push(a);else{var b=_.extend(a,{_sample:e});f.push(new e.Occurrence(a.attributes,b))}}),this.occurrences=new b.Collection(f,{model:this.Occurrence})}else this.occurrences=new b.Collection([],{model:this.Occurrence});this.initialize.apply(this,arguments)},save:function(a){var b=this;return this._manager?void this._manager.set(this,function(){a&&a(null,b)}):void(a&&a(new Error({message:"No manager."})))},destroy:function(a){this._manager?this._manager.remove(this,a):(d.Model.prototype.destroy.call(this),a&&a())},flatten:function(b){var c=b.apply(this,[this.attributes,{keys:a.keys}]);return _.extend(c,this.occurrences.flatten(b)),c},toJSON:function(){var a={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,occurrences:this.occurrences.toJSON()};return a},getSyncStatus:function(){var a=this.metadata;return a.synchronising?b.SYNCHRONISING:a.warehouse_id?a.synced_on?a.synced_on<a.updated_on?a.synced_on<a.server_on?b.CONFLICT:b.CHANGED_LOCALLY:a.synced_on<a.server_on?b.CHANGED_SERVER:b.SYNCED:b.SERVER:b.LOCAL},offAll:function(){this._events={},this.occurrences.offAll();for(var a=0;a<this.occurrences.data.length;a++)this.occurrences.models[a].offAll()}});return a.keys={id:{id:"id"},survey:{id:"survey_id"},date:{id:"date"},comment:{id:"comment"},image:{id:"image"},location:{id:"entered_sref"},location_type:{id:"entered_sref_system",values:{british:"OSGB",irish:"OSIE",latlon:4326}},location_name:{id:"location_name"},deleted:{id:"deleted"}},a}(),b.PlainStorage=function(){var a=function(){this.storage={}};return _.extend(a.prototype,{NAME:"PlainStorage",get:function(a,b){var c=this.storage[a];b(null,c)},getAll:function(a){var b=this.storage;a(null,b)},set:function(a,b,c){this.storage[a]=b,c&&c(null,b)},remove:function(a,b){delete this.storage[a],b&&b()},has:function(a,b){this.get(a,function(a,c){b(null,void 0!==c&&null!==c)})},clear:function(a){this.storage={},a&&a(null,this.storage)},size:function(a){var b=Object.keys(this.storage).length;a(null,b)}}),a}(),b.LocalStorage=function(){var a=function(a){a||(a={}),this.storage=window.localStorage,this.NAME=a.appname?this.NAME+"-"+a.appname:this.NAME};return _.extend(a.prototype,{TYPE:"LocalStorage",NAME:"morel",get:function(a,b){var c=this.storage.getItem(this._getKey(a));c=JSON.parse(c),b(null,c)},getAll:function(a){for(var b={},c="",d=0,e=this.storage.length;e>d;++d)if(c=this.storage.key(d),-1!==c.indexOf(this._getPrefix())){var f=JSON.parse(this.storage.getItem(c));b[c]=f}a(null,b)},set:function(a,c,d){c=JSON.stringify(c);try{this.storage.setItem(this._getKey(a),c),d&&d(null,c)}catch(e){var f=this._isQuotaExceeded(e),g=f?"Storage exceed.":e.message;d&&d(new b.Error(g),c)}},remove:function(a,b){this.storage.removeItem(this._getKey(a)),b&&b()},has:function(a,b){this.get(a,function(a,c){b(null,void 0!==c&&null!==c)})},clear:function(a){this.storage.clear(),a&&a()},size:function(a){a(null,this.storage.length)},hasSpace:function(a,b){var c=JSON.stringify(this.storage).length,d=5242880-c;d-a>0?b(null,1):b(null,0)},_getKey:function(a){return this._getPrefix()+a},_getPrefix:function(){return this.NAME+"-"},_isQuotaExceeded:function(a){var b=!1;if(a)if(a.code)switch(a.code){case 22:b=!0;break;case 1014:"NS_ERROR_DOM_QUOTA_REACHED"===a.name&&(b=!0)}else-2147024882===a.number&&(b=!0);return b}}),a}(),b.Error=function(){var a=function(a){return"string"==typeof a?(this.number=-1,void(this.message=a)):(this.number=a.number||-1,void(this.message=a.message||""))};return a}(),b.DatabaseStorage=function(){var a=function(a){a||(a={}),this.NAME=a.appname?this.NAME+"-"+a.appname:this.NAME};return _.extend(a.prototype,{indexedDB:window._indexedDB||window.indexedDB,IDBKeyRange:window._IDBKeyRange||window.IDBKeyRange,VERSION:1,TYPE:"DatabaseStorage",NAME:"morel",STORE_NAME:"samples",set:function(a,c,d){try{this.open(function(e,f){if(e)return void(d&&d(e));c="function"==typeof c.toJSON?c.toJSON():c;var g=f.put(c,a);g.onsuccess=function(){d&&d(null,c)},g.onerror=function(a){var c="Database Problem: "+a.target.error.message,e=new b.Error(c);console.error(c),d&&d(e)}})}catch(e){d&&d(e)}},get:function(a,c){try{this.open(function(d,e){if(d)return void c(d);var f=e.index("id").get(a);f.onsuccess=function(a){var b=a.target.result;c(null,b)},f.onerror=function(a){var d="Database Problem: "+a.target.error.message,e=new b.Error(d);console.error(d),c(e)}})}catch(d){c(d)}},remove:function(a,c){var d=this;try{this.open(function(e,f){if(e)return void(c&&c(e));var g=f.openCursor(d.IDBKeyRange.only(a));g.onsuccess=function(){var a=g.result;a?(f["delete"](a.primaryKey),a["continue"]()):c&&c()},g.onerror=function(a){var d="Database Problem: "+a.target.error.message,e=new b.Error(d);console.error(d),c&&c(e)}})}catch(e){c&&c(e)}},getAll:function(a){var c=this;try{this.open(function(d,e){if(d)return void a(d);var f=c.IDBKeyRange.lowerBound(0),g=e.openCursor(f),h={};g.onsuccess=function(b){var c=b.target.result;c?(h[c.key]=c.value,c["continue"]()):a(null,h)},g.onerror=function(c){var d="Database Problem: "+c.target.error.message,e=new b.Error(d);console.error(d),a(e)}})}catch(d){a(d)}},has:function(a,b){this.get(a,function(a,c){return a?void b(a):void b(null,void 0!==c&&null!==c)})},clear:function(a){try{this.open(function(c,d){if(c)return void(a&&a(c));var e=d.clear();e.onsuccess=function(){a&&a()},e.onerror=function(c){var d="Database Problem: "+c.target.error.message,e=new b.Error(d);console.error(d),a&&a(e)}})}catch(c){a&&a(c)}},size:function(a){this.getAll(function(b,c){if(b)return void a(b);var d=JSON.stringify(c).length;a(null,d)})},open:function(a){var c=this,d=null;try{d=this.indexedDB.open(this.NAME,this.VERSION),d.onsuccess=function(d){var e=d.target.result,f=e.transaction([c.STORE_NAME],"readwrite"),g=null,h=null;f&&(g=f.objectStore(c.STORE_NAME),g?a(null,g):(h=new b.Error("Database Problem: no such store"),a(h)))},d.onupgradeneeded=function(a){var b=a.target.result;b.createObjectStore(c.STORE_NAME)},d.onerror=function(c){var d="Database Problem: "+c.target.error.message,e=new b.Error(d);console.error(d),a(e)},d.onblocked=function(c){var d="Database Problem: "+c.target.error.message,e=new b.Error(d);console.error(d),a(e)}}catch(e){a(e)}}}),a}(),b.Storage=function(){var a=function(a){a||(a={});var c=this;this.Sample=a.Sample||b.Sample,this.manager=a.manager,this.Storage=a.Storage||b.LocalStorage,this.storage=new this.Storage({appname:a.appname}),this.cache={},this.initialized=!1,this.storage.getAll(function(a,d){d||(d={});for(var e=[],f=null,g=Object.keys(d),h=0;h<g.length;h++){var i=d[g[h]],j=_.extend(i,{_manager:c.manager});f=new c.Sample(i.attributes,j),e.push(f)}c.cache=new b.Collection(e,{model:c.Sample}),c._attachListeners(),c.initialized=!0,c.trigger("init")})};return _.extend(a.prototype,{get:function(a,b){if(!this.initialized)return void this.on("init",function(){this.get(a,b)});var c="object"==typeof a?a.id||a.cid:a;b(null,this.cache.get(c))},getAll:function(a){return this.initialized?void a(null,this.cache):void this.on("init",function(){this.getAll(a)})},set:function(a,b){if(!this.initialized)return void this.on("init",function(){this.set(a,b)});var c=this,d=a.id||a.cid;this.storage.set(d,a,function(d){return d?void(b&&b(d)):(c.cache.set(a,{remove:!1}),void(b&&b(null,a)))})},remove:function(a,b){if(!this.initialized)return void this.on("init",function(){this.remove(a,b)});var c="object"==typeof a?a.id||a.cid:a;this.storage.remove(c,function(c){return c?void(b&&b(c)):(delete a._manager,void a.destroy(b))})},has:function(a,b){if(!this.initialized)return void this.on("init",function(){this.has(a,b)},this);var c="object"==typeof a?a.id||a.cid:a;this.cache.has(c,b)},clear:function(a){if(!this.initialized)return void this.on("init",function(){this.clear(a)});var b=this;this.storage.clear(function(c){return c?void(a&&a(c)):(b.cache.reset(),void(a&&a()))})},size:function(a){this.storage.size(a)},_attachListeners:function(){var a=this;this.cache.on("update",function(){a.trigger("update")})}}),_.extend(a.prototype,d.Events),a}(),b.Manager=function(){var a=function(a){this.options=a||(a={}),this.storage=new b.Storage({appname:a.appname,Sample:a.Sample,Storage:a.Storage,manager:this}),this.onSend=a.onSend,this._attachListeners(),this.synchronising=!1};return _.extend(a.prototype,{get:function(a,b){this.storage.get(a,b)},getAll:function(a){this.storage.getAll(a)},set:function(a,b){a._manager=this,this.storage.set(a,b)},remove:function(a,b){this.storage.remove(a,b)},has:function(a,b){this.storage.has(a,b)},clear:function(a){this.storage.clear(a)},sync:function(a,c){var d=this;return a instanceof b.Sample?void(a.metadata.synchronising||(a.metadata.synchronising=!0,d.sendStored(a,function(b){a.metadata.synchronising=!1,c&&c(b)}))):void this.get(a,function(a,b){return a?void(c&&c(a)):void(b.metadata.synchronising||(b.metadata.synchronising=!0,d.sendStored(b,function(a){b.metadata.synchronising=!1,c&&c(a)})))})},syncAll:function(a){var b=this;this.synchronising?(b.trigger("sync:done"),a&&a()):(this.synchronising=!0,this.sendAllStored(function(c){b.synchronising=!1,a&&a(c)}))},sendAllStored:function(a){var c=this;this.getAll(function(d,e){if(d)return c.trigger("sync:error"),void a(d);c.trigger("sync:request");for(var f=_.extend([],e.models),g=0;g<f.length;g++){var h=f[g];h.validate()||h.getSyncStatus()===b.SYNCED?(f.splice(g,1),g--):c.sendStored(h,function(b,d){if(b)return c.trigger("sync:error"),void a(b);for(var e=0;e<f.length;e++)if(f[e].id===d.id||f[e].cid===d.cid){f.splice(e,1);break}0===f.length&&(c.trigger("sync:done"),a())})}f.length||(c.trigger("sync:done"),a())})},sendStored:function(a,c){var d=this;if(a.getSyncStatus()===b.SYNCED)return a.trigger("sync:done"),void(c&&c(null,a));var e=this.onSend&&this.onSend(a);return e?void(c&&c(null,a)):(a.metadata.synchronising=!0,a.trigger("sync:request"),void this.send(a,function(b){return a.metadata.synchronising=!1,b?(a.trigger("sync:error"),void(c&&c(b))):(a.metadata.warehouse_id=1,a.metadata.server_on=new Date,a.metadata.synced_on=new Date,void d._resizeImages(a,function(){d.set(a,function(b){return b?(a.trigger("sync:error"),void(c&&c(b))):(a.trigger("sync:done"),void(c&&c(null,a)))})}))}))},send:function(a,c){var d=a.flatten(this._flattener),e=new FormData,f=0;a.occurrences.each(function(a){var c=0;a.images.each(function(a){var d=a.get("data"),g=a.get("type"),h="sc:"+f+"::photo"+c,i=b.dataURItoBlob(d,g),j=g.split("/")[1];e.append(h,i,"pic."+j),c++}),f++});for(var g=Object.keys(d),h=0;h<g.length;h++)e.append(g[h],d[g[h]]);e=this.appendAuth(e),this._post(e,function(b){c(b,a)})},_post:function(a,c){var d=new XMLHttpRequest;d.onreadystatechange=function(){var a=null;if(d.readyState===XMLHttpRequest.DONE){var e=d.status+"";switch(!0){case/2\d\d/.test(e):c&&c();break;case/4\d\d/.test(e):a=new b.Error(d.response),c&&c(a);break;default:a=new b.Error({message:"Unknown problem while sending request.",number:d.status}),c&&c(a)}}},d.open("POST",this.options.url),d.send(a)},_attachListeners:function(){var a=this;this.storage.on("update",function(){a.trigger("update")})},_flattener:function(a,c){var d=c.flattened||{},e=c.keys||{},f=c.count,g=null,h=null,i=null,j="",k="sample:",l="smpAttr:";this instanceof b.Occurrence&&(j="sc:",k="::occurrence:",l="::occAttr:");for(g in a)if(e[g]){if(h=e[g].id,h?(h=parseInt(h,10)>=0?l+h:k+h,j&&(h=j+f+h)):h=j+f+"::present",a[g]){if(i=a[g],e[g].values)if("function"==typeof e[g].values){var m=_.extend(c,{flattener:b.Manager.prototype._flattener,flattened:d});i=e[g].values(i,m)}else i=e[g].values[i];d[h]=i}}else"email"!=g&&"usersecret"!=g&&console.warn("morel.Manager: no such key: "+g),d[g]=a[g];return d},_resizeImages:function(a,b){var c=0;return a.occurrences.each(function(a){a.images.each(function(a){c++})}),c?void a.occurrences.each(function(a){a.images.each(function(a){a.resize(75,75,function(){c--,0===c&&b()})},a)}):void b()},appendAuth:function(a){return this._appendAppAuth(a),this._appendWarehouseAuth(a),a},_appendAppAuth:function(a){return a.append("appname",this.options.appname),a.append("appsecret",this.options.appsecret),a},_appendWarehouseAuth:function(a){return a.append("website_id",this.options.website_id),a.append("survey_id",this.options.survey_id),a}}),_.extend(a.prototype,d.Events),a}(),b});