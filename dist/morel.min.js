/*!
 * 
 * morel 3.2.0
 * Mobile Recording Library for biological data collection.
 * https://github.com/NERC-CEH/morel
 * Author Karolis Kazlauskis
 * Released under the GNU GPL v3 license.
 * http://www.gnu.org/licenses/gpl.html
 * 
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("underscore"),require("backbone"),require("jquery"),require("localforage")):"function"==typeof define&&define.amd?define("Morel",["_","Backbone","$","localforage"],t):"object"==typeof exports?exports.Morel=t(require("underscore"),require("backbone"),require("jquery"),require("localforage")):e.Morel=t(e._,e.Backbone,e.$,e.localforage)}(this,function(e,t,n,a){return function(e){function t(a){if(n[a])return n[a].exports;var r=n[a]={exports:{},id:a,loaded:!1};return e[a].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function a(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function r(e){return e&&e.__esModule?e:{"default":e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),u=n(1),s=r(u),c=n(2),d=r(c),l=n(3),f=r(l),h=n(9),v=r(h),p=n(11),m=r(p),g=n(6),y=r(g),b=n(8),w=r(b),_=n(4),S=a(_),x=n(5),O=r(x),I=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];i(this,e),this.options=t,t.manager=this,this.storage=new m["default"](t),this.onSend=t.onSend,this._attachListeners(),this.synchronising=!1}return o(e,[{key:"get",value:function(e,t){return this.storage.get(e,t)}},{key:"getAll",value:function(e){return this.storage.getAll(e)}},{key:"set",value:function(e,t){return e instanceof f["default"]&&(e.manager=this),this.storage.set(e,t)}},{key:"remove",value:function(e,t){return this.storage.remove(e,t)}},{key:"has",value:function(e,t){return this.storage.has(e,t)}},{key:"clear",value:function(e){return this.storage.clear(e)}},{key:"syncAll",value:function(e,t){var n=this,a=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],r=new Promise(function(e,r){function i(t){var n=[];t.each(function(e){var t=e.save(null,{remote:!0,timeout:a.timeout}),r=void 0;r=t?new Promise(function(e){t.then(e)["catch"](e)}):Promise.resolve(),n.push(r)}),Promise.all(n).then(e)}return t?void i(t):void n.getAll(function(e,t){return e?void r(e):void i(t)})});return r}},{key:"post",value:function(e,t){var n=this,a=e.onSend||this.onSend,r=a&&a(e);if(r)return!1;var i=new Promise(function(a,r){e.synchronising=!0,n._getModelFormData(e,function(n,i){var o=S.API_BASE+S.API_VER+S.API_SAMPLES_PATH,u=t.xhr=d["default"].ajax({url:t.host+o,type:"POST",data:i,processData:!1,contentType:!1,timeout:t.timeout||3e4});u.done(function(n,r,i){e.synchronising=!1,e.metadata.warehouse_id=1;var o=new Date;e.metadata.server_on=o,e.metadata.updated_on=o,e.metadata.synced_on=o,a(e,null,t)}),u.fail(function(n,i,o){return"Conflict"===o?void a(e,null,t):(e.synchronising=!1,e.trigger("error"),void r(n,i,o))}),e.trigger("request",e,u,t)})});return i}},{key:"_attachListeners",value:function(){var e=this;this.storage.on("update",function(){e.trigger("update")})}},{key:"_getModelFormData",value:function(e){var t=this,n=new Promise(function(n,a){var r=e.flatten(t._flattener),i=new FormData,o=0,u=[];e.occurrences.each(function(e){var t=o,n=0,a=[];e.images.each(function(e){var r=new Promise(function(a){function r(e,r,o,s){var c="sc:"+t+"::photo"+n,d=u,l=u;u.match(/image.*/)?d=u.split("/")[1]:l="image/"+l,s||(s=O["default"].dataURItoBlob(o,l)),i.append(c,s,"pic."+d),n++,a()}var o=e.getURL(),u=e.get("type");O["default"].isDataURL(o)?r(null,null,o):!function(){var e=new XMLHttpRequest;e.open("GET",o,!0),e.responseType="blob",e.onload=function(){r(null,null,null,e.response)},e.send()}()});a.push(r)}),u.push(Promise.all(a)),o++}),Promise.all(u).then(function(){for(var e=Object.keys(r),a=0;a<e.length;a++)i.append(e[a],r[e[a]]);i=t.appendAuth(i),n(i)})});return n}},{key:"_flattener",value:function(t,n){var a=n.flattened||{},r=n.keys||{},i=n.count,o=null,u=null,c=null,d="",l="sample:",f="smpAttr:";this instanceof v["default"]&&(d="sc:",l="::occurrence:",f="::occAttr:");var h=this.cid;h&&(this instanceof v["default"]?a[d+i+l+"external_key"]=h:a[l+"external_key"]=this.cid);for(o in t)if(r[o]){if(u=r[o].id,u?(u=parseInt(u,10)>=0?f+u:l+u,d&&(u=d+i+u)):u=d+i+"::present",t[o]){if(c=t[o],r[o].values)if("function"==typeof r[o].values){var p=s["default"].extend(n,{flattener:e.prototype._flattener,flattened:a});c=r[o].values(c,p)}else c=r[o].values[c];c&&(a[u]=c)}}else"email"!==o&&"usersecret"!==o&&console.warn("Morel: no such key: "+o),a[o]=t[o];return a}},{key:"appendAuth",value:function(e){return this._appendAppAuth(e),this._appendWarehouseAuth(e),e}},{key:"_appendAppAuth",value:function(e){return e.append("appname",this.options.appname),e.append("appsecret",this.options.appsecret),e}},{key:"_appendWarehouseAuth",value:function(e){return e.append("website_id",this.options.website_id),e.append("survey_id",this.options.survey_id),e}}],[{key:"sync",value:function(t,n){var a=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];if(n.getSyncStatus()===S.SYNCED||n.getSyncStatus()===S.SYNCHRONISING)return!1;var r=new Promise(function(t,r){a.host=n.manager.options.host,e.prototype.post.apply(n.manager,[n,a]).then(function(e){e.save().then(function(){e.trigger("sync"),t(e)})})["catch"](r)});return r}}]),e}();s["default"].extend(I.prototype,d["default"].Events),s["default"].extend(I,S,{VERSION:"3.2.0",Sample:f["default"],Occurrence:v["default"],Image:y["default"],Error:w["default"]}),t["default"]=I},function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var r=n(2),i=a(r),o=n(1),u=a(o),s=n(4),c=n(5),d=a(c),l=n(6),f=a(l),h=n(9),v=a(h),p=n(10),m=a(p),g=i["default"].Model.extend({Image:f["default"],Occurrence:v["default"],constructor:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],a=this,r=t,i={date:new Date,location_type:"latlon"};if(r=u["default"].extend(i,r),this.cid=n.cid||d["default"].getNewUUID(),this.manager=n.manager||this.manager,this.manager&&(this.sync=this.manager.sync),n.Image&&(this.Image=n.Image),n.Occurrence&&(this.Occurrence=n.Occurrence),n.onSend&&(this.onSend=n.onSend),this.attributes={},n.collection&&(this.collection=n.collection),n.parse&&(r=this.parse(r,n)||{}),r=u["default"].defaults({},r,u["default"].result(this,"defaults")),this.set(r,n),this.changed={},n.metadata)this.metadata=n.metadata;else{var o=new Date;this.metadata={created_on:o,updated_on:o,warehouse_id:null,synced_on:null,server_on:null}}n.occurrences?!function(){var t=[];u["default"].each(n.occurrences,function(e){if(e instanceof a.Occurrence)e.setSample(a),t.push(e);else{var n=u["default"].extend(e,{sample:a});t.push(new a.Occurrence(e.attributes,n))}}),e.occurrences=new m["default"](t,{model:e.Occurrence})}():this.occurrences=new m["default"]([],{model:this.Occurrence}),n.images?!function(){var t=[];u["default"].each(n.images,function(n){if(n instanceof e.Image)n.setParent(a),t.push(n);else{var r=u["default"].extend(n,{parent:a});t.push(new e.Image(n.attributes,r))}}),e.images=new m["default"](t,{model:e.Image})}():this.images=new m["default"]([],{model:this.Image}),this.initialize.apply(this,arguments)},save:function(e){var t=this,n=arguments,a=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];if(!this.manager)return!1;var r=new Promise(function(e,r){a.remote||t.manager.set(t).then(e)["catch"](r),i["default"].Model.prototype.save.apply(t,n).then(e)["catch"](r)});return r},destroy:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=new Promise(function(n,a){e.manager&&!t.noSave?e.manager.remove(e).then(n)["catch"](a):(e.stopListening(),e.trigger("destroy",e,e.collection,t),n())});return n},addOccurrence:function(e){e&&(e.setSample(this),this.occurrences.push(e))},addImage:function(e){e&&(e.setParent(this),this.images.add(e))},validate:function(e){var t=u["default"].extend({},this.attributes,e),n={},a={};if(t.location||(n.location="can't be blank"),t.location_type||(n.location_type="can't be blank"),t.date){var r=new Date(t.date);("Invalid Date"===r||r>new Date)&&(n.date=new Date(r)>new Date?"future date":"invalid")}else n.date="can't be blank";if(0===this.occurrences.length?n.occurrences="no occurrences":this.occurrences.each(function(e){var t=e.validate();if(t){var n=e.cid;a[n]=t}}),!u["default"].isEmpty(n)||!u["default"].isEmpty(a)){var i={sample:n,occurrences:a};return i}return null},flatten:function(e){var t=e.apply(this,[this.attributes,{keys:g.keys}]);return u["default"].extend(t,this.occurrences.flatten(e)),t},toJSON:function(){var e=void 0,t=this.occurrences;t?e=t.toJSON():(e=[],console.warn("toJSON occurrences missing"));var n=void 0,a=this.images;a?n=a.toJSON():(n=[],console.warn("toJSON images missing"));var r={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,occurrences:e,images:n};return r},getSyncStatus:function(){var e=this.metadata;return this.synchronising?s.SYNCHRONISING:e.warehouse_id?e.synced_on?e.synced_on<e.updated_on?e.synced_on<e.server_on?s.CONFLICT:s.CHANGED_LOCALLY:e.synced_on<e.server_on?s.CHANGED_SERVER:s.SYNCED:s.SERVER:s.LOCAL},offAll:function(){this._events={},this.occurrences.offAll();for(var e=0;e<this.occurrences.data.length;e++)this.occurrences.models[e].offAll()}});g.keys={id:{id:"id"},survey:{id:"survey_id"},date:{id:"date"},comment:{id:"comment"},image:{id:"image"},location:{id:"entered_sref"},location_type:{id:"entered_sref_system",values:{british:"OSGB",irish:"OSIE",latlon:4326}},location_name:{id:"location_name"},form:{id:"input_form"},group:{id:"group_id"},deleted:{id:"deleted"}},t["default"]=g},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.API_BASE="api/",t.API_VER="v0.1",t.API_SAMPLES_PATH="/samples",t.SYNCHRONISING=0,t.SYNCED=1,t.LOCAL=2,t.SERVER=3,t.CHANGED_LOCALLY=4,t.CHANGED_SERVER=5,t.CONFLICT=-1},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},a=function(e){if(null===e||"object"!==("undefined"==typeof e?"undefined":n(e)))return e;var t={};for(var a in e)e.hasOwnProperty(a)&&(t[a]=objClone(e[a]));return t},r=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"===e?t:3&t|8;return n.toString(16)})},i=function(e,t){for(var n=atob(e.split(",")[1]),a=[],r=0;r<n.length;r++)a.push(n.charCodeAt(r));return new Blob([new Uint8Array(a)],{type:t})},o=function(e){if(!e)return!1;var t=e.toString(),n=/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i;return!!t.match(n)},u=function(e){function t(e){for(var t={},n="Boolean Number String Function Array Date RegExp Object".split(" "),a=0;a<n.length;a++)t["[object "+n[a]+"]"]=n[a].toLowerCase();return null==e?String(e):t[toString.call(e)]||"object"}function a(e){return e&&"object"===("undefined"==typeof e?"undefined":n(e))&&"setInterval"in e}if(!e||"object"!==t(e)||e.nodeType||a(e))return!1;if(e.constructor&&!hasOwn.call(e,"constructor")&&!hasOwn.call(e.constructor.prototype,"isPrototypeOf"))return!1;var r=void 0;for(r in e);return void 0===r||hasOwn.call(e,r)},s=function(e){for(var t in e)return!1;return!0},c=function(e){var t=e,n=new Date,a=0,r=0,i=/\d{2}\/\d{2}\/\d{4}$/,o=/\d{4}-\d{1,2}-\d{1,2}$/,u=/\d{1,2}-\d{1,2}-\d{4}$/,s=[];if("string"==typeof t){if(s=t.split("-"),i.test(t))return t;o.test(t)?t=new Date(window.parseInt(s[0]),window.parseInt(s[1])-1,window.parseInt(s[2])):u.test(t)&&(t=new Date(window.parseInt(s[2]),window.parseInt(s[1])-1,window.parseInt(s[0])))}return n=t||n,a=("0"+n.getDate()).slice(-2),r=("0"+(n.getMonth()+1)).slice(-2),a+"/"+r+"/"+n.getFullYear()};t["default"]={cloneDeep:a,getNewUUID:r,dataURItoBlob:i,isDataURL:o,isPlainObject:u,isEmptyObject:s,formatDate:c}},function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},i=n(7),o=(a(i),n(2)),u=a(o),s=n(1),c=a(s),d=n(5),l=a(d),f=n(8),h=a(f),v=100,p=100,m=u["default"].Model.extend({constructor:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=e;if("string"==typeof e){var a=e;return void(n={data:a})}this.cid=t.cid||l["default"].getNewUUID(),this.setParent(t.parent||this.parent),this.attributes={},t.collection&&(this.collection=t.collection),t.parse&&(n=this.parse(n,t)||{}),n=c["default"].defaults({},n,c["default"].result(this,"defaults")),this.set(n,t),this.changed={},t.metadata?this.metadata=t.metadata:this.metadata={created_on:new Date},this.initialize.apply(this,arguments)},save:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return this.parent?this.parent.save(e,t):!1},destroy:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=new Promise(function(n){return e.stopListening(),e.trigger("destroy",e,e.collection,t),e.parent&&!t.noSave?void e.save(null,t).then(n):void n()});return n},getURL:function(){return this.get("data")},setParent:function(e){if(e){var t=this;this.parent=e,this.parent.on("destroy",function(){t.destroy({noSave:!0})})}},resize:function(e,t){var n=this,a=this,r=new Promise(function(r,i){m.resize(n.getURL(),n.get("type"),e,t).then(function(e,t){a.set("data",t),r(e,t)})["catch"](i)});return r},addThumbnail:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=this,a=new Promise(function(a,r){var i=/^data:/i;return i.test(e.getURL())?void m.resize(e.getURL(),e.get("type"),v||t.width,v||t.width).then(function(e,t){n.set("thumbnail",t),a()})["catch"](r):void m.getDataURI(e.getURL(),{width:v||t.width,height:p||t.height}).then(function(e){n.set("thumbnail",e),a()})["catch"](r)});return a},toJSON:function(){var e={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes};return e}});c["default"].extend(m,{getDataURI:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=new Promise(function(n,a){if("string"==typeof e){var i=function(){var a=e.replace(/.*\.([a-z]+)$/i,"$1");return"jpg"===a&&(a="jpeg"),m.resize(e,a,t.width,t.height,function(e,t,r){n(r,a,t.width,t.height)}),{v:void 0}}();if("object"===("undefined"==typeof i?"undefined":r(i)))return i.v}if(!window.FileReader){var o="No File Reader",u=new h["default"](o);return console.error(o),void a(u)}var s=new FileReader;s.onload=function(a){t.width||t.height?m.resize(a.target.result,e.type,t.width,t.height,function(t,a,r){n(r,e.type,a.width,a.height)}):!function(){var t=new window.Image;t.onload=function(){var r=e.type.replace(/.*\/([a-z]+)$/i,"$1");n(a.target.result,r,t.width,t.height)},t.src=a.target.result}()},s.readAsDataURL(e)});return n},resize:function(e,t,n,a){var r=new Promise(function(r,i){var o=new window.Image;o.onload=function(){var e=o.width,i=o.height,u=n||e,s=a||i,c=null,d=null;d=e>i?e/u:i/s,e/=d,i/=d,c=document.createElement("canvas"),c.width=e,c.height=i,c.getContext("2d").drawImage(o,0,0,e,i),r(o,c.toDataURL(t))},o.src=e});return r}}),t["default"]=m},function(e,t){e.exports=n},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function r(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return n(this,r),"string"==typeof e?(this.code=-1,void(this.message=e)):(this.code=e.code||-1,void(this.message=e.message||""))};t["default"]=a},function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var r=n(2),i=a(r),o=n(1),u=a(o),s=n(5),c=a(s),d=n(6),l=a(d),f=n(10),h=a(f),v=i["default"].Model.extend({Image:l["default"],constructor:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],a=this,r=t;this.cid=n.cid||c["default"].getNewUUID(),this.setSample(n.sample||this.sample),n.Image&&(this.Image=n.Image),this.attributes={},n.collection&&(this.collection=n.collection),n.parse&&(r=this.parse(r,n)||{}),r=u["default"].defaults({},r,u["default"].result(this,"defaults")),this.set(r,n),this.changed={},n.metadata?this.metadata=n.metadata:this.metadata={created_on:new Date},n.images?!function(){var t=[];u["default"].each(n.images,function(n){if(n instanceof e.Image)n.setParent(a),t.push(n);else{var r=u["default"].extend(n,{parent:a});t.push(new e.Image(n.attributes,r))}}),e.images=new h["default"](t,{model:e.Image})}():this.images=new h["default"]([],{model:this.Image}),this.initialize.apply(this,arguments)},save:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return this.sample?this.sample.save(e,t):!1},destroy:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=new Promise(function(n){e.stopListening(),e.trigger("destroy",e,e.collection,t),e.sample&&!t.noSave?e.save(null,t).then(n):n()});return n},setSample:function(e){if(e){var t=this;this.sample=e,this.sample.on("destroy",function(){t.destroy({noSave:!0})})}},addImage:function(e){e&&(e.setParent(this),this.images.add(e))},validate:function(e){var t=u["default"].extend({},this.attributes,e),n={};return t.taxon||(n.taxon="can't be blank"),u["default"].isEmpty(n)?null:n},toJSON:function(){var e=void 0,t=this.images;t?e=t.toJSON():(e=[],console.warn("toJSON images missing"));var n={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,images:e};return n},flatten:function(e,t){return e.apply(this,[this.attributes,{keys:v.keys,count:t}])}});v.keys={taxon:{id:""},comment:{id:"comment"}},t["default"]=v},function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var r=n(2),i=a(r),o=n(1),u=a(o),s=i["default"].Collection.extend({flatten:function(e){for(var t={},n=0;n<this.length;n++)u["default"].extend(t,this.models[n].flatten(e,n));return t},comparator:function(e){return e.metadata.created_on}});t["default"]=s},function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),u=n(1),s=a(u),c=n(2),d=a(c),l=n(12),f=a(l),h=n(8),v=a(h),p=n(3),m=a(p),g=n(10),y=a(g),b=function(){function e(){var t=this,n=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];r(this,e);var a=this;this._initialized=!1,this.Sample=n.Sample||m["default"],this.manager=n.manager;var o=n.storage||{};this.db=null;var u=new Promise(function(e,t){var n=new Promise(function(e){o.driverOrder&&"object"===i(o.driverOrder[0])?f["default"].defineDriver(o.driverOrder[0]).then(e):e()});n.then(function(){var n={name:o.name||"morel",storeName:o.storeName||"models"};o.version&&(n.version=o.version);var r=o.driverOrder||["indexeddb","websql","localstorage"],i=a._getDriverOrder(r),u=o.LocalForage||f["default"];a.db=u.createInstance(n),a.db.setDriver(i).then(function(){e(a.db)})["catch"](function(e){return t(e)})})});this._cache={},u.then(function(){var e=[];t.db.iterate(function(t){var n=s["default"].extend(t,{manager:a.manager}),r=new a.Sample(t.attributes,n);e.push(r)}).then(function(){a._cache=new y["default"](e,{model:a.Sample}),a._attachListeners(),a._initialized=!0,a.trigger("init")})})}return o(e,[{key:"ready",value:function(){return this._initialized}},{key:"get",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],a=this,r=new Promise(function(r,o){if(!t.ready())return void t.on("init",function(){t.get(e,n).then(r)["catch"](o)});var u="object"===("undefined"==typeof e?"undefined":i(e))?e.cid:e;if(n.nonCached)return void t.db.getItem(u).then(function(e){var t=s["default"].extend(e,{manager:a.manager}),n=new a.Sample(e.attributes,t);r(n)})["catch"](o);var c=t._cache.get(u);r(c)});return r}},{key:"getAll",value:function(){var e=this,t=new Promise(function(t,n){return e.ready()?void t(e._cache):void e.on("init",function(){e.getAll().then(t)["catch"](n)})});return t}},{key:"set",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=new Promise(function(n,a){if(!t.cid){var r=new v["default"]("Invalid model passed to storage");return void a(r)}if(!e.ready())return void e.on("init",function(){e.set(t).then(n)["catch"](a)});var i=e,o=t.cid,u="function"==typeof t.toJSON?t.toJSON():t;e.db.setItem(o,u).then(function(){if(t instanceof i.Sample)i._cache.set(t,{remove:!1});else{var e=s["default"].extend(t,{manager:i.manager}),a=new i.Sample(t.attributes,e);i._cache.set(a,{remove:!1})}n(t)})["catch"](a)});return n}},{key:"remove",value:function(e){var t=this,n=new Promise(function(n,a){if(!t.ready())return void t.on("init",function(){t.remove(e).then(n)["catch"](a)});var r="object"===("undefined"==typeof e?"undefined":i(e))?e.cid:e;t.db.removeItem(r).then(function(){return delete e.manager,e.destroy().then(n)})["catch"](a)});return n}},{key:"has",value:function(e){var t=this,n=new Promise(function(n,a){return t.ready()?void t.get(e).then(function(e){var t="object"===("undefined"==typeof e?"undefined":i(e));n(t)}):void t.on("init",function(){t.has(e).then(n)["catch"](a)},t)});return n}},{key:"clear",value:function(){var e=this,t=new Promise(function(t,n){if(!e.ready())return void e.on("init",function(){e.clear().then(t)["catch"](n)});var a=e;e.db.clear().then(function(){a._cache.reset(),t()})["catch"](n)});return t}},{key:"size",value:function(){var e=this,t=new Promise(function(t,n){e.db.length().then(t)["catch"](n)});return t}},{key:"_attachListeners",value:function(){var e=this;this._cache.on("update",function(){e.trigger("update")})}}],[{key:"_getDriverOrder",value:function(e){return e.map(function(e){switch(e){case"indexeddb":return f["default"].INDEXEDDB;case"websql":return f["default"].WEBSQL;case"localstorage":return f["default"].LOCALSTORAGE;default:return"object"===("undefined"==typeof e?"undefined":i(e))&&e._driver?e._driver:console.error("No such db driver!")}})}}]),e}();s["default"].extend(b.prototype,d["default"].Events),t["default"]=b},function(e,t){e.exports=a}])});