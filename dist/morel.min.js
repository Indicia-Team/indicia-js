/*!
 * Mobile Recording Library for biological data collection. 
 * Version: 1.0.0
 *
 * https://github.com/NERC-CEH/morel
 *
 * Author 2015 Karols Kazlauskis
 * Released under the GNU GPL v3 license.
 */
function fixPageBackButtons(a,b){console.log("FIXING: back buttons ( "+b+")");var c=jQuery("div[id='"+b+"'] a[data-rel='back']");c.each(function(b,c){jQuery(c).removeAttr("data-rel"),null!=a&&jQuery(c).attr("href",a)})}function browserDetect(a){if("Chrome"==a||"Safari"==a){var b=navigator.userAgent.indexOf("Chrome")>-1,c=navigator.userAgent.indexOf("Safari")>-1,d=navigator.userAgent.indexOf("Mobile")>-1;return c?"Chrome"==a?b?!0:!1:b?!1:!0:d?!0:!1}return navigator.userAgent.indexOf(a)>-1}function getParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null==c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function _log(a,b){if(app.CONF.LOG!=app.LOG_NONE&&(app.CONF.LOG>=b||null==b))switch(b){case app.LOG_ERROR:_logError(a);break;case app.LOG_WARNING:console.warn(a);break;case app.LOG_INFO:console.log(a);break;case app.LOG_DEBUG:default:if(null==console.debug){console.log(a);break}console.debug(a)}}function _logError(a){console.error(a.message,a.url,a.line);var b='<b style="color: red">'+a.message+"</b>";b+='</br><b> app.version = </b><i>"'+app.version+'"</i>',b+='</br><b> app.CONF.NAME = </b><i>"'+app.CONF.NAME+'"</i>',b+='</br><b> app.CONF.VERSION = </b><i>"'+app.CONF.VERSION+'"</i></br>',b+="</br>"+navigator.appName,b+="</br>"+navigator.appVersion;var c=a.url+" ("+a.line+")";if(navigator.onLine){var d={};d.append=function(a,b){this[a]=b},d.append("message",b),d.append("url",c),app.auth.appendApp(d),delete d.append,jQuery.ajax({url:Drupal.settings.basePath+"mobile/log",type:"post",dataType:"json",success:function(a){console.log(a)},data:d})}}function _onerror(a,b,c){window.onerror=null;var d={message:a,url:b||"",line:c||-1};return _log(d,app.LOG_ERROR),window.onerror=this,!0}function loadScript(a){var b=document.createElement("script");b.type="text/javascript",b.src=a,document.body.appendChild(b)}function startManifestDownload(a,b,c,d,e){if(navigator.onLine){c=Drupal.settings.basePath+c+"?base_path="+Drupal.settings.basePath+"&files="+b;var f=document.getElementById(a);f?f.contentWindow.applicationCache.update():(app.navigation.message('<iframe id="'+a+'" src="'+c+'" width="215px" height="215px" scrolling="no" frameBorder="0"></iframe>',0),f=document.getElementById(a),f.onload=function(){_log("Manifest frame loaded",app.LOG_INFO),null!=d&&(f.contentWindow.finished=d),null!=e&&(f.contentWindow.error=e)})}else $.mobile.loading("show",{text:"Looks like you are offline!",theme:"b",textVisible:!0,textonly:!0})}function varInit(a){var b=a.split(".");window[b[0]]=window[b[0]]||{};for(var c=window[b[0]],d=1;d<b.length;d++)"object"!==c[b[d]]&&(c[b[d]]={}),c=c[b[d]];return c}function objClone(a){if(null==a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)a.hasOwnProperty(c)&&(b[c]=objClone(a[c]));return b}function dataURItoBlob(a,b){for(var c=atob(a.split(",")[1]),d=[],e=0;e<c.length;e++)d.push(c.charCodeAt(e));return new Blob([new Uint8Array(d)],{type:b})}app=function(a,b){return a.version="1.0.0",a.CONF={HOME:"",NAME:"",LOG:a.LOG_ERROR},a.$=b,a.data={},a.TRUE=1,a.FALSE=0,a.ERROR=-1,a.LOG_NONE=0,a.LOG_ERROR=1,a.LOG_WARNING=2,a.LOG_INFO=3,a.LOG_DEBUG=4,a.pageEvents=["pagebeforecreate","pagecreate","pagecontainerbeforechange ","pagecontainerbeforetransition","pagecontainerbeforehide","pagecontainerhide","pagecontainerbeforeshow","pagecontainershow","pagecontainertransition","pagecontainerchange","pagecontainerchangefailed","pagecontainerbeforeload","pagecontainerload","pagecontainerloadfailed","pagecontainerremove"],a.initialise=function(){_log("APP: initialised.",app.LOG_INFO),b(document).on(app.pageEvents.join(" "),function(a,b){var c=a.type,d=null;switch(c){case"pagecreate":case"pagecontainerbeforechange":d=null!=b.prevPage?b.prevPage[0].id:a.target.id;break;case"pagebeforecreate":d=a.target.id;break;case"pagecontainershow":case"pagecontainerbeforetransition":case"pagecontainerbeforehide":case"pagecontainerbeforeshow":case"pagecontainertransition":case"pagecontainerhide":case"pagecontainerchangefailed":case"pagecontainerchange":d=b.toPage[0].id;break;case"pagecontainerbeforeload":case"pagecontainerload":case"pagecontainerloadfailed":}var e=app.controller[d];e&&e[c]&&e[c](a,b)})},a.initSettings=function(){app.storage.set("settings",{})},a.settings=function(a,b){var c=app.storage.get("settings");return null==c&&(app.initSettings(),c=app.storage.get("settings")),null!=b?(c[a]=b,app.storage.set("settings",c)):void 0!=a?c[a]:c},a.reset=function(){app.storage.clear(),app.storage.tmpClear(),app.record.db.clear()},a}(window.app||{},jQuery),app=app||{},app.auth=function(a,b){return a.CONF={APPNAME:"",APPSECRET:"",WEBSITE_ID:0,SURVEY_ID:0},a.USER="user",a.append=function(b){return a.appendUser(b),a.appendApp(b),a.appendWarehouse(b),b},a.appendUser=function(b){var c=a.getUser();return a.isUser()&&(b.append("email",c.email),b.append("password",c.password)),b},a.appendApp=function(a){return a.append("appname",this.CONF.APPNAME),a.append("appsecret",this.CONF.APPSECRET),a},a.appendWarehouse=function(a){return a.append("website_id",this.CONF.WEBSITE_ID),a.append("survey_id",this.CONF.SURVEY_ID),a},a.isUser=function(){var c=a.getUser();return!b.isEmptyObject(c)},a.getUser=function(){return app.settings(a.USER)},a.setUser=function(b){app.settings(a.USER,b)},a.removeUser=function(){app.settings(a.USER,{})},a}(app.auth||{},jQuery),app=app||{},app.db=function(a){return a.DB_VERSION=1,a.DB_MAIN="app",a.STORE_MAIN="main",a.open=function(b,c,d){var e=window.indexedDB.open(b,a.DB_VERSION);e.onsuccess=function(a){_log("DB: opened successfully.",app.LOG_DEBUG);var b=a.target.result,e=b.transaction([c],"readwrite"),f=e.objectStore(c);null!=d&&d(f)},e.onupgradeneeded=function(a){_log("DB: upgrading.",app.LOG_INFO);var b=a.target.result;b.deleteObjectStore(app.db.STORE_MAIN),b.createObjectStore(app.db.STORE_MAIN)},e.onerror=function(){_log("DB: NOT opened successfully.",app.LOG_ERROR)},e.onblocked=function(){_log("DB: database blocked.",app.LOG_ERROR)}},a.add=function(b,c,d){a.open(a.DB_MAIN,a.STORE_MAIN,function(a){_log("DB: adding to the store.",app.LOG_DEBUG),a.add(b,c),a.transaction.db.close(),null!=d&&d()})},a.get=function(b,c){a.open(a.DB_MAIN,a.STORE_MAIN,function(a){_log("DB: getting from the store.",app.LOG_DEBUG);var d=a.get(b);null!=c&&c(d)})},a.getAll=function(b){a.open(a.DB_MAIN,a.STORE_MAIN,function(a){_log("DB: getting all from the store.",app.LOG_DEBUG);var c=IDBKeyRange.lowerBound(0),d=a.openCursor(c),e=[];d.onsuccess=function(a){var c=a.target.result;c?(e.push(c.value),c["continue"]()):null!=b&&b(e)}})},a.is=function(){},a.clear=function(b){a.open(a.DB_MAIN,a.STORE_RECORDS,function(a){_log("DB: clearing store",app.LOG_DEBUG),a.clear(),null!=b&&b(data)})},a}(app.db||{},app.$||jQuery),app=app||{},app.geoloc=function(a){return a.CONF={GPS_ACCURACY_LIMIT:26e3,HIGH_ACCURACY:!0,TIMEOUT:12e4},a.latitude=null,a.longitude=null,a.accuracy=-1,a.start_time=0,a.id=0,a.map=null,a.set=function(a,b,c){this.latitude=a,this.longitude=b,this.accuracy=c},a.get=function(){return{lat:this.latitude,lon:this.longitude,acc:this.accuracy}},a.clear=function(){a.set(null,null,-1)},a.getAccuracy=function(){return this.accuracy},a.run=function(a,b,c){return _log("GEOLOC: run.",app.LOG_INFO),navigator.geolocation?(app.geoloc.stop(),app.geoloc.clear(),this.start_time=(new Date).getTime(),void(this.id=app.geoloc.watchPosition(a,b,c))):(_log("GEOLOC: not supported!",app.LOG_ERROR),void(null!=c&&c({message:"Geolocation is not supported!"})))},a.stop=function(){navigator.geolocation.clearWatch(app.geoloc.id)},a.watchPosition=function(b,c,d){var e=function(a){var e=(new Date).getTime();if(e-app.geoloc.start_time>app.geoloc.TIMEOUT)return app.geoloc.stop(),_log("GEOLOC: timeout.",app.LOG_ERROR),void(null!=d&&d({message:"Geolocation timed out!"}));var f={lat:a.coords.latitude,lon:a.coords.longitude,acc:a.coords.accuracy},g=app.geoloc.getAccuracy();-1==g&&(g=f.acc+1),f.acc>-1&&f.acc<g&&(app.geoloc.set(f.lat,f.lon,f.acc),f.acc<app.geoloc.CONF.GPS_ACCURACY_LIMIT?(_log("GEOLOC: finished: "+f.acc+" meters.",app.LOG_INFO),app.geoloc.stop(),app.settings("location",f),null!=c&&c(f)):(_log("GEOLOC: updated acc: "+f.acc+" meters.",app.LOG_INFO),null!=b&&b(f)))},f=function(a){_log("GEOLOC: ERROR.",app.LOG_ERROR),null!=d&&d({message:a.message})},g={enableHighAccuracy:a.CONF.HIGH_ACCURACY,maximumAge:0,timeout:a.CONF.TIMEOUT};return navigator.geolocation.watchPosition(e,f,g)},a.valid=function(){var a=this.getAccuracy();return-1==a?app.ERROR:a>this.CONF.GPS_ACCURACY_LIMIT?app.FALSE:app.TRUE},a}(app.geoloc||{},app.$||jQuery),function(a){a.fn.disableTab=function(b,c){var d=this.tabs("option","disabled");if(a.isArray(d)){var e=a.inArray(b,d);0>e&&d.push(b)}else d=[b];return this.tabs("option","disabled",d),c===!0&&a(this).find("li:eq("+b+")").addClass("ui-state-hidden"),this},a.fn.enableTab=function(b){return a(this).find("li:eq("+b+")").removeClass("ui-state-hidden"),this.tabs("enable",b),this}}(jQuery),app=app||{},app.image=function(a,b){return a.MAX_IMG_HEIGHT=800,a.MAX_IMG_WIDTH=800,a.extractAllToArray=function(a,b,c){var d=app.image.findAll(a);d.length>0?app.image.toStringAll(d,b,c):b(d)},a.toString=function(a,b,c){if(null!=a){_log("IMAGE: working with "+a.name+".",app.LOG_DEBUG);var d=new FileReader;d.onload=function(){_log("IMAGE: resizing file.",app.LOG_DEBUG);var e=new Image;e.onload=function(){var c,d=e.width,f=e.height;c=d>f?d/app.image.MAX_IMG_WIDTH:f/app.image.MAX_IMG_HEIGHT,d/=c,f/=c;var g=document.createElement("canvas");g.width=d,g.height=f;var h=g.getContext("2d");h.drawImage(e,0,0,d,f);var i=g.toDataURL(a.type);_log("IMAGE: done shrinking file ("+i.length/1024+"KB).",app.LOG_DEBUG),b(i)},d.onerror=function(a){_log("IMAGE: reader "+a+".",app.LOG_ERROR),a.message=a.getMessage(),c(a)},e.src=d.result},d.readAsDataURL(a)}},a.toStringAll=function(a,b,c){function d(a,e){if(e=e||[],a.length>0){var f=a.pop(),g=f.file,h=f.input_field_name,i=function(b){e.push({name:h,value:b,type:"file"}),d(a,e,i)};app.image.toString(g,i,c)}else b(e)}d(a,null)},a.findAll=function(a){null==a&&(a=b(document));var c=[];return b(a).find("input").each(function(a,d){if("file"==b(d).attr("type")&&d.files.length>0){var e=app.image.find(d);c.push(e)}}),c},a.find=function(a){var b={file:a.files[0],input_field_name:a.attributes.name.value};return b},a}(app.image||{},jQuery),app=app||{},app.io=function(a,b){return a.CONF={RECORD_URL:""},a.sendAllSavedRecords=function(){function c(){var c=Object.keys(records)[0];if(null!=c){b.mobile.loading("show"),_log("IO: sending record: "+c+".",app.LOG_INFO);var d=function(){var a=this.callback_data.recordKey;_log("IO: record ajax (success): "+a+".",app.LOG_INFO),app.record.db.remove(a),app.io.sendAllSavedRecords()};a.sendSavedRecord(c,d)}else b.mobile.loading("hide")}navigator.onLine?app.record.db.getAll(c):(b.mobile.loading("show",{text:"Looks like you are offline!",theme:"b",textVisible:!0,textonly:!0}),setTimeout(function(){b.mobile.loading("hide")},3e3))},a.sendSavedRecord=function(b,c,d,e){function f(f){function g(a,b,c){_log("IO: ERROR record ajax ("+a.status+" "+c+").",app.LOG_ERROR);var e={message:a.status+" "+c+" "+a.responseText};d(e)}var h={data:f,recordKey:b};a.postRecord(h,c,g,e)}_log("IO: creating the record.",app.LOG_DEBUG),app.record.db.getData(b,f)},a.postRecord=function(c,d,e,f){_log("IO: posting a record with AJAX.",app.LOG_INFO);var g={};null==c.data?(form=document.getElementById(c.id),g=new FormData(form)):g=c.data,g=app.auth.append(g),b.ajax({url:a.getRecordURL(),type:"POST",data:g,callback_data:c,cache:!1,enctype:"multipart/form-data",processData:!1,contentType:!1,success:d||function(){var a=this.callback_data.recordKey;_log("IO: record ajax (success): "+a+".",app.LOG_INFO)},error:e||function(a,b,c){_log("IO: record ajax ("+a.status+" "+c+").",app.LOG_ERROR)},beforeSend:f||function(){_log("IO: onSend.",app.LOG_DEBUG)}})},a.getRecordURL=function(){return Drupal.settings.basePath+a.CONF.RECORD_URL},a}(app.io||{},jQuery),app=app||{},app.navigation=function(a,b){return a.makeDialog=function(a){b("#app-dialog-content").empty().append(a)},a.popup=function(a,c){this.makePopup(a,c),b("#app-popup").popup(),b("#app-popup").popup("open").trigger("create")},a.makePopup=function(a,c){var d=10,e=20,f="<a href='#' data-rel='back' data-role='button 'data-theme='b' data-icon='delete' data-iconpos='notext 'class='ui-btn-right ui-link ui-btn ui-btn-b ui-icon-delete ui-btn-icon-notext ui-shadow ui-corner-all 'role='button'>Close</a>";c&&(a=f+a),(d>0||e>0)&&(a="<div style='padding:"+d+"px "+e+"px;'>"+a+"<div>"),b("#app-popup").empty().append(a)},a.closePopup=function(){b("#app-popup").popup("close")},a.makeLoader=function(a,c){b.mobile.loading("hide"),b.mobile.loading("show",{theme:"b",html:"<div style='padding:5px 5px;'>"+a+"</div>",textVisible:!0,textonly:!0}),setTimeout(function(){b.mobile.loading("hide")},c)},a.message=function(a,c){if(null==a)return void _log("NAVIGATION: no text provided to message.",app.LOG_ERROR);var d="appLoaderMessage";a='<div id="'+d+'">'+a+"</div>",b.mobile.loading("show",{theme:"b",textVisible:!0,textonly:!0,html:a}),b("#"+d).trigger("create"),0!=c&&setTimeout(function(){b.mobile.loading("hide")},c||3e3)},a.go=function(a,b){setTimeout(function(){b=void 0==b?"":b,window.location=Drupal.settings.basePath+app.CONF.HOME+b},a)},a.goRecord=function(a){setTimeout(function(){b.mobile.changePage(Drupal.settings.mobileIformStartPath+"/form")},a)},a}(app.navigation||{},app.$||jQuery),app=app||{},app.record=app.record||{},app.record.db=function(a,b){return a.RECORDS="records",a.DB_VERSION=5,a.DB_MAIN="app",a.STORE_RECORDS="records",a.open=function(b,c){var d=window.indexedDB.open(a.DB_MAIN,a.DB_VERSION);d.onsuccess=function(c){_log("RECORD.DB: opened successfully.",app.LOG_DEBUG);var d=c.target.result,e=d.transaction([a.STORE_RECORDS],"readwrite"),f=e.objectStore(a.STORE_RECORDS);null!=b&&b(f)},d.onupgradeneeded=function(b){_log("RECORD.DB: upgrading",app.LOG_INFO);var c=b.target.result,d=c.createObjectStore(a.STORE_RECORDS,{keyPath:"id"});d.createIndex("id","id",{unique:!0})},d.onerror=function(a){_log("RECORD.DB: not opened successfully.",app.LOG_ERROR),a.message="Database NOT opened successfully.",null!=c&&c(a)},d.onblocked=function(a){_log("RECORD.DB: database blocked.",app.LOG_ERROR),null!=c&&c(a)}},a.add=function(b,c,d,e){a.open(function(a){_log("RECORD.DB: adding to the store.",app.LOG_DEBUG),b.id=c;var e=a.add(b);e.onsuccess=function(){null!=d&&d()},a.transaction.db.close()},e)},a.get=function(b,c,d){a.open(function(a){_log("RECORD.DB: getting from the store.",app.LOG_DEBUG);var d=a.index("id").get(b);d.onsuccess=function(a){var b=a.target.result;null!=c&&c(b)}},d)},a.remove=function(b,c,d){a.open(function(a){_log("RECORD.DB: removing from the store.",app.LOG_DEBUG);var d=a.openCursor(IDBKeyRange.only(b));d.onsuccess=function(){var b=d.result;b?(a["delete"](b.primaryKey),b["continue"]()):null!=c&&c()}},d)},a.getAll=function(b,c){a.open(function(a){_log("RECORD.DB: getting all from the store.",app.LOG_DEBUG);var c=IDBKeyRange.lowerBound(0),d=a.openCursor(c),e=[];d.onsuccess=function(a){var c=a.target.result;c?(e.push(c.value),c["continue"]()):null!=b&&b(e)}},c)},a.is=function(a,c,d){function e(a){b.isPlainObject(a)?null!=c&&c(!b.isEmptyObject(a)):null!=c&&c(null!=a)}this.get(a,e,d)},a.clear=function(b,c){a.open(function(a){_log("RECORD.DB: clearing store.",app.LOG_DEBUG),a.clear(),null!=b&&b(data)},c)},a.getData=function(a,b,c){function d(a){for(var c=new FormData,d=0;d<a.length;d++)if("file"==a[d].type){var e=a[d].value,f=e.split(";")[0].split(":")[1],g=f.split("/")[1];c.append(a[d].name,dataURItoBlob(e,f),"pic."+g)}else{var h=a[d].name,i=a[d].value;c.append(h,i)}b(c)}this.get(a,d,c)},a.save=function(b,c){_log("RECORD.DB: saving dynamic record.",app.LOG_INFO);var d=app.record.getSettings(),e=++d[app.record.LASTID],f=function(f){function g(){app.record.setSettings(d),null!=b&&b(e)}var h=app.record.extract();h=h.concat(f),_log("RECORD.DB: saving the record into database.",app.LOG_DEBUG),a.add(h,e,g,c)};return app.image.extractAllToArray(null,f,c),app.TRUE},a.saveForm=function(c,d){_log("RECORD.DB: saving a DOM record.",app.LOG_INFO);var e=this.getAll(),f=app.record.getSettings(),g=++f[app.record.LASTID],h=b(c),i=function(b){var c=app.record.extractFromRecord(h);c=c.concat(b),_log("RECORD.DB: saving the record into database.",app.LOG_DEBUG);try{e[g]=c,a.setAll(e),app.record.setSettings(f)}catch(i){return _log("RECORD.DB: while saving the record.",app.LOG_ERROR),app.ERROR}null!=d&&d(g)};return app.image.getAll(i),app.TRUE},a}(app.record.db||{},app.$||jQuery),app=app||{},app.record=app.record||{},app.record.inputs=function(a,b){return a.KEYS={SREF:"sample:entered_sref",SREF_SYSTEM:"sample:entered_sref_system",SREF_ACCURACY:"smpAttr:273",TAXON:"occurrence:taxa_taxon_list_id",DATE:"sample:date"},a.set=function(a,b){var c=app.record.get();c[a]=b,app.record.set(c)},a.get=function(a){var b=app.record.get();return b[a]},a.remove=function(a){var b=app.record.get();delete b[a],app.record.set(b)},a.is=function(a){var c=this.get(a);return b.isPlainObject(c)?!b.isEmptyObject(c):null!=c},a}(app.record.inputs||{},app.$||jQuery),app=app||{},app.record=function(a,b){return a.RECORD="record",a.MULTIPLE_GROUP_KEY="multiple_",a.COUNT="record_count",a.STORAGE="record_",a.PIC="_pic_",a.DATA="data",a.FILES="files",a.SETTINGS="recordSettings",a.LASTID="lastId",a.totalFiles=0,a.init=function(){var b=a.getSettings();return null==b?(b={},b[a.LASTID]=0,a.setSettings(b),b):null},a.setSettings=function(b){app.storage.set(a.SETTINGS,b)},a.initSettings=function(){var b={};return b[a.LASTID]=0,a.setSettings(b),b},a.getSettings=function(){var b=app.storage.get(a.SETTINGS)||a.initSettings();return b},a.get=function(){return app.storage.tmpGet(a.RECORD)||{}},a.set=function(b){app.storage.tmpSet(a.RECORD,b)},a.clear=function(){app.storage.tmpRemove(a.RECORD)},a.addValidator=function(a){b(a).validate({ignore:":hidden,.inactive",errorClass:"inline-error",errorElement:"p",highlight:function(a){var c=b(a);if(c.is(":radio")||c.is(":checkbox")){var d=c.parents(".control-box");0!==d.length?d.eq(0).addClass("ui-state-error"):c.addClass("ui-state-error")}else c.addClass("ui-state-error")},unhighlight:function(a){var c=b(a);if(c.is(":radio")||c.is(":checkbox")){var d=c.parents(".control-box");0!==d.length?d.eq(0).removeClass("ui-state-error"):c.removeClass("ui-state-error")}else c.removeClass("ui-state-error")},invalidHandler:function(a,c){var d=!1;jQuery.each(c.errorMap,function(a){var c=jQuery("[name="+a.replace(/:/g,"\\:").replace(/\[/g,"\\[").replace(/\]/g,"\\]")+"]");if(!d){var e=c.filter("input,select,textarea").closest(".ui-tabs-panel");1===e.length&&b(e).parent().tabs("select",e.id),d=!0}c.parents("fieldset").removeClass("collapsed"),c.parents(".fieldset-wrapper").show()})},messages:[],errorPlacement:function(a,c){var d,e;(c.is(":radio")||c.is(":checkbox"))&&(d=c.parents(".control-box"),c=0===d.length?c:d),e=c.nextAll(":visible"),c=e&&b(e[0]).hasClass("deh-required")?e[0]:c,a.insertAfter(c)}})},a.validate=function(a){var c=[],d=b("#"+a).find("input,select,textarea").not(":disabled,[name=],.scTaxonCell,.inactive");d.length>0&&d.each(function(){if(!b(this).valid()){for(var a=!1,d=0;d<c.length;d++){if(c[d].name==app.record.MULTIPLE_GROUP_KEY+this.name){a=!0;break}if(c[d].name==this.name){var e=this.id.substr(0,this.id.lastIndexOf(":"));c[d].name=app.record.MULTIPLE_GROUP_KEY+this.name,c[d].id=e,a=!0;break}}a||c.push({name:this.name,id:this.id})}});var e=b("#entry_record .scTaxonCell").find("input,select").not(":disabled");return e.length>0&&e.each(function(){c.push({name:this.name,id:this.id})}),c.length>0?c:[]},a.extract=function(){var a,b,c=[],d=app.record.get();if(null==d)return c;for(var e=Object.keys(d),f=0;f<e.length;f++)a=e[f],b=d[a],c.push({name:a,value:b});return c},a.extractFromRecord=function(a){var c,d,e,f,g,h=[];return a.find("input").each(function(a,i){switch(c=b(i).attr("name"),d=b(i).attr("value"),e=b(i).attr("type"),f=b(i).attr("id"),g=!0,e){case"checkbox":g=b(i).is(":checked");break;case"text":d=b(i).val();break;case"radio":g=b(i).is(":checked");break;case"button":case"file":g=!1;break;case"hidden":break;default:_log("RECORD: unknown input type: "+e+".",app.LOG_ERROR)}g&&""!=d&&h.push({name:c,value:d,type:e})}),a.find("textarea").each(function(a,f){c=b(f).attr("name"),d=b(f).val(),e="textarea",""!=d&&h.push({name:c,value:d,type:e})}),a.find("select").each(function(a,f){c=b(f).attr("name"),d=b(f).find(":selected").val(),e="select",""!=d&&h.push({name:c,value:d,type:e})}),h},a}(app.record||{},app.$||jQuery),app=app||{},app.storage=function(a,b){function c(a){var b=JSON.stringify(localStorage).length,c=5242880-b;return c-a>0?1:0}return a.hasSpace=function(a){return c(a)},a.get=function(a){a=app.CONF.NAME+"_"+a;var b=localStorage.getItem(a);return b=JSON.parse(b)},a.set=function(a,b){return a=app.CONF.NAME+"_"+a,b=JSON.stringify(b),localStorage.setItem(a,b)},a.remove=function(a){return a=app.CONF.NAME+"_"+a,localStorage.removeItem(a)},a.is=function(a){var c=this.get(a);return b.isPlainObject(c)?!b.isEmptyObject(c):null!=c},a.clear=function(){_log("STORAGE: clearing",app.LOG_DEBUG),localStorage.clear()},a.tmpGet=function(a){a=app.CONF.NAME+"_"+a;var b=sessionStorage.getItem(a);return b=JSON.parse(b)},a.tmpSet=function(a,b){return a=app.CONF.NAME+"_"+a,b=JSON.stringify(b),sessionStorage.setItem(a,b)},a.tmpRemove=function(a){return a=app.CONF.NAME+"_"+a,sessionStorage.removeItem(a)},a.tmpIs=function(a){var c=this.tmpGet(a);return b.isPlainObject(c)?!b.isEmptyObject(c):null!=c},a.tmpClear=function(){_log("STORAGE: clearing temporary",app.LOG_DEBUG),sessionStorage.clear()},a}(app.storage||{},jQuery);