/*!
 * 
 * morel 3.1.3
 * Mobile Recording Library for biological data collection.
 * https://github.com/NERC-CEH/morel
 * Author Karolis Kazlauskis
 * Released under the GNU GPL v3 license.
 * http://www.gnu.org/licenses/gpl.html
 * 
 */
!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("jQuery"),require("_"),require("Backbone"));else if("function"==typeof define&&define.amd)define(["jQuery","_","Backbone"],t);else{var n="object"==typeof exports?t(require("jQuery"),require("_"),require("Backbone")):t(e.jQuery,e._,e.Backbone);for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(this,function(e,t,n){return function(e){function t(r){if(n[r])return n[r].exports;var a=n[r]={exports:{},id:r,loaded:!1};return e[r].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(1),s=r(o),u=n(2),c=r(u),l=n(3),d=r(l),f=n(4),h=r(f),v=n(9),p=r(v),g=n(11),y=r(g),m=n(13),b=r(m),w=n(12),_=r(w),S=n(7),x=r(S),O=n(8),k=r(O),D=n(5),I=r(D),E=n(6),N=r(E),A=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];a(this,e),this.options=t,this.storage=new y["default"]({appname:t.appname,Sample:t.Sample,Storage:t.Storage,manager:this}),this.onSend=t.onSend,this._attachListeners(),this.synchronising=!1}return i(e,[{key:"get",value:function(e,t,n){this.storage.get(e,t,n)}},{key:"getAll",value:function(e,t){this.storage.getAll(e,t)}},{key:"set",value:function(e,t,n){e.manager=this,this.storage.set(e,t,n)}},{key:"remove",value:function(e,t,n){this.storage.remove(e,t,n)}},{key:"has",value:function(e,t,n){this.storage.has(e,t,n)}},{key:"clear",value:function(e,t){this.storage.clear(e,t)}},{key:"syncAll",value:function(e,t){function n(e){var t=[];e.each(function(e){var n=e.save(null,{remote:!0,timeout:r.timeout}),a=new s["default"].Deferred;n?n.always(function(){a.resolve()}):a.resolve(),t.push(a)});var n=s["default"].when.apply(s["default"],t);n.then(function(){a.resolve(),r.success&&r.success()})}var r=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],a=new s["default"].Deferred;return t?(n(t),a.promise()):(this.getAll(function(e,t){return e?(a.reject(),void(r.error&&r.error(e))):void n(t)}),a.promise())}},{key:"sync",value:function(t,n){var r=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];if(n.getSyncStatus()===I["default"].SYNCED||n.getSyncStatus()===I["default"].SYNCHRONISING)return!1;r.url=n.manager.options.url;var a=r.success;r.success=function(e){e.save().then(function(){e.trigger("sync"),a&&a()})};var i=e.prototype.post.apply(n.manager,[n,r]);return i}},{key:"post",value:function(e,t){var n=e.onSend||this.onSend,r=n&&n(e);if(r)return!1;e.synchronising=!0;var a=t.success;t.success=function(){e.synchronising=!1,e.metadata.warehouse_id=1,e.metadata.server_on=e.metadata.updated_on=e.metadata.synced_on=new Date,a&&a(e,null,t)};var i=t.error;t.error=function(n,r,a){e.synchronising=!1,e.trigger("error"),t.textStatus=r,t.errorThrown=a,i&&i.call(t.context,n,r,a)};var o=new s["default"].Deferred;return this._getModelFormData(e,function(n,r){var a=t.xhr=d["default"].ajax({url:t.url,type:"POST",data:r,processData:!1,contentType:!1,timeout:t.timeout||3e4,success:t.success,error:t.error});a.done(function(e,t,n){o.resolve(e,t,n)}),a.fail(function(e,t,n){o.reject(e,t,n)}),e.trigger("request",e,a,t)}),o.promise()}},{key:"_attachListeners",value:function(){var e=this;this.storage.on("update",function(){e.trigger("update")})}},{key:"_getModelFormData",value:function(e,t){var n=this,r=e.flatten(this._flattener),a=new FormData,i=0,o=[];e.occurrences.each(function(e){var t=i,n=0,r=[];e.images.each(function(e){function i(e,r,i,s){var u="sc:"+t+"::photo"+n,l=c,d=c;c.match(/image.*/)?l=c.split("/")[1]:d="image/"+d,s||(s=N["default"].dataURItoBlob(i,d)),a.append(u,s,"pic."+l),n++,o.resolve()}var o=new s["default"].Deferred;r.push(o);var u=e.getURL(),c=e.get("type");N["default"].isDataURL(u)?i(null,null,u):!function(){var e=new XMLHttpRequest;e.open("GET",u,!0),e.responseType="blob",e.onload=function(){i(null,null,null,e.response)},e.send()}()}),o.push(s["default"].when.apply(s["default"],r)),i++}),s["default"].when.apply(s["default"],o).then(function(){for(var e=Object.keys(r),i=0;i<e.length;i++)a.append(e[i],r[e[i]]);a=n.appendAuth(a),t(null,a)})}},{key:"_flattener",value:function(t,n){var r=n.flattened||{},a=n.keys||{},i=n.count,o=null,s=null,u=null,l="",d="sample:",f="smpAttr:";this instanceof p["default"]&&(l="sc:",d="::occurrence:",f="::occAttr:");var h=this.cid||this.id;h&&(this instanceof p["default"]?r[l+i+d+"external_key"]=h:r[d+"external_key"]=this.cid||this.id);for(o in t)if(a[o]){if(s=a[o].id,s?(s=parseInt(s,10)>=0?f+s:d+s,l&&(s=l+i+s)):s=l+i+"::present",t[o]){if(u=t[o],a[o].values)if("function"==typeof a[o].values){var v=c["default"].extend(n,{flattener:e.prototype._flattener,flattened:r});u=a[o].values(u,v)}else u=a[o].values[u];u&&(r[s]=u)}}else"email"!==o&&"usersecret"!==o&&console.warn("Morel: no such key: "+o),r[o]=t[o];return r}},{key:"appendAuth",value:function(e){return this._appendAppAuth(e),this._appendWarehouseAuth(e),e}},{key:"_appendAppAuth",value:function(e){return e.append("appname",this.options.appname),e.append("appsecret",this.options.appsecret),e}},{key:"_appendWarehouseAuth",value:function(e){return e.append("website_id",this.options.website_id),e.append("survey_id",this.options.survey_id),e}}]),e}();c["default"].extend(A.prototype,d["default"].Events),c["default"].extend(A,I["default"],{VERSION:"3.1.3",Sample:h["default"],Occurrence:p["default"],DatabaseStorage:b["default"],LocalStorage:_["default"],Image:x["default"],Error:k["default"]}),t["default"]=A},function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){e.exports=n},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},i=n(1),o=r(i),s=n(3),u=r(s),c=n(2),l=r(c),d=n(5),f=r(d),h=n(6),v=r(h),p=n(7),g=r(p),y=n(9),m=r(y),b=n(10),w=r(b),_=u["default"].Model.extend({Image:g["default"],Occurrence:m["default"],constructor:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=this,a=t,i={date:new Date,location_type:"latlon"};if(a=l["default"].extend(i,a),this.cid=n.cid||n.id||v["default"].getNewUUID(),this.manager=n.manager||this.manager,this.manager&&(this.sync=this.manager.sync),n.Image&&(this.Image=n.Image),n.Occurrence&&(this.Occurrence=n.Occurrence),n.onSend&&(this.onSend=n.onSend),this.attributes={},n.collection&&(this.collection=n.collection),n.parse&&(a=this.parse(a,n)||{}),a=l["default"].defaults({},a,l["default"].result(this,"defaults")),this.set(a,n),this.changed={},n.metadata)this.metadata=n.metadata;else{var o=new Date;this.metadata={created_on:o,updated_on:o,warehouse_id:null,synced_on:null,server_on:null}}n.occurrences?!function(){var t=[];l["default"].each(n.occurrences,function(e){if(e instanceof r.Occurrence)e.setSample(r),t.push(e);else{var n=l["default"].extend(e,{sample:r});t.push(new r.Occurrence(e.attributes,n))}}),e.occurrences=new w["default"](t,{model:e.Occurrence})}():this.occurrences=new w["default"]([],{model:this.Occurrence}),n.images?!function(){var t=[];l["default"].each(n.images,function(n){if(n instanceof e.Image)n.setParent(r),t.push(n);else{var a=l["default"].extend(n,{parent:r});t.push(new e.Image(n.attributes,a))}}),e.images=new w["default"](t,{model:e.Image})}():this.images=new w["default"]([],{model:this.Image}),this.initialize.apply(this,arguments)},save:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=this;if(!this.manager)return!1;if(!n.remote){var i=function(){var e=u["default"].$.Deferred();return t.manager.set(t,function(t){return t?(e.reject(t),void(n.error&&n.error(t))):(e.resolve(r,{},n),void(n.success&&n.success(r,{},n)))}),{v:e.promise()}}();if("object"===("undefined"==typeof i?"undefined":a(i)))return i.v}var o=u["default"].Model.prototype.save.apply(this,arguments);return o},destroy:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=new o["default"].Deferred;return this.manager&&!e.noSave?this.manager.remove(this,function(n){return n?void(e.error&&e.error(n)):(t.resolve(),void(e.success&&e.success()))}):(this.stopListening(),this.trigger("destroy",this,this.collection,e),t.resolve(),e.success&&e.success()),t.promise()},addOccurrence:function(e){e&&(e.setSample(this),this.occurrences.push(e))},addImage:function(e){e&&(e.setParent(this),this.images.add(e))},validate:function(e){var t=l["default"].extend({},this.attributes,e),n={},r={};if(t.location||(n.location="can't be blank"),t.location_type||(n.location_type="can't be blank"),t.date){var a=new Date(t.date);("Invalid Date"===a||a>new Date)&&(n.date=new Date(a)>new Date?"future date":"invalid")}else n.date="can't be blank";if(0===this.occurrences.length?n.occurrences="no occurrences":this.occurrences.each(function(e){var t=e.validate();if(t){var n=e.id||e.cid;r[n]=t}}),!l["default"].isEmpty(n)||!l["default"].isEmpty(r)){var i={sample:n,occurrences:r};return i}return null},flatten:function(e){var t=e.apply(this,[this.attributes,{keys:_.keys}]);return l["default"].extend(t,this.occurrences.flatten(e)),t},toJSON:function(){var e=void 0,t=this.occurrences;t?e=t.toJSON():(e=[],console.warn("toJSON occurrences missing"));var n=void 0,r=this.images;r?n=r.toJSON():(n=[],console.warn("toJSON images missing"));var a={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,occurrences:e,images:n};return a},getSyncStatus:function(){var e=this.metadata;return this.synchronising?f["default"].SYNCHRONISING:e.warehouse_id?e.synced_on?e.synced_on<e.updated_on?e.synced_on<e.server_on?f["default"].CONFLICT:f["default"].CHANGED_LOCALLY:e.synced_on<e.server_on?f["default"].CHANGED_SERVER:f["default"].SYNCED:f["default"].SERVER:f["default"].LOCAL},offAll:function(){this._events={},this.occurrences.offAll();for(var e=0;e<this.occurrences.data.length;e++)this.occurrences.models[e].offAll()}});_.keys={id:{id:"id"},survey:{id:"survey_id"},date:{id:"date"},comment:{id:"comment"},image:{id:"image"},location:{id:"entered_sref"},location_type:{id:"entered_sref_system",values:{british:"OSGB",irish:"OSIE",latlon:4326}},location_name:{id:"location_name"},form:{id:"input_form"},group:{id:"group_id"},deleted:{id:"deleted"}},t["default"]=_},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t["default"]={SYNCHRONISING:0,SYNCED:1,LOCAL:2,SERVER:3,CHANGED_LOCALLY:4,CHANGED_SERVER:5,CONFLICT:-1}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},r=function(e){if(null===e||"object"!==("undefined"==typeof e?"undefined":n(e)))return e;var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=objClone(e[r]));return t},a=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"===e?t:3&t|8;return n.toString(16)})},i=function(e,t){for(var n=atob(e.split(",")[1]),r=[],a=0;a<n.length;a++)r.push(n.charCodeAt(a));return new Blob([new Uint8Array(r)],{type:t})},o=function(e){if(!e)return!1;var t=e.toString(),n=/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i;return!!t.match(n)},s=function(e){function t(e){for(var t={},n="Boolean Number String Function Array Date RegExp Object".split(" "),r=0;r<n.length;r++)t["[object "+n[r]+"]"]=n[r].toLowerCase();return null==e?String(e):t[toString.call(e)]||"object"}function r(e){return e&&"object"===("undefined"==typeof e?"undefined":n(e))&&"setInterval"in e}if(!e||"object"!==t(e)||e.nodeType||r(e))return!1;if(e.constructor&&!hasOwn.call(e,"constructor")&&!hasOwn.call(e.constructor.prototype,"isPrototypeOf"))return!1;var a=void 0;for(a in e);return void 0===a||hasOwn.call(e,a)},u=function(e){for(var t in e)return!1;return!0},c=function(e){var t=e,n=new Date,r=0,a=0,i=/\d{2}\/\d{2}\/\d{4}$/,o=/\d{4}-\d{1,2}-\d{1,2}$/,s=/\d{1,2}-\d{1,2}-\d{4}$/,u=[];if("string"==typeof t){if(u=t.split("-"),i.test(t))return t;o.test(t)?t=new Date(window.parseInt(u[0]),window.parseInt(u[1])-1,window.parseInt(u[2])):s.test(t)&&(t=new Date(window.parseInt(u[2]),window.parseInt(u[1])-1,window.parseInt(u[0])))}return n=t||n,r=("0"+n.getDate()).slice(-2),a=("0"+(n.getMonth()+1)).slice(-2),r+"/"+a+"/"+n.getFullYear()};t["default"]={cloneDeep:r,getNewUUID:a,dataURItoBlob:i,isDataURL:o,isPlainObject:s,isEmptyObject:u,formatDate:c}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},i=n(1),o=r(i),s=n(3),u=r(s),c=n(2),l=r(c),d=n(6),f=r(d),h=n(8),v=r(h),p=100,g=100,y=u["default"].Model.extend({constructor:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=e;if("string"==typeof e){var r=e;return void(n={data:r})}this.cid=t.cid||t.id||f["default"].getNewUUID(),this.setParent(t.parent||this.parent),this.attributes={},t.collection&&(this.collection=t.collection),t.parse&&(n=this.parse(n,t)||{}),n=l["default"].defaults({},n,l["default"].result(this,"defaults")),this.set(n,t),this.changed={},t.metadata?this.metadata=t.metadata:this.metadata={created_on:new Date},this.initialize.apply(this,arguments)},save:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return!!this.parent&&this.parent.save(e,t)},destroy:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=new o["default"].Deferred;return this.stopListening(),this.trigger("destroy",this,this.collection,t),this.parent&&!t.noSave?!function(){var r=t.success;t.success=function(){n.resolve(),r&&r()},e.save(null,t)}():(n.resolve(),t.success&&t.success()),n.promise()},getURL:function(){return this.get("data")},setParent:function(e){if(e){var t=this;this.parent=e,this.parent.on("destroy",function(){t.destroy({noSave:!0})})}},resize:function(e,t,n){var r=this;y.resize(this.getURL(),this.get("type"),e,t,function(e,t,a){return e?void(n&&n(e)):(r.set("data",a),void(n&&n(null,t,a)))})},addThumbnail:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=this,r=/^data:/i;return r.test(this.getURL())?void y.resize(this.getURL(),this.get("type"),p||t.width,p||t.width,function(t,r,a){n.set("thumbnail",a),e&&e()}):void y.getDataURI(this.getURL(),function(t,r){n.set("thumbnail",r),e&&e()},{width:p||t.width,height:g||t.height})},toJSON:function(){var e={id:this.id,metadata:this.metadata,attributes:this.attributes};return e}});l["default"].extend(y,{getDataURI:function(e,t){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];if("string"==typeof e){var r=function(){var r=e.replace(/.*\.([a-z]+)$/i,"$1");return"jpg"===r&&(r="jpeg"),y.resize(e,r,n.width,n.height,function(e,n,a){t(null,a,r,n.width,n.height)}),{v:void 0}}();if("object"===("undefined"==typeof r?"undefined":a(r)))return r.v}if(!window.FileReader){var i="No File Reader",o=new v["default"](i);return console.error(i),void t(o)}var s=new FileReader;s.onload=function(r){n.width||n.height?y.resize(r.target.result,e.type,n.width,n.height,function(n,r,a){t(null,a,e.type,r.width,r.height)}):!function(){var n=new window.Image;n.onload=function(){var a=e.type.replace(/.*\/([a-z]+)$/i,"$1");t(null,r.target.result,a,n.width,n.height)},n.src=r.target.result}()},s.readAsDataURL(e)},resize:function(e,t,n,r,a){var i=new window.Image;i.onload=function(){var e=i.width,o=i.height,s=n||e,u=r||o,c=null,l=null;l=e>o?e/s:o/u,e/=l,o/=l,c=document.createElement("canvas"),c.width=e,c.height=o,c.getContext("2d").drawImage(i,0,0,e,o),a(null,i,c.toDataURL(t))},i.src=e}}),t["default"]=y},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function a(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return n(this,a),"string"==typeof e?(this.code=-1,void(this.message=e)):(this.code=e.code||-1,void(this.message=e.message||""))};t["default"]=r},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var a=n(1),i=r(a),o=n(3),s=r(o),u=n(2),c=r(u),l=n(6),d=r(l),f=n(7),h=r(f),v=n(10),p=r(v),g=s["default"].Model.extend({Image:h["default"],constructor:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=this,a=t;this.cid=n.cid||n.id||d["default"].getNewUUID(),this.setSample(n.sample||this.sample),n.Image&&(this.Image=n.Image),this.attributes={},n.collection&&(this.collection=n.collection),n.parse&&(a=this.parse(a,n)||{}),a=c["default"].defaults({},a,c["default"].result(this,"defaults")),this.set(a,n),this.changed={},n.metadata?this.metadata=n.metadata:this.metadata={created_on:new Date},n.images?!function(){var t=[];c["default"].each(n.images,function(n){if(n instanceof e.Image)n.setParent(r),t.push(n);else{var a=c["default"].extend(n,{parent:r});t.push(new e.Image(n.attributes,a))}}),e.images=new p["default"](t,{model:e.Image})}():this.images=new p["default"]([],{model:this.Image}),this.initialize.apply(this,arguments)},save:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return!!this.sample&&this.sample.save(e,t)},destroy:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=new i["default"].Deferred;return this.stopListening(),this.trigger("destroy",this,this.collection,t),this.sample&&!t.noSave?!function(){var r=t.success;t.success=function(){n.resolve(),r&&r()},e.save(null,t)}():(n.resolve(),t.success&&t.success()),n.promise()},setSample:function(e){if(e){var t=this;this.sample=e,this.sample.on("destroy",function(){t.destroy({noSave:!0})})}},addImage:function(e){e&&(e.setParent(this),this.images.add(e))},validate:function(e){var t=c["default"].extend({},this.attributes,e),n={};return t.taxon||(n.taxon="can't be blank"),c["default"].isEmpty(n)?null:n},toJSON:function(){var e=void 0,t=this.images;t?e=t.toJSON():(e=[],console.warn("toJSON images missing"));var n={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,images:e};return n},flatten:function(e,t){return e.apply(this,[this.attributes,{keys:g.keys,count:t}])}});g.keys={taxon:{id:""},comment:{id:"comment"}},t["default"]=g},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var a=n(3),i=r(a),o=n(2),s=r(o),u=i["default"].Collection.extend({flatten:function(e){for(var t={},n=0;n<this.length;n++)s["default"].extend(t,this.models[n].flatten(e,n));return t},comparator:function(e){return e.metadata.created_on}});t["default"]=u},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=n(2),u=r(s),c=n(3),l=r(c),d=n(8),f=r(d),h=n(4),v=r(h),p=n(10),g=r(p),y=n(12),m=r(y),b=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];a(this,e);var n=this;this.Sample=t.Sample||v["default"],this.manager=t.manager,this.Storage=t.Storage||m["default"],this.storage=new this.Storage({appname:t.appname}),this.cache={},this.initialized=!1,this.storage.getAll(function(e,t){t||(t={});for(var r=[],a=null,i=Object.keys(t),o=0;o<i.length;o++){var s=t[i[o]],c=u["default"].extend(s,{manager:n.manager});a=new n.Sample(s.attributes,c),r.push(a)}n.cache=new g["default"](r,{model:n.Sample}),n._attachListeners(),n.initialized=!0,n.trigger("init")})}return o(e,[{key:"get",value:function(e,t){var n=this,r=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],a=this;if(!this.initialized)return void this.on("init",function(){n.get(e,t,r)});var o="object"===("undefined"==typeof e?"undefined":i(e))?e.id||e.cid:e;return r.nonCached?void this.storage.get(o,function(e,n){if(e)return void t(e);var r=u["default"].extend(n,{manager:a.manager}),i=new a.Sample(n.attributes,r);t(null,i)}):void t(null,this.cache.get(o))}},{key:"getAll",value:function(e){var t=this;return this.initialized?void e(null,this.cache):void this.on("init",function(){t.getAll(e)})}},{key:"set",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=arguments[1];if(!t.id&&!t.cid){var r=new f["default"]("Invalid model passed to storage");return void n(r)}if(!this.initialized)return void this.on("init",function(){e.set(t,n)});var a=this,i=t.id||t.cid;this.storage.set(i,t,function(e){return e?void(n&&n(e)):(a.cache.set(t,{remove:!1}),void(n&&n(null,t)))})}},{key:"remove",value:function(e,t){var n=this;if(!this.initialized)return void this.on("init",function(){n.remove(e,t)});var r="object"===("undefined"==typeof e?"undefined":i(e))?e.id||e.cid:e;this.storage.remove(r,function(n){return n?void(t&&t(n)):(delete e.manager,void e.destroy().then(t))})}},{key:"has",value:function(e,t){var n=this;return this.initialized?void this.get(e,function(e,n){var r="object"===("undefined"==typeof n?"undefined":i(n));t(null,r)}):void this.on("init",function(){n.has(e,t)},this)}},{key:"clear",value:function(e){var t=this;if(!this.initialized)return void this.on("init",function(){t.clear(e)});var n=this;this.storage.clear(function(t){return t?void(e&&e(t)):(n.cache.reset(),void(e&&e()))})}},{key:"size",value:function(e){this.storage.size(e)}},{key:"_attachListeners",value:function(){var e=this;this.cache.on("update",function(){e.trigger("update")})}}]),e}();u["default"].extend(b.prototype,l["default"].Events),t["default"]=b},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(8),s=r(o),u=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];a(this,e),this.TYPE="LocalStorage",this.NAME="morel",this.storage=window.localStorage,this.NAME=t.appname?this.NAME+"-"+t.appname:this.NAME}return i(e,[{key:"get",value:function(e,t){var n=this.storage.getItem(this._getKey(e));n=JSON.parse(n),t(null,n)}},{key:"getAll",value:function(e){for(var t={},n="",r=0,a=this.storage.length;r<a;++r)if(n=this.storage.key(r),n.indexOf(this._getPrefix())!==-1){var i=JSON.parse(this.storage.getItem(n));t[n]=i}e(null,t)}},{key:"set",value:function(e,t,n){var r=JSON.stringify(t);try{this.storage.setItem(this._getKey(e),r),n&&n(null,r)}catch(a){var i=this._isQuotaExceeded(a),o=i?"Storage exceed.":a.message;n&&n(new s["default"](o),r)}}},{key:"remove",value:function(e,t){this.storage.removeItem(this._getKey(e)),t&&t()}},{key:"has",value:function(e,t){this.get(e,function(e,n){t(null,void 0!==n&&null!==n)})}},{key:"clear",value:function(e){this.storage.clear(),e&&e()}},{key:"size",value:function(e){e(null,this.storage.length)}},{key:"hasSpace",value:function(e,t){var n=JSON.stringify(this.storage).length,r=5242880-n;r-e>0?t(null,1):t(null,0)}},{key:"_getKey",value:function(e){return this._getPrefix()+e}},{key:"_getPrefix",value:function(){return this.NAME+"-"}},{key:"_isQuotaExceeded",value:function(e){var t=!1;if(e)if(e.code)switch(e.code){case 22:t=!0;break;case 1014:"NS_ERROR_DOM_QUOTA_REACHED"===e.name&&(t=!0)}else e.number===-2147024882&&(t=!0);return t}}]),e}();t["default"]=u},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(8),s=r(o),u=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];a(this,e),this.indexedDB=window._indexedDB||window.indexedDB,this.IDBKeyRange=window._IDBKeyRange||window.IDBKeyRange,this.VERSION=1,this.TYPE="DatabaseStorage",this.NAME="morel",this.STORE_NAME="samples",this.NAME=t.appname?this.NAME+"-"+t.appname:this.NAME}return i(e,[{key:"set",value:function(e,t,n){this.open(function(r,a){if(r)return void(n&&n(r));try{!function(){var r="function"==typeof t.toJSON?t.toJSON():t,i=a.put(r,e);i.onsuccess=function(){n&&n(null,r)},i.onerror=function(e){console.error("Database error."),console.error(e.target.error);var t=new s["default"](e.target.error);n&&n(t)}}()}catch(r){n&&n(r)}})}},{key:"get",value:function(e,t){this.open(function(n,r){if(n)return void t(n);try{var a=r.index("id").get(e);a.onsuccess=function(e){var n=e.target.result;t(null,n)},a.onerror=function(e){console.error("Database error."),console.error(e.target.error);var n=new s["default"](e.target.error);t(n)}}catch(n){t&&t(n)}})}},{key:"remove",value:function(e,t){var n=this;this.open(function(r,a){if(r)return void(t&&t(r));try{!function(){var r=a.openCursor(n.IDBKeyRange.only(e));r.onsuccess=function(){try{var e=r.result;e?(a["delete"](e.primaryKey),e["continue"]()):t&&t()}catch(n){t&&t(n)}},r.onerror=function(e){console.error("Database error."),console.error(e.target.error);var n=new s["default"](e.target.error);t&&t(n)}}()}catch(r){t&&t(r)}})}},{key:"getAll",value:function(e){var t=this;this.open(function(n,r){if(n)return void e(n);try{!function(){var n=t.IDBKeyRange.lowerBound(0),a=r.openCursor(n),i={};a.onsuccess=function(t){try{var n=t.target.result;n?(i[n.key]=n.value,n["continue"]()):e(null,i)}catch(r){e&&e(r)}},a.onerror=function(t){console.error("Database error."),console.error(t.target.error);var n=new s["default"](t.target.error);e(n)}}()}catch(n){e&&e(n)}})}},{key:"has",value:function(e,t){this.get(e,function(e,n){return e?void t(e):void t(null,void 0!==n&&null!==n)})}},{key:"clear",value:function(e){this.open(function(t,n){if(t)return void(e&&e(t));try{var r=n.clear();r.onsuccess=function(){e&&e()},r.onerror=function(t){console.error("Database error."),console.error(t.target.error);var n=new s["default"](t.target.error);e&&e(n)}}catch(t){e&&e(t)}})}},{key:"size",value:function(e){this.getAll(function(t,n){if(t)return void e(t);var r=Object.keys(n).length;e(null,r)})}},{key:"open",value:function(e){var t=this,n=null;try{n=this.indexedDB.open(this.NAME,this.VERSION),n.onsuccess=function(n){try{var r=n.target.result,a=r.transaction([t.STORE_NAME],"readwrite");if(a){var i=a.objectStore(t.STORE_NAME);if(i)e(null,i);else{var o=new s["default"]("Database Problem: no such store");e(o)}}}catch(o){e(o)}},n.onupgradeneeded=function(n){try{var r=n.target.result;r.createObjectStore(t.STORE_NAME)}catch(a){e&&e(a)}},n.onerror=function(t){console.error("Database error."),console.error(t.target.error);var n=new s["default"](t.target.error);e(n)},n.onblocked=function(t){console.error("Database error."),console.error(t.target.error);var n=new s["default"](t.target.error);e(n)}}catch(r){e(r)}}}]),e}();t["default"]=u}])});