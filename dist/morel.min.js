/*!
 * 
 * morel 3.2.0
 * Mobile Recording Library for biological data collection.
 * https://github.com/NERC-CEH/morel
 * Author Karolis Kazlauskis
 * Released under the GNU GPL v3 license.
 * http://www.gnu.org/licenses/gpl.html
 * 
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("underscore"),require("backbone"),require("jquery"),require("localforage")):"function"==typeof define&&define.amd?define("Morel",["_","Backbone","$","localforage"],t):"object"==typeof exports?exports.Morel=t(require("underscore"),require("backbone"),require("jquery"),require("localforage")):e.Morel=t(e._,e.Backbone,e.$,e.localforage)}(this,function(e,t,n,i){return function(e){function t(i){if(n[i])return n[i].exports;var r=n[i]={exports:{},id:i,loaded:!1};return e[i].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=n(1),s=i(o),u=n(2),c=i(u),d=n(3),l=i(d),f=n(9),h=i(f),v=n(11),p=i(v),m=n(6),g=i(m),y=n(8),b=i(y),w=n(4),_=i(w),S=n(5),x=i(S),O=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r(this,e),this.options=t,t.manager=this,this.storage=new p.default(t),this.onSend=t.onSend,this._attachListeners(),this.synchronising=!1}return a(e,[{key:"get",value:function(e,t,n){this.storage.get(e,t,n)}},{key:"getAll",value:function(e,t){this.storage.getAll(e,t)}},{key:"set",value:function(e,t,n){e.manager=this,this.storage.set(e,t,n)}},{key:"remove",value:function(e,t,n){this.storage.remove(e,t,n)}},{key:"has",value:function(e,t,n){this.storage.has(e,t,n)}},{key:"clear",value:function(e,t){this.storage.clear(e,t)}},{key:"syncAll",value:function(e,t){function n(e){var t=[];e.each(function(e){var n=e.save(null,{remote:!0,timeout:i.timeout}),r=void 0;r=n?new Promise(function(e){n.then(function(){e()}).catch(function(){e()})}):Promise.resolve(),t.push(r)}),Promise.all(t).then(function(){r(),i.success&&i.success()})}var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=void 0,a=void 0,o=new Promise(function(e,t){r=e,a=t});return t?(n(t),o):(this.getAll(function(e,t){return e?(a(),void(i.error&&i.error(e))):void n(t)}),o)}},{key:"sync",value:function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(n.getSyncStatus()===_.default.SYNCED||n.getSyncStatus()===_.default.SYNCHRONISING)return!1;i.url=n.manager.options.url;var r=i.success;i.success=function(e){e.save().then(function(){e.trigger("sync"),r&&r()})};var a=e.prototype.post.apply(n.manager,[n,i]);return a}},{key:"post",value:function(e,t){var n=this,i=e.onSend||this.onSend,r=i&&i(e);if(r)return!1;e.synchronising=!0;var a=t.success;t.success=function(){e.synchronising=!1,e.metadata.warehouse_id=1,e.metadata.server_on=e.metadata.updated_on=e.metadata.synced_on=new Date,a&&a(e,null,t)};var o=t.error;t.error=function(n,i,r){e.synchronising=!1,e.trigger("error"),t.textStatus=i,t.errorThrown=r,o&&o.call(t.context,n,i,r)};var s=new Promise(function(i,r){n._getModelFormData(e,function(n,a){var o=t.xhr=c.default.ajax({url:t.url,type:"POST",data:a,processData:!1,contentType:!1,timeout:t.timeout||3e4,success:t.success,error:t.error});o.done(function(e,t,n){i(e,t,n)}),o.fail(function(e,t,n){r(e,t,n)}),e.trigger("request",e,o,t)})});return s}},{key:"_attachListeners",value:function(){var e=this;this.storage.on("update",function(){e.trigger("update")})}},{key:"_getModelFormData",value:function(e,t){var n=this,i=e.flatten(this._flattener),r=new FormData,a=0,o=[];e.occurrences.each(function(e){var t=a,n=0,i=[];e.images.each(function(e){function a(e,i,a,s){var u="sc:"+t+"::photo"+n,d=c,l=c;c.match(/image.*/)?d=c.split("/")[1]:l="image/"+l,s||(s=x.default.dataURItoBlob(a,l)),r.append(u,s,"pic."+d),n++,o()}var o=void 0,s=new Promise(function(e){o=e});i.push(s);var u=e.getURL(),c=e.get("type");x.default.isDataURL(u)?a(null,null,u):!function(){var e=new XMLHttpRequest;e.open("GET",u,!0),e.responseType="blob",e.onload=function(){a(null,null,null,e.response)},e.send()}()}),o.push(Promise.all(i)),a++}),Promise.all(o).then(function(){for(var e=Object.keys(i),a=0;a<e.length;a++)r.append(e[a],i[e[a]]);r=n.appendAuth(r),t(null,r)})}},{key:"_flattener",value:function(t,n){var i=n.flattened||{},r=n.keys||{},a=n.count,o=null,u=null,c=null,d="",l="sample:",f="smpAttr:";this instanceof h.default&&(d="sc:",l="::occurrence:",f="::occAttr:");var v=this.cid||this.id;v&&(this instanceof h.default?i[d+a+l+"external_key"]=v:i[l+"external_key"]=this.cid||this.id);for(o in t)if(r[o]){if(u=r[o].id,u?(u=parseInt(u,10)>=0?f+u:l+u,d&&(u=d+a+u)):u=d+a+"::present",t[o]){if(c=t[o],r[o].values)if("function"==typeof r[o].values){var p=s.default.extend(n,{flattener:e.prototype._flattener,flattened:i});c=r[o].values(c,p)}else c=r[o].values[c];c&&(i[u]=c)}}else"email"!==o&&"usersecret"!==o&&console.warn("Morel: no such key: "+o),i[o]=t[o];return i}},{key:"appendAuth",value:function(e){return this._appendAppAuth(e),this._appendWarehouseAuth(e),e}},{key:"_appendAppAuth",value:function(e){return e.append("appname",this.options.appname),e.append("appsecret",this.options.appsecret),e}},{key:"_appendWarehouseAuth",value:function(e){return e.append("website_id",this.options.website_id),e.append("survey_id",this.options.survey_id),e}}]),e}();s.default.extend(O.prototype,c.default.Events),s.default.extend(O,_.default,{VERSION:"3.2.0",Sample:l.default,Occurrence:h.default,Image:g.default,Error:b.default}),t.default=O},function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=n(2),o=i(a),s=n(1),u=i(s),c=n(4),d=i(c),l=n(5),f=i(l),h=n(6),v=i(h),p=n(9),m=i(p),g=n(10),y=i(g),b=o.default.Model.extend({Image:v.default,Occurrence:m.default,constructor:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this,r=t,a={date:new Date,location_type:"latlon"};if(r=u.default.extend(a,r),this.cid=n.cid||n.id||f.default.getNewUUID(),this.manager=n.manager||this.manager,this.manager&&(this.sync=this.manager.sync),n.Image&&(this.Image=n.Image),n.Occurrence&&(this.Occurrence=n.Occurrence),n.onSend&&(this.onSend=n.onSend),this.attributes={},n.collection&&(this.collection=n.collection),n.parse&&(r=this.parse(r,n)||{}),r=u.default.defaults({},r,u.default.result(this,"defaults")),this.set(r,n),this.changed={},n.metadata)this.metadata=n.metadata;else{var o=new Date;this.metadata={created_on:o,updated_on:o,warehouse_id:null,synced_on:null,server_on:null}}n.occurrences?!function(){var t=[];u.default.each(n.occurrences,function(e){if(e instanceof i.Occurrence)e.setSample(i),t.push(e);else{var n=u.default.extend(e,{sample:i});t.push(new i.Occurrence(e.attributes,n))}}),e.occurrences=new y.default(t,{model:e.Occurrence})}():this.occurrences=new y.default([],{model:this.Occurrence}),n.images?!function(){var t=[];u.default.each(n.images,function(n){if(n instanceof e.Image)n.setParent(i),t.push(n);else{var r=u.default.extend(n,{parent:i});t.push(new e.Image(n.attributes,r))}}),e.images=new y.default(t,{model:e.Image})}():this.images=new y.default([],{model:this.Image}),this.initialize.apply(this,arguments)},save:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this,a=void 0;if(!this.manager)return!1;if(!n.remote){var s=function(){var e=void 0,r=void 0;return a=new Promise(function(t,n){e=t,r=n}),t.manager.set(t,function(t){return t?(r(t),void(n.error&&n.error(t))):(e(i,{},n),void(n.success&&n.success(i,{},n)))}),{v:a}}();if("object"===("undefined"==typeof s?"undefined":r(s)))return s.v}return a=o.default.Model.prototype.save.apply(this,arguments)},destroy:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=void 0,n=new Promise(function(e){t=e});return this.manager&&!e.noSave?this.manager.remove(this,function(n){return n?void(e.error&&e.error(n)):(t(),void(e.success&&e.success()))}):(this.stopListening(),this.trigger("destroy",this,this.collection,e),t(),e.success&&e.success()),n},addOccurrence:function(e){e&&(e.setSample(this),this.occurrences.push(e))},addImage:function(e){e&&(e.setParent(this),this.images.add(e))},validate:function(e){var t=u.default.extend({},this.attributes,e),n={},i={};if(t.location||(n.location="can't be blank"),t.location_type||(n.location_type="can't be blank"),t.date){var r=new Date(t.date);("Invalid Date"===r||r>new Date)&&(n.date=new Date(r)>new Date?"future date":"invalid")}else n.date="can't be blank";if(0===this.occurrences.length?n.occurrences="no occurrences":this.occurrences.each(function(e){var t=e.validate();if(t){var n=e.id||e.cid;i[n]=t}}),!u.default.isEmpty(n)||!u.default.isEmpty(i)){var a={sample:n,occurrences:i};return a}return null},flatten:function(e){var t=e.apply(this,[this.attributes,{keys:b.keys}]);return u.default.extend(t,this.occurrences.flatten(e)),t},toJSON:function(){var e=void 0,t=this.occurrences;t?e=t.toJSON():(e=[],console.warn("toJSON occurrences missing"));var n=void 0,i=this.images;i?n=i.toJSON():(n=[],console.warn("toJSON images missing"));var r={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,occurrences:e,images:n};return r},getSyncStatus:function(){var e=this.metadata;return this.synchronising?d.default.SYNCHRONISING:e.warehouse_id?e.synced_on?e.synced_on<e.updated_on?e.synced_on<e.server_on?d.default.CONFLICT:d.default.CHANGED_LOCALLY:e.synced_on<e.server_on?d.default.CHANGED_SERVER:d.default.SYNCED:d.default.SERVER:d.default.LOCAL},offAll:function(){this._events={},this.occurrences.offAll();for(var e=0;e<this.occurrences.data.length;e++)this.occurrences.models[e].offAll()}});b.keys={id:{id:"id"},survey:{id:"survey_id"},date:{id:"date"},comment:{id:"comment"},image:{id:"image"},location:{id:"entered_sref"},location_type:{id:"entered_sref_system",values:{british:"OSGB",irish:"OSIE",latlon:4326}},location_name:{id:"location_name"},form:{id:"input_form"},group:{id:"group_id"},deleted:{id:"deleted"}},t.default=b},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={SYNCHRONISING:0,SYNCED:1,LOCAL:2,SERVER:3,CHANGED_LOCALLY:4,CHANGED_SERVER:5,CONFLICT:-1}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(e){if(null===e||"object"!==("undefined"==typeof e?"undefined":n(e)))return e;var t={};for(var i in e)e.hasOwnProperty(i)&&(t[i]=objClone(e[i]));return t},r=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"===e?t:3&t|8;return n.toString(16)})},a=function(e,t){for(var n=atob(e.split(",")[1]),i=[],r=0;r<n.length;r++)i.push(n.charCodeAt(r));return new Blob([new Uint8Array(i)],{type:t})},o=function(e){if(!e)return!1;var t=e.toString(),n=/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i;return!!t.match(n)},s=function(e){function t(e){for(var t={},n="Boolean Number String Function Array Date RegExp Object".split(" "),i=0;i<n.length;i++)t["[object "+n[i]+"]"]=n[i].toLowerCase();return null==e?String(e):t[toString.call(e)]||"object"}function i(e){return e&&"object"===("undefined"==typeof e?"undefined":n(e))&&"setInterval"in e}if(!e||"object"!==t(e)||e.nodeType||i(e))return!1;if(e.constructor&&!hasOwn.call(e,"constructor")&&!hasOwn.call(e.constructor.prototype,"isPrototypeOf"))return!1;var r=void 0;for(r in e);return void 0===r||hasOwn.call(e,r)},u=function(e){for(var t in e)return!1;return!0},c=function(e){var t=e,n=new Date,i=0,r=0,a=/\d{2}\/\d{2}\/\d{4}$/,o=/\d{4}-\d{1,2}-\d{1,2}$/,s=/\d{1,2}-\d{1,2}-\d{4}$/,u=[];if("string"==typeof t){if(u=t.split("-"),a.test(t))return t;o.test(t)?t=new Date(window.parseInt(u[0]),window.parseInt(u[1])-1,window.parseInt(u[2])):s.test(t)&&(t=new Date(window.parseInt(u[2]),window.parseInt(u[1])-1,window.parseInt(u[0])))}return n=t||n,i=("0"+n.getDate()).slice(-2),r=("0"+(n.getMonth()+1)).slice(-2),i+"/"+r+"/"+n.getFullYear()};t.default={cloneDeep:i,getNewUUID:r,dataURItoBlob:a,isDataURL:o,isPlainObject:s,isEmptyObject:u,formatDate:c}},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=n(7),o=(i(a),n(2)),s=i(o),u=n(1),c=i(u),d=n(5),l=i(d),f=n(8),h=i(f),v=100,p=100,m=s.default.Model.extend({constructor:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e;if("string"==typeof e){var i=e;return void(n={data:i})}this.cid=t.cid||t.id||l.default.getNewUUID(),this.setParent(t.parent||this.parent),this.attributes={},t.collection&&(this.collection=t.collection),t.parse&&(n=this.parse(n,t)||{}),n=c.default.defaults({},n,c.default.result(this,"defaults")),this.set(n,t),this.changed={},t.metadata?this.metadata=t.metadata:this.metadata={created_on:new Date},this.initialize.apply(this,arguments)},save:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return!!this.parent&&this.parent.save(e,t)},destroy:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=void 0,i=new Promise(function(e){n=e});return this.stopListening(),this.trigger("destroy",this,this.collection,t),this.parent&&!t.noSave?!function(){var i=t.success;t.success=function(){n(),i&&i()},e.save(null,t)}():(n(),t.success&&t.success()),i},getURL:function(){return this.get("data")},setParent:function(e){if(e){var t=this;this.parent=e,this.parent.on("destroy",function(){t.destroy({noSave:!0})})}},resize:function(e,t,n){var i=this;m.resize(this.getURL(),this.get("type"),e,t,function(e,t,r){return e?void(n&&n(e)):(i.set("data",r),void(n&&n(null,t,r)))})},addThumbnail:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this,i=/^data:/i;return i.test(this.getURL())?void m.resize(this.getURL(),this.get("type"),v||t.width,v||t.width,function(t,i,r){n.set("thumbnail",r),e&&e()}):void m.getDataURI(this.getURL(),function(t,i){n.set("thumbnail",i),e&&e()},{width:v||t.width,height:p||t.height})},toJSON:function(){var e={id:this.id,metadata:this.metadata,attributes:this.attributes};return e}});c.default.extend(m,{getDataURI:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if("string"==typeof e){var i=function(){var i=e.replace(/.*\.([a-z]+)$/i,"$1");return"jpg"===i&&(i="jpeg"),m.resize(e,i,n.width,n.height,function(e,n,r){t(null,r,i,n.width,n.height)}),{v:void 0}}();if("object"===("undefined"==typeof i?"undefined":r(i)))return i.v}if(!window.FileReader){var a="No File Reader",o=new h.default(a);return console.error(a),void t(o)}var s=new FileReader;s.onload=function(i){n.width||n.height?m.resize(i.target.result,e.type,n.width,n.height,function(n,i,r){t(null,r,e.type,i.width,i.height)}):!function(){var n=new window.Image;n.onload=function(){var r=e.type.replace(/.*\/([a-z]+)$/i,"$1");t(null,i.target.result,r,n.width,n.height)},n.src=i.target.result}()},s.readAsDataURL(e)},resize:function(e,t,n,i,r){var a=new window.Image;a.onload=function(){var e=a.width,o=a.height,s=n||e,u=i||o,c=null,d=null;d=e>o?e/s:o/u,e/=d,o/=d,c=document.createElement("canvas"),c.width=e,c.height=o,c.getContext("2d").drawImage(a,0,0,e,o),r(null,a,c.toDataURL(t))},a.src=e}}),t.default=m},function(e,t){e.exports=n},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return n(this,e),"string"==typeof t?(this.code=-1,void(this.message=t)):(this.code=t.code||-1,void(this.message=t.message||""))};t.default=i},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=n(7),a=(i(r),n(2)),o=i(a),s=n(1),u=i(s),c=n(5),d=i(c),l=n(6),f=i(l),h=n(10),v=i(h),p=o.default.Model.extend({Image:f.default,constructor:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this,r=t;this.cid=n.cid||n.id||d.default.getNewUUID(),this.setSample(n.sample||this.sample),n.Image&&(this.Image=n.Image),this.attributes={},n.collection&&(this.collection=n.collection),n.parse&&(r=this.parse(r,n)||{}),r=u.default.defaults({},r,u.default.result(this,"defaults")),this.set(r,n),this.changed={},n.metadata?this.metadata=n.metadata:this.metadata={created_on:new Date},n.images?!function(){var t=[];u.default.each(n.images,function(n){if(n instanceof e.Image)n.setParent(i),t.push(n);else{var r=u.default.extend(n,{parent:i});t.push(new e.Image(n.attributes,r))}}),e.images=new v.default(t,{model:e.Image})}():this.images=new v.default([],{model:this.Image}),this.initialize.apply(this,arguments)},save:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return!!this.sample&&this.sample.save(e,t)},destroy:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=void 0,i=new Promise(function(e){n=e});return this.stopListening(),this.trigger("destroy",this,this.collection,t),this.sample&&!t.noSave?!function(){var i=t.success;t.success=function(){n(),i&&i()},e.save(null,t)}():(n(),t.success&&t.success()),i},setSample:function(e){if(e){var t=this;this.sample=e,this.sample.on("destroy",function(){t.destroy({noSave:!0})})}},addImage:function(e){e&&(e.setParent(this),this.images.add(e))},validate:function(e){var t=u.default.extend({},this.attributes,e),n={};return t.taxon||(n.taxon="can't be blank"),u.default.isEmpty(n)?null:n},toJSON:function(){var e=void 0,t=this.images;t?e=t.toJSON():(e=[],console.warn("toJSON images missing"));var n={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,images:e};return n},flatten:function(e,t){return e.apply(this,[this.attributes,{keys:p.keys,count:t}])}});p.keys={taxon:{id:""},comment:{id:"comment"}},t.default=p},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=n(2),a=i(r),o=n(1),s=i(o),u=a.default.Collection.extend({flatten:function(e){for(var t={},n=0;n<this.length;n++)s.default.extend(t,this.models[n].flatten(e,n));return t},comparator:function(e){return e.metadata.created_on}});t.default=u},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=n(1),u=i(s),c=n(2),d=i(c),l=n(12),f=i(l),h=n(8),v=i(h),p=n(3),m=i(p),g=n(10),y=i(g),b=function(){function e(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r(this,e);var i=this;this._initialized=!1,this.Sample=n.Sample||m.default,this.manager=n.manager;var o=n.storage||{};this.db=null;var s=new Promise(function(e,t){var n=new Promise(function(e,t){o.driverOrder&&"object"===a(o.driverOrder[0])?f.default.defineDriver(o.driverOrder[0]).then(e):e()});n.then(function(){var n={name:o.name||"morel",storeName:o.storeName||"records"};o.version&&(n.version=o.version);var r=o.driverOrder||["indexeddb","websql","localstorage"],a=i._getDriverOrder(r),s=o.LocalForage||f.default;i.db=s.createInstance(n),i.db.setDriver(a).then(function(){e(i.db)}).catch(function(e){return t(e)})})});this._cache={},s.then(function(){var e=[];t.db.iterate(function(t,n){var r=u.default.extend(t,{manager:i.manager}),a=new i.Sample(t.attributes,r);e.push(a)}).then(function(){i._cache=new y.default(e,{model:i.Sample}),i._attachListeners(),i._initialized=!0,i.trigger("init")})})}return o(e,[{key:"_getDriverOrder",value:function(e){return e.map(function(e){switch(e){case"indexeddb":return f.default.INDEXEDDB;case"websql":return f.default.WEBSQL;case"localstorage":return f.default.LOCALSTORAGE;default:return"object"===("undefined"==typeof e?"undefined":a(e))&&e._driver?e._driver:console.error("No such db driver!")}})}},{key:"ready",value:function(){return this._initialized}},{key:"get",value:function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=this;if(!this.ready())return void this.on("init",function(){n.get(e,t,i)});var o="object"===("undefined"==typeof e?"undefined":a(e))?e.id||e.cid:e;return i.nonCached?void this.db.getItem(o,function(e,n){if(e)return void t(e);var i=u.default.extend(n,{manager:r.manager}),a=new r.Sample(n.attributes,i);t(null,a)}):void t(null,this._cache.get(o))}},{key:"getAll",value:function(e){var t=this;return this.ready()?void e(null,this._cache):void this.on("init",function(){t.getAll(e)})}},{key:"set",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];if(!t.id&&!t.cid){var i=new v.default("Invalid model passed to storage");return void n(i)}if(!this.ready())return void this.on("init",function(){e.set(t,n)});var r=this,a=t.id||t.cid,o="function"==typeof t.toJSON?t.toJSON():t;this.db.setItem(a,o,function(e){return e?void(n&&n(e)):(r._cache.set(t,{remove:!1}),void(n&&n(null,t)))})}},{key:"remove",value:function(e,t){var n=this;if(!this.ready())return void this.on("init",function(){n.remove(e,t)});var i="object"===("undefined"==typeof e?"undefined":a(e))?e.id||e.cid:e;this.db.removeItem(i,function(n){return n?void(t&&t(n)):(delete e.manager,void e.destroy().then(t))})}},{key:"has",value:function(e,t){var n=this;return this.ready()?void this.get(e,function(e,n){var i="object"===("undefined"==typeof n?"undefined":a(n));t(null,i)}):void this.on("init",function(){n.has(e,t)},this)}},{key:"clear",value:function(e){var t=this;if(!this.ready())return void this.on("init",function(){t.clear(e)});var n=this;this.db.clear(function(t){return t?void(e&&e(t)):(n._cache.reset(),void(e&&e()))})}},{key:"size",value:function(e){this.db.length(e)}},{key:"_attachListeners",value:function(){var e=this;this._cache.on("update",function(){e.trigger("update")})}}]),e}();u.default.extend(b.prototype,d.default.Events),t.default=b},function(e,t){e.exports=i}])});