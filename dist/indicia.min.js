/*!
 * 
 * indicia 4.2.0
 * Indicia JavaScript SDK.
 * https://github.com/Indicia-Team/indicia-js
 * Author Karolis Kazlauskis
 * Released under the GNU GPL v3 license.
 * http://www.gnu.org/licenses/gpl.html
 * 
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("underscore"),require("backbone"),require("localforage"),require("jquery")):"function"==typeof define&&define.amd?define("Indicia",["_","Backbone","localforage","$"],t):"object"==typeof exports?exports.Indicia=t(require("underscore"),require("backbone"),require("localforage"),require("jquery")):e.Indicia=t(e._,e.Backbone,e.localforage,e.$)}(this,function(e,t,n,r){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function i(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=n(1),o=i(a),s=n(2),u=i(s),c=n(5),d=i(c),l=n(6),f=i(l),h=n(12),m=i(h),p=n(11),v=i(p),y=n(13),g=i(y),_=n(8),b=r(_),w={VERSION:"4.2.0",Store:u.default,Collection:d.default,Sample:f.default,Occurrence:m.default,Media:v.default,Report:g.default};o.default.extend(w,b),t.default=w},function(t,n){t.exports=e},function(e,t,n){(function(e){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=n(3),u=r(s),c=n(4),d=r(c),l=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,t);var n=this;this.localForage=null,this.ready=new Promise(function(r,i){var o=new Promise(function(t){e.driverOrder&&"object"===a(e.driverOrder[0])?d.default.defineDriver(e.driverOrder[0]).then(t):t()});o.then(function(){var a={name:e.name||"indicia",storeName:e.storeName||"models"};e.version&&(a.version=e.version);var o=e.driverOrder||["indexeddb","websql","localstorage"],s=t._getDriverOrder(o),u=e.LocalForage||d.default;n.localForage=u.createInstance(a),n.localForage.setDriver(s).then(function(){r(n.localForage)}).catch(i)})})}return o(t,[{key:"sync",value:function(e,t,n){switch(e){case"read":return t.cid?this.find(t,n):this.findAll(t,n);case"create":return this.create(t,n);case"update":return this.update(t,n);case"delete":return this.destroy(t,n);default:return Promise.reject(new Error("Local Sync method not found "+e))}}},{key:"save",value:function(t,n){var r=this;return this._callWhenReady(function(){if(t instanceof u.default.Collection){var i=function(){if(!t.models.length)return{v:Promise.resolve()};var r=[];return e.each(t.models,function(e){e.store&&r.push(e.save(null,n))}),{v:Promise.all(r)}}();if("object"===("undefined"==typeof i?"undefined":a(i)))return i.v}if(!t.id&&!t.cid)return Promise.reject(new Error("Invalid model passed to store"));var o=t.cid;return r.localForage.setItem(o,t.toJSON()).then(function(){return Promise.resolve()})})}},{key:"create",value:function(e,t){return this.update(e,t)}},{key:"update",value:function(e,t){return this.save(e,t)}},{key:"find",value:function(e){var t=this;return this._callWhenReady(function(){return t.localForage.getItem(e.cid).then(function(t){return t?t:Promise.reject("LocalForage entry with "+e.cid+" as key not found")})})}},{key:"findAll",value:function(){var e=this;return this._callWhenReady(function(){var t=[];return e.localForage.iterate(function(e){t.push(e)}).then(function(){return Promise.resolve(t)})})}},{key:"destroy",value:function(t){var n=this;return this._callWhenReady(function(){if(t instanceof u.default.Collection){var r=function(){if(!t.models.length)return{v:Promise.resolve()};var n=[];return e.each(e.clone(t.models),function(e){e.store&&n.push(e.destroy())}),{v:Promise.all(n)}}();if("object"===("undefined"==typeof r?"undefined":a(r)))return r.v}if(!t.id&&!t.cid)return Promise.reject(new Error("Invalid model passed to store"));var i=t.cid;return n.localForage.removeItem(i).then(function(){return Promise.resolve(t.toJSON())})})}},{key:"_callWhenReady",value:function(e){var t=this;return this.ready.then(function(){return e.bind(t)()})}}],[{key:"_getDriverOrder",value:function(e){return e.map(function(e){switch(e){case"indexeddb":return d.default.INDEXEDDB;case"websql":return d.default.WEBSQL;case"localstorage":return d.default.LOCALSTORAGE;default:return"object"===("undefined"==typeof e?"undefined":a(e))&&e._driver?e._driver:console.error("No such db driver!")}})}}]),t}();t.default=l}).call(t,n(1))},function(e,n){e.exports=t},function(e,t){e.exports=n},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(e,t){var n=[],r=!0,i=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){i=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=n(3),s=r(o),u=n(1),c=r(u),d=n(2),l=r(d),f=s.default.Collection.extend({constructor:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{});return this.store=e.store||this.store||new l.default,e.model||this.model?void s.default.Collection.prototype.constructor.apply(this,arguments):void console.error("Collection's model must be provided")},comparator:function(e){return e.metadata.created_on},size:function(){return Promise.resolve(this.length)},save:function(e,t){return this.sync("create",e||this,t)},destroy:function(e,t){return this.sync("delete",e||this,t)},fetch:function(e){e=c.default.extend({parse:!0},e);var t=this;return this.sync("read",this,e).then(function(n){var r=e.reset?"reset":"set";t[r](n,e),t.trigger("sync",t,n,e)})},sync:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n.remote?this._syncRemote(e,t,n):this.store?(this.trigger("request",t,null,n),this.store.sync(e,t,n)):Promise.reject(new Error("Trying to locally sync a collection without a store"))},_syncRemote:function(e,t,n){t.synchronising=!0;var r=function(){switch(e){case"create":if(!t.models.length)return{v:Promise.resolve()};var r=[];return c.default.each(t.models,function(e){e.store&&r.push(e.save(null,n))}),{v:Promise.all(r)};case"update":return t.synchronising=!1,{v:Promise.reject(new Error("Updating the model is not possible yet."))};case"read":return t.synchronising=!1,{v:Promise.reject(new Error("Reading the model is not possible yet."))};case"delete":return t.synchronising=!1,{v:Promise.reject(new Error("Deleting the model is not possible yet."))};default:return t.synchronising=!1,{v:Promise.reject(new Error("No such remote sync option: "+e))}}}();if("object"===("undefined"==typeof r?"undefined":a(r)))return r.v},_getSubmission:function(e){var t=[],n=[];return this.models.forEach(function(r){var a=r._getSubmission(e),o=i(a,2),s=o[0],u=o[1];t.push(s),c.default.extend(n,u)}),[t,n]},_prepareModel:function(e){if(this._isModel(e))return e.collection||(e.collection=this),e;var t=e.attributes;e=e?c.default.clone(e):{},e.collection=this,e.store=this.store;var n=new this.model(t,e);return n.validationError?(this.trigger("invalid",this,n.validationError,e),!1):n}});t.default=f},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(e,t){var n=[],r=!0,i=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){i=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=n(3),s=r(o),u=n(7),c=r(u),d=n(1),l=r(d),f=n(8),h=n(9),m=r(h),p=n(10),v=r(p),y=n(11),g=r(y),_=n(2),b=r(_),w=n(12),S=r(w),x=n(5),P=r(x),E=s.default.Model.extend({Media:g.default,Occurrence:S.default,host_url:null,api_key:null,user:null,password:null,constructor:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.id=t.id,this.cid=t.cid||m.default.getNewUUID(),this.setParent(t.parent||this.parent),this.store=t.store||this.store||new b.default,this.keys=t.keys||this.keys,t.Media&&(this.Media=t.Media),t.Occurrence&&(this.Occurrence=t.Occurrence),t.onSend&&(this.onSend=t.onSend),this.host_url=t.host_url||this.host_url,this.api_key=t.api_key||this.api_key,this.user=t.user||this.user,this.password=t.password||this.password,this.attributes={};var n={date:new Date,location_type:"latlon"},r=l.default.extend(n,e);t.collection&&(this.collection=t.collection),t.parse&&(r=this.parse(r,t)||{}),r=l.default.defaults({},r,l.default.result(this,"defaults")),this.set(r,t),this.changed={},this.metadata=this._getDefaultMetadata(t),this.occurrences=this._parseModels(t.occurrences,this.Occurrence),this.samples=this._parseModels(t.samples,this.constructor),this.media=this._parseModels(t.media,this.Media),this.initialize.apply(this,arguments)},setParent:function(e){if(e){var t=this;this.parent=e,this.parent.on("destroy",function(){t.destroy({noSave:!0})})}},addSample:function(e){e&&(e.setParent(this),this.samples.push(e))},addOccurrence:function(e){e&&(e.setParent(this),this.occurrences.push(e))},addMedia:function(e){e&&(e.setParent(this),this.media.add(e))},validate:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.remote?this.validateRemote(e,t):null},validateRemote:function(e){var t=l.default.extend({},this.attributes,e),n={},r={},i={},a={};if(t.location||(n.location="can't be blank"),t.location_type||(n.location_type="can't be blank"),t.date){var o=new Date(t.date);("Invalid Date"===o||o>new Date)&&(n.date=new Date(o)>new Date?"future date":"invalid")}else n.date="can't be blank";this.samples.length||this.occurrences.length||(n.occurrences="no occurrences"),this.samples.length&&this.samples.each(function(e){var t=e.validateRemote();if(t){var n=e.cid;r[n]=t}}),this.occurrences.length&&this.occurrences.each(function(e){var t=e.validateRemote();if(t){var n=e.cid;i[n]=t}}),this.media.length&&this.media.each(function(e){var t=e.validateRemote();if(t){var n=e.cid;a[n]=t}});var s={};return l.default.isEmpty(a)||(s.media=a),l.default.isEmpty(i)||(s.occurrences=i),l.default.isEmpty(r)||(s.samples=r),l.default.isEmpty(n)||(s.sample=n),l.default.isEmpty(s)?null:s},sync:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n.remote?this._syncRemote(e,t,n):this.store?(this.trigger("request",t,null,n),this.store.sync(e,t,n)):Promise.reject(new Error("Trying to locally sync a model without a store"))},_syncRemote:function(e,t,n){if(!this.host_url)return Promise.reject(new Error('A "url" property or function must be specified'));switch(t.synchronising=!0,e){case"create":return this._create(t,n).then(function(e){return t.synchronising=!1,e}).catch(function(e){return t.synchronising=!1,Promise.reject(e)});case"update":return t.synchronising=!1,Promise.reject(new Error("Updating the model is not possible yet."));case"read":return t.synchronising=!1,Promise.reject(new Error("Reading the model is not possible yet."));case"delete":return t.synchronising=!1,Promise.reject(new Error("Deleting the model is not possible yet."));default:return t.synchronising=!1,Promise.reject(new Error("No such remote sync option: "+e))}},_create:function(e,t){var n=this;return n._getModelData(e).then(function(r){return n._ajaxModel(r,e,t)})},_ajaxModel:function(e,t,n){var r=this,i=new Promise(function(i,o){var u=n.timeout||r.timeout||3e4;u="function"==typeof u?u():u;var c=r.host_url+f.API_BASE+f.API_VER+f.API_SAMPLES_PATH,d=n.xhr=s.default.ajax({url:c,type:"POST",data:e,headers:{authorization:r.getUserAuth(),"x-api-key":r.api_key},processData:!1,contentType:!1,timeout:u});d.done(function(e){return i(e)}),d.fail(function(e,n,r){if("Conflict"===r){var s=function(){var t={data:{id:null,external_key:null,occurrences:[]}};return e.responseJSON.errors.forEach(function(e){t.data.id=e.sample_id,t.data.external_key=e.sample_external_key,t.data.occurrences.push({id:e.id,external_key:e.external_key})}),i(t),{v:void 0}}();if("object"===("undefined"==typeof s?"undefined":a(s)))return s.v}var u=new Error(r);if(e.responseJSON&&e.responseJSON.errors){var c=e.responseJSON.errors.reduce(function(e,t){return""+e+t.title+"\n"},"");u=new Error(c)}t.trigger("error",u),o(u)}),t.trigger("request",t,d,n)});return i},_remoteCreateParse:function(e,t){function n(e){r[e.external_key]=e.id,e.samples&&e.samples.forEach(function(e){return n(e)}),e.occurrences&&e.occurrences.forEach(function(e){return n(e)})}var r={};n(t),this._setNewRemoteID(e,r)},_setNewRemoteID:function(e,t){var n=this,r=t[e.cid];r&&(e.id=r),e.samples&&e.samples.forEach(function(e){return n._setNewRemoteID(e,t)}),e.occurrences&&e.occurrences.forEach(function(e){return n._setNewRemoteID(e,t)}),e.media&&e.media.forEach(function(e){return n._setNewRemoteID(e,t)})},_getModelData:function(e){if(!e)throw new Error("No model passed to _getModelData.");var t=this,n=e._getSubmission(),r=i(n,2),a=r[0],o=r[1];return a.type="samples",this.onSend?this.onSend(a,o).then(function(e){var n=i(e,2),r=n[0],a=n[1];return t._normaliseModelData(r,a)}):this._normaliseModelData(a,o)},_normaliseModelData:function(e,t){var n=this,r=JSON.stringify({data:e});if(t.length){var i=function(){var e=new FormData;return e.append("submission",r),{v:n._mediaAppend(t,e).then(function(){return Promise.resolve(e)})}}();if("object"===("undefined"==typeof i?"undefined":a(i)))return i.v}return Promise.resolve(r)},_mediaAppend:function(e,t){var n=[];return e.forEach(function(e){var r=new Promise(function(n){function r(e,r,i,s){var u=a,c=a;a.match(/image.*/)?u=a.split("/")[1]:c="image/"+c,s||(s=m.default.dataURItoBlob(i,c)),t.append(o,s,o+"."+u),n()}var i=e.getURL(),a=e.get("type"),o=e.cid;m.default.isDataURL(i)?r(null,null,i):!function(){var e=new XMLHttpRequest;e.open("GET",i,!0),e.responseType="blob",e.onload=function(){r(null,null,null,e.response)},e.send()}()});n.push(r)}),Promise.all(n)},_getSubmission:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this,n="function"==typeof this.keys?this.keys():this.keys,r=c.default.extend(!0,E.keys,n),a=l.default.clone(this.media.models),o={id:this.id,external_key:this.cid,survey_id:this.metadata.survey_id,input_form:this.metadata.input_form,fields:{},media:[]};Object.keys(this.attributes).forEach(function(e){var n=t.attributes[e];if(n){if(!r[e])return"email"!==e&&console.warn("Indicia: no such key: "+e),void(o.fields[e]=n);var i=r[e].id||e;r[e].values&&(n="function"==typeof r[e].values?r[e].values(n,o,t):r[e].values[n]),n&&(o.fields[i]=n)}});var s=l.default.extend({},e);this.metadata.training&&(s.training=this.metadata.training),this.metadata.release_status&&(s.release_status=this.metadata.release_status),this.metadata.record_status&&(s.record_status=this.metadata.record_status),this.metadata.sensitive&&(s.sensitive=this.metadata.sensitive),this.metadata.confidential&&(s.confidential=this.metadata.confidential),this.metadata.sensitivity_precision&&(s.sensitivity_precision=this.metadata.sensitivity_precision);var u=this.occurrences._getSubmission(s),d=i(u,2),f=d[0],h=d[1];o.occurrences=f,a=a.concat(h);var m=this.samples._getSubmission(s),p=i(m,2),v=p[0],y=p[1];o.samples=v,a=a.concat(y);var g=this.media._getSubmission(s),_=i(g,1),b=_[0];return o.media=b,[o,a]},toJSON:function(){var e=void 0;this.occurrences?e=this.occurrences.toJSON():(e=[],console.warn("toJSON occurrences missing"));var t=void 0;this.samples?t=this.samples.toJSON():(t=[],console.warn("toJSON samples missing"));var n=void 0;this.media?n=this.media.toJSON():(n=[],console.warn("toJSON media missing"));var r={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,occurrences:e,samples:t,media:n};return r},getSyncStatus:function(){var e=this.metadata;return this.synchronising?f.SYNCHRONISING:this.id>=0?e.synced_on?e.synced_on<e.updated_on?e.synced_on<e.server_on?f.CONFLICT:f.CHANGED_LOCALLY:e.synced_on<e.server_on?f.CHANGED_SERVER:f.SYNCED:f.SERVER:f.LOCAL},getOccurrence:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.occurrences.at(e)},getSample:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.samples.at(e)},getMedia:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.media.at(e)},getUserAuth:function(){if(!this.user||!this.password)return null;var e="function"==typeof this.user?this.user():this.user,t="function"==typeof this.password?this.password():this.password,n=btoa(e+":"+t);return"Basic  "+n},_parseModels:function(e,t){if(!e)return new P.default([],{model:t});var n=this,r=[];return l.default.each(e,function(e){if(e instanceof t)e.setParent(n),r.push(e);else{var i=l.default.extend(e,{parent:n}),a=new t(e.attributes,i);r.push(a)}}),new P.default(r,{model:t})},isNew:function(){return!this.id},fetch:function(e){var t=this,n=this,r=new Promise(function(r,i){return e=l.default.extend({parse:!0},e),t.sync("read",t,e).then(function(t){return n.id=t.id,n.metadata=t.metadata,!!n.set(t.attributes,e)&&(n.occurrences=n._parseModels(t.occurrences,n.Occurrence),n.samples=n._parseModels(t.samples,E),n.media=n._parseModels(t.media,n.Media),n.trigger("sync",n,t,e),r(n),null)}).catch(i)});return r},_getDefaultMetadata:function(e){var t="function"==typeof this.metadata?this.metadata():this.metadata,n=new Date,r={survey_id:e.survey_id,input_form:e.input_form,created_on:n,updated_on:n,synced_on:null,server_on:null};return c.default.extend(!0,r,t,e.metadata)}});l.default.extend(E.prototype,v.default),E.keys={date:{id:"date"},location:{id:"entered_sref"},location_type:{id:"entered_sref_system",values:{british:"OSGB",irish:"OSIE",latlon:4326}},form:{id:"input_form"},group:{id:"group_id"}},t.default=E},function(e,t){e.exports=r},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.API_BASE="api/",t.API_VER="v1",t.API_SAMPLES_PATH="/samples",t.API_REPORTS_PATH="/reports",t.SYNCHRONISING=0,t.SYNCED=1,t.LOCAL=2,t.SERVER=3,t.CHANGED_LOCALLY=4,t.CHANGED_SERVER=5,t.CONFLICT=-1},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"===e?t:3&t|8;return n.toString(16)})},i=function(e,t){for(var n=atob(e.split(",")[1]),r=[],i=0;i<n.length;i++)r.push(n.charCodeAt(i));return new Blob([new Uint8Array(r)],{type:t})},a=function(e){if(!e)return!1;var t=e.toString(),n=/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i;return!!t.match(n)},o=function(e){function t(e){for(var t={},n="Boolean Number String Function Array Date RegExp Object".split(" "),r=0;r<n.length;r++)t["[object "+n[r]+"]"]=n[r].toLowerCase();return null==e?String(e):t[toString.call(e)]||"object"}function r(e){return e&&"object"===("undefined"==typeof e?"undefined":n(e))&&"setInterval"in e}if(!e||"object"!==t(e)||e.nodeType||r(e))return!1;if(e.constructor&&!hasOwn.call(e,"constructor")&&!hasOwn.call(e.constructor.prototype,"isPrototypeOf"))return!1;var i=void 0;for(i in e);return void 0===i||hasOwn.call(e,i)},s=function(e){for(var t in e)return!1;return!0},u=function(e){var t=e,n=new Date,r=0,i=0,a=/\d{2}\/\d{2}\/\d{4}$/,o=/\d{4}-\d{1,2}-\d{1,2}$/,s=/\d{1,2}-\d{1,2}-\d{4}$/,u=[];if("string"==typeof t){if(u=t.split("-"),a.test(t))return t;o.test(t)?t=new Date(window.parseInt(u[0]),window.parseInt(u[1])-1,window.parseInt(u[2])):s.test(t)&&(t=new Date(window.parseInt(u[2]),window.parseInt(u[1])-1,window.parseInt(u[0])))}return n=t||n,r=("0"+n.getDate()).slice(-2),i=("0"+(n.getMonth()+1)).slice(-2),r+"/"+i+"/"+n.getFullYear()};t.default={getNewUUID:r,dataURItoBlob:i,isDataURL:a,isPlainObject:o,isEmptyObject:s,formatDate:u}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=n(1),o=r(a),s={save:function(e,t,n){var r=this,a=void 0;null==e||"object"===("undefined"==typeof e?"undefined":i(e))?(a=e,n=t):(a={})[e]=t,n=o.default.extend({validate:!0,parse:!0},n);var s=n.wait;if(a&&!s){if(!this.set(a,n))return!1}else if(!this._validate(a,n))return!1;var u=new Promise(function(i,u){var c=r.attributes;a&&s&&(r.attributes=o.default.extend({},c,a));var d="create";!r.isNew()&&n.remote&&(d=n.patch?"patch":"update"),"patch"!==d||n.attrs||(n.attrs=a),r.parent&&!n.remote?r.parent.save(e,t,n).then(function(){r.attributes=c,r.trigger("sync",r,null,n),i(r)}).catch(u):r.sync(d,r,n).then(function(e){if(n.remote){r._remoteCreateParse(r,e.data);var t=new Date;return r.metadata.server_on=t,r.metadata.updated_on=t,r.metadata.synced_on=t,r.attributes=c,void r.save().then(function(){r.trigger("sync",r,e,n),i(r)})}r.trigger("sync",r,e,n),i(r)}).catch(function(e){r.trigger("error",e),u(e)}),r.attributes=c});return u},destroy:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this,n=this.collection,r=new Promise(function(r,i){function a(){t.stopListening(),t.trigger("destroy",t,n,e),e.noSave?(t.trigger("sync",t,null,e),r(t)):t.parent.save(null,e).then(function(){t.trigger("sync",t,null,e),r(t)})}t.parent?e.remote?t.sync("delete",t,e).then(a):a():t.sync("delete",t,e).then(function(){t.stopListening(),t.trigger("destroy",t,n,e),t.trigger("sync",t,null,e),r(t)}).catch(i)});return r}};t.default=s},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){function e(e,t){var n=[],r=!0,i=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){i=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=n(3),s=r(o),u=n(1),c=r(u),d=n(9),l=r(d),f=n(10),h=r(f),m=100,p=100,v=s.default.Model.extend({constructor:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e;if("string"==typeof e){var r=e;return void(n={data:r})}this.id=t.id,this.cid=t.cid||l.default.getNewUUID(),this.setParent(t.parent||this.parent),this.attributes={},t.collection&&(this.collection=t.collection),t.parse&&(n=this.parse(n,t)||{}),n=c.default.defaults({},n,c.default.result(this,"defaults")),this.set(n,t),this.changed={},t.metadata?this.metadata=t.metadata:this.metadata={created_on:new Date},this.initialize.apply(this,arguments)},sync:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n.remote?this._syncRemote(e,t,n):Promise.reject(new Error("Local sync is not possible yet."))},_syncRemote:function(){return Promise.reject(new Error("Remote sync is not possible yet."))},getURL:function(){return this.get("data")},setParent:function(e){if(e){var t=this;this.parent=e,this.parent.on("destroy",function(){t.destroy({noSave:!0})})}},resize:function(e,t){var n=this,r=this,i=new Promise(function(i,o){v.resize(n.getURL(),n.get("type"),e,t).then(function(e){var t=a(e,2),n=t[0],o=t[1];r.set("data",o),i([n,o])}).catch(o)});return i},addThumbnail:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=this,r=new Promise(function(r,i){var o=/^data:/i;return o.test(e.getURL())?void v.resize(e.getURL(),e.get("type"),m||t.width,m||t.width).then(function(e){var t=a(e,2),i=t[1];n.set("thumbnail",i),r()}).catch(i):void v.getDataURI(e.getURL(),{width:m||t.width,height:p||t.height}).then(function(e){n.set("thumbnail",e[0]),r()}).catch(i)});return r},validate:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.remote?this.validateRemote(e,t):null},validateRemote:function(e){var t=c.default.extend({},this.attributes,e),n={};return t.data||(n.data="can't be empty"),t.type||(n.type="can't be empty"),c.default.isEmpty(n)?null:n},toJSON:function(){var e={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes};return e},_getSubmission:function(){var e={id:this.id,name:this.cid};return[e]}});c.default.extend(v.prototype,h.default),c.default.extend(v,{getDataURI:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=new Promise(function(n,r){if("string"==typeof e){var o=function(){var r=e.replace(/.*\.([a-z]+)$/i,"$1");return"jpg"===r&&(r="jpeg"),v.resize(e,r,t.width,t.height).then(function(e){var t=a(e,2),i=t[0],o=t[1];n([o,r,i.width,i.height])}),{v:void 0}}();if("object"===("undefined"==typeof o?"undefined":i(o)))return o.v}if(!window.FileReader)return void r(new Error("No File Reader"));var s=new FileReader;s.onload=function(r){t.width||t.height?v.resize(r.target.result,e.type,t.width,t.height).then(function(t){var r=a(t,2),i=r[0],o=r[1];n([o,e.type,i.width,i.height])}):!function(){var t=new window.Image;t.onload=function(){var i=e.type.replace(/.*\/([a-z]+)$/i,"$1");n([r.target.result,i,t.width,t.height])},t.src=r.target.result}()},s.readAsDataURL(e)});return n},resize:function(e,t,n,r){var i=new Promise(function(i){var a=new window.Image;a.onload=function(){var e=a.width,o=a.height,s=n||e,u=r||o,c=null;c=e>o?e/s:o/u,e/=c,o/=c;var d=document.createElement("canvas");d.width=e,d.height=o,d.getContext("2d").drawImage(a,0,0,e,o),i([a,d.toDataURL(t)])},a.src=e});return i}}),t.default=v},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(e,t){var n=[],r=!0,i=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){i=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=n(3),o=r(a),s=n(1),u=r(s),c=n(7),d=r(c),l=n(9),f=r(l),h=n(10),m=r(h),p=n(11),v=r(p),y=n(5),g=r(y),_=o.default.Model.extend({Media:v.default,constructor:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this,i=t;this.id=n.id,this.cid=n.cid||f.default.getNewUUID(),this.setParent(n.parent||this.parent),this.keys=n.keys||this.keys,n.Media&&(this.Media=n.Media),this.attributes={},n.collection&&(this.collection=n.collection),n.parse&&(i=this.parse(i,n)||{}),i=u.default.defaults({},i,u.default.result(this,"defaults")),this.set(i,n),this.changed={},this.metadata=this._getDefaultMetadata(n),n.media?!function(){var t=[];u.default.each(n.media,function(n){if(n instanceof e.Media)n.setParent(r),t.push(n);else{var i=u.default.extend(n,{parent:r});t.push(new e.Media(n.attributes,i))}}),e.media=new g.default(t,{model:e.Media})}():this.media=new g.default([],{model:this.Media}),this.initialize.apply(this,arguments)},setParent:function(e){if(e){var t=this;this.parent=e,this.parent.on("destroy",function(){t.destroy({noSave:!0})})}},addMedia:function(e){e&&(e.setParent(this),this.media.add(e))},getMedia:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.media.at(e)},validate:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.remote?this.validateRemote(e,t):null},validateRemote:function(e){var t=u.default.extend({},this.attributes,e),n={},r={};t.taxon||(r.taxon="can't be blank"),this.media.length&&this.media.each(function(e){var t=e.validateRemote();if(t){var r=e.cid;n[r]=t}});var i={};return u.default.isEmpty(n)||(i.media=n),u.default.isEmpty(r)||(i.occurrence=r),u.default.isEmpty(i)?null:i},toJSON:function(){var e=void 0;this.media?e=this.media.toJSON():(e=[],console.warn("toJSON media missing"));var t={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,media:e};return t},_getSubmission:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this,n="function"==typeof this.keys?this.keys():this.keys,r=d.default.extend(!0,_.keys,n),a=u.default.clone(this.media.models),o={id:this.id,external_key:this.cid,fields:{},media:[]};(this.metadata.training||e.training)&&(o.training=this.metadata.training||e.training),(this.metadata.release_status||e.release_status)&&(o.release_status=this.metadata.release_status||e.release_status),(this.metadata.record_status||e.record_status)&&(o.record_status=this.metadata.record_status||e.record_status),(this.metadata.sensitive||e.sensitive)&&(o.sensitive=this.metadata.sensitive||e.sensitive),(this.metadata.confidential||e.confidential)&&(o.confidential=this.metadata.confidential||e.confidential),(this.metadata.sensitivity_precision||e.sensitivity_precision)&&(o.sensitivity_precision=this.metadata.sensitivity_precision||e.sensitivity_precision),Object.keys(this.attributes).forEach(function(e){var n=t.attributes[e];if(n){if(!r[e])return"email"!==e&&console.warn("Indicia: no such key: "+e),void(o.fields[e]=n);var i=r[e].id||e;r[e].values&&(n="function"==typeof r[e].values?r[e].values(n,o,t):r[e].values[n]),n&&(o.fields[i]=n)}});var s=this.media._getSubmission(),c=i(s,1),l=c[0];return o.media=l,[o,a]},sync:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n.remote?this._syncRemote(e,t,n):Promise.reject(new Error("Local sync is not possible yet."))},_syncRemote:function(){return Promise.reject(new Error("Remote sync is not possible yet."))},_getDefaultMetadata:function(e){var t="function"==typeof this.metadata?this.metadata():this.metadata;e.metadata=e.metadata||{};var n=new Date,r={training:e.training,created_on:n,updated_on:n,synced_on:null,server_on:null};return d.default.extend(!0,r,t,e.metadata)}});u.default.extend(_.prototype,m.default),_.keys={taxon:{id:"taxa_taxon_list_id"}},t.default=_},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){
if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(7),s=r(o),u=n(8),c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e),this.host_url=t.host_url||this.host_url,this.user=t.user||this.user,this.password=t.password||this.password,this.report=t.report||this.report,this.api_key=t.api_key||this.api_key,this.params=t.params||this.params,this.timeout=t.timeout||18e4}return a(e,[{key:"run",value:function(e){var t=this,n=this,r=new Promise(function(r,i){var a=t.host_url+u.API_BASE+u.API_VER+u.API_REPORTS_PATH+t.report;e=s.default.extend(e||n.params,{api_key:n.api_key}),s.default.get({url:a,data:e,timeout:n.timeout,headers:{authorization:n.getUserAuth(),"x-api-key":n.api_key},success:r,error:function e(t,n,r){var e=new Error(r);if(t.responseJSON&&t.responseJSON.errors){var a=t.responseJSON.errors.reduce(function(e,t){return""+e+t.title+"\n"},"");e=new Error(a)}i(e)}})});return r}},{key:"getUserAuth",value:function(){if(!this.user||!this.password)return null;var e="function"==typeof this.user?this.user():this.user,t="function"==typeof this.password?this.password():this.password,n=btoa(e+":"+t);return"Basic  "+n}}]),e}();t.default=c}])});