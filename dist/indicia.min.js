/*!
 * indicia 4.4.3
 * Indicia JavaScript SDK.
 * https://github.com/Indicia-Team/indicia-js
 * Author Karolis Kazlauskis
 * Released under the GNU GPL v3 license.
 * http://www.gnu.org/licenses/gpl.html
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("underscore"),require("backbone"),require("localforage"),require("jquery")):"function"==typeof define&&define.amd?define(["underscore","backbone","localforage","jquery"],e):(t=t||self).Indicia=e(t._,t.Backbone,t.localforage,t.$)}(this,(function(t,e,r,n){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,e=e&&e.hasOwnProperty("default")?e.default:e,r=r&&r.hasOwnProperty("default")?r.default:r,n=n&&n.hasOwnProperty("default")?n.default:n;var i=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function r(n){return"function"==typeof Symbol&&"symbol"===e(Symbol.iterator)?t.exports=r=function(t){return e(t)}:t.exports=r=function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":e(t)},r(n)}t.exports=r}));var a=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")};function s(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var o=function(t,e,r){return e&&s(t.prototype,e),r&&s(t,r),t},c=function(){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};a(this,n);var e=this;this.localForage=null,this.ready=new Promise((function(a,s){new Promise((function(e){t.driverOrder&&"object"===i(t.driverOrder[0])?r.defineDriver(t.driverOrder[0]).then(e):e()})).then((function(){var i={name:t.name||"indicia",storeName:t.storeName||"models"};t.version&&(i.version=t.version);var o=t.driverOrder||["indexeddb","websql","localstorage"],c=n._getDriverOrder(o),u=t.LocalForage||r;e.localForage=u.createInstance(i),e.localForage.setDriver(c).then((function(){a(e.localForage)})).catch(s)}))}))}return o(n,[{key:"sync",value:function(t,e,r){switch(t){case"read":return e.cid?this.find(e,r):this.findAll(e,r);case"create":return this.create(e,r);case"update":return this.update(e,r);case"delete":return this.destroy(e,r);default:return Promise.reject(new Error("Local Sync method not found ".concat(t)))}}},{key:"save",value:function(r,n){var i=this;return this._callWhenReady((function(){if(r instanceof e.Collection){if(!r.models.length)return Promise.resolve();var a=[];return t.each(r.models,(function(t){t.store&&a.push(t.save(null,n))})),Promise.all(a)}if(!r.id&&!r.cid)return Promise.reject(new Error("Invalid model passed to store"));var s=r.cid;return i.localForage.setItem(s,r.toJSON()).then((function(){return Promise.resolve()}))}))}},{key:"create",value:function(t,e){return this.update(t,e)}},{key:"update",value:function(t,e){return this.save(t,e)}},{key:"find",value:function(t){var e=this;return this._callWhenReady((function(){return e.localForage.getItem(t.cid).then((function(e){return e||Promise.reject("LocalForage entry with ".concat(t.cid," as key not found"))}))}))}},{key:"findAll",value:function(){var t=this;return this._callWhenReady((function(){var e=[];return t.localForage.iterate((function(t){e.push(t)})).then((function(){return Promise.resolve(e)}))}))}},{key:"destroy",value:function(r){var n=this;return this._callWhenReady((function(){if(r instanceof e.Collection){if(!r.models.length)return Promise.resolve();var i=[];return t.each(t.clone(r.models),(function(t){t.store&&i.push(t.destroy())})),Promise.all(i)}if(!r.id&&!r.cid)return Promise.reject(new Error("Invalid model passed to store"));var a=r.cid;return n.localForage.removeItem(a).then((function(){return Promise.resolve(r.toJSON())}))}))}},{key:"_callWhenReady",value:function(t){var e=this;return this.ready.then((function(){return t.bind(e)()}))}}],[{key:"_getDriverOrder",value:function(t){return t.map((function(t){switch(t){case"indexeddb":return r.INDEXEDDB;case"websql":return r.WEBSQL;case"localstorage":return r.LOCALSTORAGE;default:return"object"===i(t)&&t._driver?t._driver:console.error("No such db driver!")}}))}}]),n}();
/*!
	 Inspired by localForage Backbone Adapter
	 */var u=function(t){if(Array.isArray(t))return t};var d=function(t,e){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)){var r=[],n=!0,i=!1,a=void 0;try{for(var s,o=t[Symbol.iterator]();!(n=(s=o.next()).done)&&(r.push(s.value),!e||r.length!==e);n=!0);}catch(t){i=!0,a=t}finally{try{n||null==o.return||o.return()}finally{if(i)throw a}}return r}};var l=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")};var h=function(t,e){return u(t)||d(t,e)||l()},f=e.Collection.extend({constructor:function(){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.store=t.store||this.store||new c,t.model||this.model?e.Collection.prototype.constructor.apply(this,arguments):console.error("Collection's model must be provided")},comparator:function(t){return t.metadata.created_on},size:function(){return Promise.resolve(this.length)},save:function(t,e){return this.sync("create",t||this,e)},destroy:function(t,e){return this.sync("delete",t||this,e)},fetch:function(e){e=t.extend({parse:!0},e);var r=this;return this.sync("read",this,e).then((function(t){var n=e.reset?"reset":"set";r[n](t,e);try{r.trigger("sync",r,t,e)}catch(t){}}))},sync:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(r.remote)return this._syncRemote(t,e,r);if(!this.store)return Promise.reject(new Error("Trying to locally sync a collection without a store"));try{this.trigger("request",e,null,r)}catch(t){}return this.store.sync(t,e,r)},_syncRemote:function(e,r,n){switch(r.synchronising=!0,e){case"create":if(!r.models.length)return Promise.resolve();var i=[];return t.each(r.models,(function(t){t.store&&i.push(t.save(null,n))})),Promise.all(i);case"update":return r.synchronising=!1,Promise.reject(new Error("Updating the model is not possible yet."));case"read":return r.synchronising=!1,Promise.reject(new Error("Reading the model is not possible yet."));case"delete":return r.synchronising=!1,Promise.reject(new Error("Deleting the model is not possible yet."));default:return r.synchronising=!1,Promise.reject(new Error("No such remote sync option: ".concat(e)))}},_getSubmission:function(t){var e=[],r=[];return this.models.forEach((function(n){var i=n._getSubmission(t),a=h(i,2),s=a[0],o=a[1];e.push(s),r=r.concat(o)})),[e,r]},_prepareModel:function(e){if(this._isModel(e))return e.collection||(e.collection=this),e;var r=e.attributes;(e=e?t.clone(e):{}).collection=this,e.store=this.store;var n=new this.model(r,e);return n.validationError?(this.trigger("invalid",this,n.validationError,e),!1):n}});var m=function(t){if(Array.isArray(t)){for(var e=0,r=new Array(t.length);e<t.length;e++)r[e]=t[e];return r}};var p=function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)};var v=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")};var y=function(t){return m(t)||p(t)||v()},g=Object.freeze({__proto__:null,API_BASE:"api/",API_VER:"v1",API_SAMPLES_PATH:"/samples",API_REPORTS_PATH:"/reports",SYNCHRONISING:0,SYNCED:1,LOCAL:2,SERVER:3,CHANGED_LOCALLY:4,CHANGED_SERVER:5,CONFLICT:-1}),_={getNewUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))},dataURItoBlob:function(t,e){for(var r=atob(t.split(",")[1]),n=[],i=0;i<r.length;i++)n.push(r.charCodeAt(i));return new Blob([new Uint8Array(n)],{type:e})},isDataURL:function(t){if(!t)return!1;return!!t.toString().match(/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i)},isPlainObject:function(t){if(!t||"object"!==function(t){for(var e={},r="Boolean Number String Function Array Date RegExp Object".split(" "),n=0;n<r.length;n++)e["[object ".concat(r[n],"]")]=r[n].toLowerCase();return null==t?String(t):e[toString.call(t)]||"object"}(t)||t.nodeType||function(t){return t&&"object"===i(t)&&"setInterval"in t}(t))return!1;if(t.constructor&&!hasOwn.call(t,"constructor")&&!hasOwn.call(t.constructor.prototype,"isPrototypeOf"))return!1;var e;for(e in t);return void 0===e||hasOwn.call(t,e)},isEmptyObject:function(t){for(var e in t)return!1;return!0},formatDate:function(t){var e,r,n=t,i=new Date,a=[];if("string"==typeof n){if(a=n.split("-"),/\d{2}\/\d{2}\/\d{4}$/.test(n))return n;/\d{4}-\d{1,2}-\d{1,2}$/.test(n)?n=new Date(window.parseInt(a[0]),window.parseInt(a[1])-1,window.parseInt(a[2])):/\d{1,2}-\d{1,2}-\d{4}$/.test(n)&&(n=new Date(window.parseInt(a[2]),window.parseInt(a[1])-1,window.parseInt(a[0])))}return e="0".concat((i=n||i).getDate()).slice(-2),r="0".concat(i.getMonth()+1).slice(-2),"".concat(e,"/").concat(r,"/").concat(i.getFullYear())}},w={save:function(e,r,n){var a,s=this;null==e||"object"===i(e)?(a=e,n=r):(a={})[e]=r;var o=(n=t.extend({validate:!0,parse:!0},n)).wait;if(a&&!o){if(!this.set(a,n))return!1}else if(!this._validate(a,n))return!1;var c=s.attributes;a&&o&&(s.attributes=t.extend({},c,a));var u="create";return!s.isNew()&&n.remote&&(u=n.patch?"patch":"update"),"patch"!==u||n.attrs||(n.attrs=a),s.parent&&!n.remote?s.parent.save(e,r,n).then((function(){s.attributes=c;try{s.trigger("sync",s,null,n)}catch(t){}return s})).catch((function(t){try{s.trigger("error",t)}catch(t){}return Promise.reject(t)})):s.sync(u,s,n).then((function(t){if(n.remote){s._remoteCreateParse(s,t.data);var e=new Date;return s.metadata.server_on=e,s.metadata.updated_on=e,s.metadata.synced_on=e,s.attributes=c,s.save().then((function(){try{s.trigger("sync:remote",s,t,n)}catch(t){}return s}))}try{s.trigger("sync",s,t,n)}catch(t){}return s})).catch((function(t){try{s.trigger("error",t)}catch(t){}return Promise.reject(t)}))},destroy:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=this,r=this.collection,n=new Promise((function(n,i){function a(){e.stopListening();try{e.trigger("destroy",e,r,t)}catch(t){}if(t.noSave){try{e.trigger("sync",e,null,t)}catch(t){}n(e)}else e.parent.save(null,t).then((function(){try{e.trigger("sync",e,null,t)}catch(t){}n(e)}))}e.parent?t.remote?e.sync("delete",e,t).then(a):a():e.sync("delete",e,t).then((function(){e.stopListening();try{e.trigger("destroy",e,r,t)}catch(t){}try{e.trigger("sync",e,null,t)}catch(t){}n(e)})).catch(i)}));return n}},b=e.Model.extend({constructor:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e;if("string"!=typeof e)this.id=r.id,this.cid=r.cid||_.getNewUUID(),this.setParent(r.parent||this.parent),this.attributes={},r.collection&&(this.collection=r.collection),r.parse&&(n=this.parse(n,r)||{}),n=t.defaults({},n,t.result(this,"defaults")),this.set(n,r),this.changed={},r.metadata?this.metadata=r.metadata:this.metadata={created_on:new Date},this.initialize.apply(this,arguments);else{n={data:e}}},sync:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.remote?this._syncRemote(t,e,r):Promise.reject(new Error("Local sync is not possible yet."))},_syncRemote:function(){return Promise.reject(new Error("Remote sync is not possible yet."))},getURL:function(){return this.get("data")},setParent:function(t){if(t){var e=this;this.parent=t,this.parent.on("destroy",(function(){e.destroy({noSave:!0})}))}},resize:function(t,e){var r=this,n=this;return new Promise((function(i,a){b.resize(r.getURL(),r.get("type"),t,e).then((function(t){var e=h(t,2),r=e[0],a=e[1];n.set("data",a),i([r,a])})).catch(a)}))},addThumbnail:function(){var t=this,e=(arguments.length>0&&void 0!==arguments[0]&&arguments[0],this),r=new Promise((function(r,n){/^data:/i.test(t.getURL())?b.resize(t.getURL(),t.get("type"),100,100).then((function(t){var n=h(t,2)[1];e.set("thumbnail",n),r()})).catch(n):b.getDataURI(t.getURL(),{width:100,height:100}).then((function(t){e.set("thumbnail",t[0]),r()})).catch(n)}));return r},validate:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e.remote?this.validateRemote(t,e):null},validateRemote:function(e){var r=t.extend({},this.attributes,e),n={};return r.data||(n.attributes||(n.attributes={}),n.attributes.data="can't be empty"),r.type||(n.attributes||(n.attributes={}),n.attributes.type="can't be empty"),t.isEmpty(n)?null:n},toJSON:function(){return{id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes}},_getSubmission:function(){return[{id:this.id,name:this.cid}]}});t.extend(b.prototype,w),t.extend(b,{getDataURI:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=new Promise((function(r,n){if("string"==typeof t){var i=t.replace(/.*\.([a-z]+)$/i,"$1");return"jpg"===i&&(i="jpeg"),void b.resize(t,i,e.width,e.height).then((function(t){var e=h(t,2),n=e[0],a=e[1];r([a,i,n.width,n.height])}))}if(window.FileReader){var a=new FileReader;a.onload=function(n){if(e.width||e.height)b.resize(n.target.result,t.type,e.width,e.height).then((function(e){var n=h(e,2),i=n[0],a=n[1];r([a,t.type,i.width,i.height])}));else{var i=new window.Image;i.onload=function(){var e=t.type.replace(/.*\/([a-z]+)$/i,"$1");r([n.target.result,e,i.width,i.height])},i.src=n.target.result}},a.readAsDataURL(t)}else n(new Error("No File Reader"))}));return r},resize:function(t,e,r,n){return new Promise((function(i){var a=new window.Image;a.onload=function(){var t=a.width,s=a.height,o=null;t/=o=t>s?t/(r||t):s/(n||s),s/=o;var c=document.createElement("canvas");c.width=t,c.height=s,c.getContext("2d").drawImage(a,0,0,t,s),i([a,c.toDataURL(e)])},a.src=t}))}});var x=e.Model.extend({Media:b,constructor:function(){var e=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this,a=r;if(this.id=n.id,this.cid=n.cid||_.getNewUUID(),this.setParent(n.parent||this.parent),this.keys=n.keys||this.keys,n.Media&&(this.Media=n.Media),this.attributes={},n.collection&&(this.collection=n.collection),n.parse&&(a=this.parse(a,n)||{}),a=t.defaults({},a,t.result(this,"defaults")),this.set(a,n),this.changed={},this.metadata=this._getDefaultMetadata(n),n.media){var s=[];t.each(n.media,(function(r){if(r instanceof e.Media)r.setParent(i),s.push(r);else{var n=t.extend(r,{parent:i});s.push(new e.Media(r.attributes,n))}})),this.media=new f(s,{model:this.Media})}else this.media=new f([],{model:this.Media});this.initialize.apply(this,arguments)},setParent:function(t){if(t){var e=this;this.parent=t,this.parent.on("destroy",(function(){e.destroy({noSave:!0})}))}},addMedia:function(t){t&&(t.setParent(this),this.media.add(t))},getMedia:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.media.at(t)},validate:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e.remote?this.validateRemote(t,e):null},validateRemote:function(e){var r=t.extend({},this.attributes,e),n={},i={};r.taxon||(i.taxon="can't be blank"),this.media.length&&this.media.each((function(t){var e=t.validateRemote();if(e){var r=t.cid;n[r]=e}}));var a={};return t.isEmpty(n)||(a.media=n),t.isEmpty(i)||(a.attributes=i),t.isEmpty(a)?null:a},toJSON:function(){var t;return this.media?t=this.media.toJSON():(t=[],console.warn("toJSON media missing")),{id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,media:t}},_getSubmission:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=this,i="function"==typeof this.keys?this.keys():this.keys,a=n.extend(!0,x.keys,i),s=y(this.media.models),o={id:this.id,external_key:this.cid,fields:{},media:[]};(this.metadata.training||e.training)&&(o.training=this.metadata.training||e.training),(this.metadata.release_status||e.release_status)&&(o.release_status=this.metadata.release_status||e.release_status),(this.metadata.record_status||e.record_status)&&(o.record_status=this.metadata.record_status||e.record_status),(this.metadata.sensitive||e.sensitive)&&(o.sensitive=this.metadata.sensitive||e.sensitive),(this.metadata.confidential||e.confidential)&&(o.confidential=this.metadata.confidential||e.confidential),(this.metadata.sensitivity_precision||e.sensitivity_precision)&&(o.sensitivity_precision=this.metadata.sensitivity_precision||e.sensitivity_precision),Object.keys(this.attributes).forEach((function(e){var n=r.attributes[e];if(n){if(!a[e])return"email"!==e&&console.warn("Indicia: no such key: ".concat(e)),void(o.fields[e]=n);var i=a[e].id||e;a[e].values&&(n="function"==typeof a[e].values?a[e].values(n,o,r):t.isArray(n)?n.map((function(t){return a[e].values[t]})):a[e].values[n]),n&&(o.fields[i]=n)}}));var c=this.media._getSubmission(),u=h(c,1),d=u[0];return o.media=d,[o,s]},sync:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.remote?this._syncRemote(t,e,r):Promise.reject(new Error("Local sync is not possible yet."))},_syncRemote:function(){return Promise.reject(new Error("Remote sync is not possible yet."))},_getDefaultMetadata:function(t){var e="function"==typeof this.metadata?this.metadata():this.metadata;t.metadata=t.metadata||{};var r=new Date,i={training:t.training,created_on:r,updated_on:r,synced_on:null,server_on:null};return n.extend(!0,i,e,t.metadata)}});t.extend(x.prototype,w),x.keys={taxon:{id:"taxa_taxon_list_id"},comment:{id:"comment"}};var S=e.Model.extend({Media:b,Occurrence:x,host_url:null,api_key:null,user:null,password:null,constructor:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.id=r.id,this.cid=r.cid||_.getNewUUID(),this.setParent(r.parent||this.parent),this.store=r.store||this.store||new c,this.keys=r.keys||this.keys,r.Media&&(this.Media=r.Media),r.Occurrence&&(this.Occurrence=r.Occurrence),r.onSend&&(this.onSend=r.onSend),this.host_url=r.host_url||this.host_url,this.api_key=r.api_key||this.api_key,this.user=r.user||this.user,this.password=r.password||this.password,this.attributes={};var n={date:new Date,location_type:"latlon"},i=t.extend(n,e);r.collection&&(this.collection=r.collection),r.parse&&(i=this.parse(i,r)||{}),i=t.defaults({},i,t.result(this,"defaults")),this.set(i,r),this.changed={},this.metadata=this._getDefaultMetadata(r),this.remote={},this.occurrences=this._parseModels(r.occurrences,this.Occurrence),this.samples=this._parseModels(r.samples,this.constructor),this.media=this._parseModels(r.media,this.Media),this.initialize.apply(this,arguments)},setParent:function(t){if(t){var e=this;this.parent=t,this.parent.on("destroy",(function(){e.destroy({noSave:!0})}))}},addSample:function(t){t&&(t.setParent(this),this.samples.push(t))},addOccurrence:function(t){t&&(t.setParent(this),this.occurrences.push(t))},addMedia:function(t){t&&(t.setParent(this),this.media.add(t))},validate:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e.remote?this.validateRemote(t,e):null},validateRemote:function(e){var r=t.extend({},this.attributes,e),n={},i={},a={},s={};if(r.location||(n.location="can't be blank"),r.location_type||(n.location_type="can't be blank"),r.date){var o=new Date(r.date);("Invalid Date"===o||o>new Date)&&(n.date=new Date(o)>new Date?"future date":"invalid")}else n.date="can't be blank";this.samples.length||this.occurrences.length||(n.occurrences="no occurrences"),this.samples.length&&this.samples.each((function(t){var e=t.validateRemote();if(e){var r=t.cid;i[r]=e}})),this.occurrences.length&&this.occurrences.each((function(t){var e=t.validateRemote();if(e){var r=t.cid;a[r]=e}})),this.media.length&&this.media.each((function(t){var e=t.validateRemote();if(e){var r=t.cid;s[r]=e}}));var c={};return t.isEmpty(s)||(c.media=s),t.isEmpty(a)||(c.occurrences=a),t.isEmpty(i)||(c.samples=i),t.isEmpty(n)||(c.attributes=n),t.isEmpty(c)?null:c},sync:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(r.remote)return this._syncRemote(t,e,r);if(!this.store)return Promise.reject(new Error("Trying to locally sync a model without a store"));try{this.trigger("request",e,null,r)}catch(t){}return this.store.sync(t,e,r)},_syncRemote:function(t,e,r){if(!this.host_url)return Promise.reject(new Error('A "url" property or function must be specified'));switch(e.remote.synchronising=!0,t){case"create":return this._create(e,r).then((function(t){return e.remote.synchronising=!1,t})).catch((function(t){return e.remote.synchronising=!1,Promise.reject(t)}));case"update":return e.remote.synchronising=!1,Promise.reject(new Error("Updating the model is not possible yet."));case"read":return e.remote.synchronising=!1,Promise.reject(new Error("Reading the model is not possible yet."));case"delete":return e.remote.synchronising=!1,Promise.reject(new Error("Deleting the model is not possible yet."));default:return e.remote.synchronising=!1,Promise.reject(new Error("No such remote sync option: ".concat(t)))}},_create:function(t,e){var r=this;return r._getModelData(t).then((function(n){return r._ajaxModel(n,t,e)}))},_ajaxModel:function(t,r,n){var i=this;return new Promise((function(a,s){var o=n.timeout||i.timeout||3e4;o="function"==typeof o?o():o;var c=i.host_url+"api/v1/samples",u=n.xhr=e.ajax({url:c,type:"POST",data:t,headers:{authorization:i.getUserAuth(),"x-api-key":i.api_key},processData:!1,contentType:!1,timeout:o});u.done((function(t){return a(t)})),u.fail((function(t,e,n){if(409===t.status){var i={data:{id:null,external_key:null,occurrences:[]}};return t.responseJSON.errors.forEach((function(t){i.data.id=t.sample_id,i.data.external_key=t.sample_external_key,i.data.occurrences.push({id:t.id,external_key:t.external_key})})),void a(i)}var o=new Error(n);if(t.responseJSON&&t.responseJSON.errors){var c=t.responseJSON.errors.reduce((function(t,e){return"".concat(t).concat(e.title,"\n")}),"");o=new Error(c)}try{r.trigger("error:remote",o)}catch(t){}s(o)}));try{r.trigger("request:remote",r,u,n)}catch(t){}}))},_remoteCreateParse:function(t,e){var r={};!function t(e){r[e.external_key]=e.id,e.samples&&e.samples.forEach((function(e){return t(e)})),e.occurrences&&e.occurrences.forEach((function(e){return t(e)}))}(e),this._setNewRemoteID(t,r)},_setNewRemoteID:function(t,e){var r=this,n=e[t.cid];n&&(t.id=n),t.samples&&t.samples.forEach((function(t){return r._setNewRemoteID(t,e)})),t.occurrences&&t.occurrences.forEach((function(t){return r._setNewRemoteID(t,e)})),t.media&&t.media.forEach((function(t){return r._setNewRemoteID(t,e)}))},_getModelData:function(t){if(!t)throw new Error("No model passed to _getModelData.");var e=this,r=t._getSubmission(),n=h(r,2),i=n[0],a=n[1];return i.type="samples",this.onSend?this.onSend(i,a).then((function(t){var r=h(t,2),n=r[0],i=r[1];return e._normaliseModelData(n,i)})):this._normaliseModelData(i,a)},_normaliseModelData:function(t,e){var r=JSON.stringify({data:t});if(e.length){var n=new FormData;return n.append("submission",r),this._mediaAppend(e,n).then((function(){return Promise.resolve(n)}))}return Promise.resolve(r)},_mediaAppend:function(t,e){var r=[];return t.forEach((function(t){var n=new Promise((function(r){var n=t.getURL(),i=t.get("type"),a=t.cid;function s(t,n,s,o){var c=i,u=i;i.match(/image.*/)?c=i.split("/")[1]:u="image/".concat(u),o||(o=_.dataURItoBlob(s,u)),e.append(a,o,"".concat(a,".").concat(c)),r()}if(_.isDataURL(n))s(0,0,n);else{var o=new XMLHttpRequest;o.open("GET",n,!0),o.responseType="blob",o.onload=function(){s(0,0,null,o.response)},o.send()}}));r.push(n)})),Promise.all(r)},_getSubmission:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=this,i="function"==typeof this.keys?this.keys():this.keys,a=n.extend(!0,S.keys,i),s=y(this.media.models),o={id:this.id,external_key:this.cid,survey_id:this.metadata.survey_id,input_form:this.metadata.input_form,fields:{},media:[]};Object.keys(this.attributes).forEach((function(e){var n=r.attributes[e];if(n){if(!a[e])return"email"!==e&&console.warn("Indicia: no such key: ".concat(e)),void(o.fields[e]=n);var i=a[e].id||e;a[e].values&&(n="function"==typeof a[e].values?a[e].values(n,o,r):t.isArray(n)?n.map((function(t){return a[e].values[t]})):a[e].values[n]),n&&(o.fields[i]=n)}}));var c=t.extend({},e);this.metadata.training&&(c.training=this.metadata.training),this.metadata.release_status&&(c.release_status=this.metadata.release_status),this.metadata.record_status&&(c.record_status=this.metadata.record_status),this.metadata.sensitive&&(c.sensitive=this.metadata.sensitive),this.metadata.confidential&&(c.confidential=this.metadata.confidential),this.metadata.sensitivity_precision&&(c.sensitivity_precision=this.metadata.sensitivity_precision);var u=this.occurrences._getSubmission(c),d=h(u,2),l=d[0],f=d[1];o.occurrences=l,s=s.concat(f);var m=this.samples._getSubmission(c),p=h(m,2),v=p[0],g=p[1];o.samples=v,s=s.concat(g);var _=this.media._getSubmission(c),w=h(_,1),b=w[0];return o.media=b,[o,s]},toJSON:function(){var t,e,r;return this.occurrences?t=this.occurrences.toJSON():(t=[],console.warn("toJSON occurrences missing")),this.samples?e=this.samples.toJSON():(e=[],console.warn("toJSON samples missing")),this.media?r=this.media.toJSON():(r=[],console.warn("toJSON media missing")),{id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,occurrences:t,samples:e,media:r}},getSyncStatus:function(){var t=this.metadata;return this.remote.synchronising?0:this.id>=0?t.synced_on?t.synced_on<t.updated_on?t.synced_on<t.server_on?-1:4:t.synced_on<t.server_on?5:1:3:2},getOccurrence:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.occurrences.at(t)},getSample:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.samples.at(t)},getMedia:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.media.at(t)},getUserAuth:function(){if(!this.user||!this.password)return null;var t="function"==typeof this.user?this.user():this.user,e="function"==typeof this.password?this.password():this.password,r=btoa("".concat(t,":").concat(e));return"Basic  ".concat(r)},_parseModels:function(e,r){if(!e)return new f([],{model:r});var n=this,i=[];return t.each(e,(function(e){if(e instanceof r)e.setParent(n),i.push(e);else{var a=t.extend(e,{parent:n}),s=new r(e.attributes,a);i.push(s)}})),new f(i,{model:r})},isNew:function(){return!this.id},fetch:function(e){var r=this,n=this;return new Promise((function(i,a){return e=t.extend({parse:!0},e),r.sync("read",r,e).then((function(t){if(n.id=t.id,n.metadata=t.metadata,!n.set(t.attributes,e))return!1;n.occurrences=n._parseModels(t.occurrences,n.Occurrence),n.samples=n._parseModels(t.samples,S),n.media=n._parseModels(t.media,n.Media);try{n.trigger("sync",n,t,e)}catch(t){}return i(n),null})).catch(a)}))},_getDefaultMetadata:function(t){var e="function"==typeof this.metadata?this.metadata():this.metadata,r=new Date,i={survey_id:t.survey_id,input_form:t.input_form,created_on:r,updated_on:r,synced_on:null,server_on:null};return n.extend(!0,i,e,t.metadata)}});t.extend(S.prototype,w),S.keys={date:{id:"date"},sample_method_id:{id:"sample_method_id"},location:{id:"entered_sref"},location_type:{id:"entered_sref_system",values:{british:"OSGB",irish:"OSIE",channel:"utm30ed50",latlon:4326}},form:{id:"input_form"},group:{id:"group_id"},comment:{id:"comment"}};var P={VERSION:"4.4.3",Store:c,Collection:f,Sample:S,Occurrence:x,Media:b,Report:function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};a(this,t),this.host_url=e.host_url||this.host_url,this.user=e.user||this.user,this.password=e.password||this.password,this.report=e.report||this.report,this.api_key=e.api_key||this.api_key,this.params=e.params||this.params,this.timeout=e.timeout||18e4}return o(t,[{key:"run",value:function(t){var e=this,r=this;return new Promise((function(i,a){var s=e.host_url+"api/v1/reports"+e.report;t=n.extend(t||r.params,{api_key:r.api_key}),n.get({url:s,data:t,timeout:r.timeout,headers:{authorization:r.getUserAuth(),"x-api-key":r.api_key},success:i,error:function(t,e,r){var n=new Error(r);if(t.responseJSON&&t.responseJSON.errors){var i=t.responseJSON.errors.reduce((function(t,e){return"".concat(t).concat(e.title,"\n")}),"");n=new Error(i)}a(n)}})}))}},{key:"getUserAuth",value:function(){if(!this.user||!this.password)return null;var t="function"==typeof this.user?this.user():this.user,e="function"==typeof this.password?this.password():this.password,r=btoa("".concat(t,":").concat(e));return"Basic  ".concat(r)}}]),t}()};return t.extend(P,g),P}));
//# sourceMappingURL=indicia.min.js.map
