/*!
 * 
 * indicia 4.1.0
 * Indicia JavaScript SDK.
 * https://github.com/Indicia-Team/indicia-js
 * Author Karolis Kazlauskis
 * Released under the GNU GPL v3 license.
 * http://www.gnu.org/licenses/gpl.html
 * 
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("underscore"),require("backbone"),require("localforage"),require("jquery")):"function"==typeof define&&define.amd?define("Indicia",["_","Backbone","localforage","$"],t):"object"==typeof exports?exports.Indicia=t(require("underscore"),require("backbone"),require("localforage"),require("jquery")):e.Indicia=t(e._,e.Backbone,e.localforage,e.$)}(this,function(e,t,r,n){return function(e){function t(n){if(r[n])return r[n].exports;var i=r[n]={exports:{},id:n,loaded:!1};return e[n].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function i(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=r(1),o=i(a),s=r(2),u=i(s),c=r(5),d=i(c),l=r(6),f=i(l),h=r(12),m=i(h),p=r(11),v=i(p),y=r(13),g=i(y),_=r(8),b=n(_),w={VERSION:"4.1.0",Store:u.default,Collection:d.default,Sample:f.default,Occurrence:m.default,Media:v.default,Report:g.default};o.default.extend(w,b),t.default=w},function(t,r){t.exports=e},function(e,t,r){(function(e){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(3),u=n(s),c=r(4),d=n(c),l=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,t);var r=this;this.localForage=null,this.ready=new Promise(function(n,i){var o=new Promise(function(t){e.driverOrder&&"object"===a(e.driverOrder[0])?d.default.defineDriver(e.driverOrder[0]).then(t):t()});o.then(function(){var a={name:e.name||"indicia",storeName:e.storeName||"models"};e.version&&(a.version=e.version);var o=e.driverOrder||["indexeddb","websql","localstorage"],s=t._getDriverOrder(o),u=e.LocalForage||d.default;r.localForage=u.createInstance(a),r.localForage.setDriver(s).then(function(){n(r.localForage)}).catch(i)})})}return o(t,[{key:"sync",value:function(e,t,r){switch(e){case"read":return t.cid?this.find(t,r):this.findAll(t,r);case"create":return this.create(t,r);case"update":return this.update(t,r);case"delete":return this.destroy(t,r);default:return Promise.reject(new Error("Local Sync method not found "+e))}}},{key:"save",value:function(t,r){var n=this;return this._callWhenReady(function(){if(t instanceof u.default.Collection){var i=function(){if(!t.models.length)return{v:Promise.resolve()};var n=[];return e.each(t.models,function(e){e.store&&n.push(e.save(null,r))}),{v:Promise.all(n)}}();if("object"===("undefined"==typeof i?"undefined":a(i)))return i.v}if(!t.id&&!t.cid)return Promise.reject(new Error("Invalid model passed to store"));var o=t.cid;return n.localForage.setItem(o,t.toJSON()).then(function(){return Promise.resolve()})})}},{key:"create",value:function(e,t){return this.update(e,t)}},{key:"update",value:function(e,t){return this.save(e,t)}},{key:"find",value:function(e){var t=this;return this._callWhenReady(function(){return t.localForage.getItem(e.cid).then(function(t){return t?t:Promise.reject("LocalForage entry with "+e.cid+" as key not found")})})}},{key:"findAll",value:function(){var e=this;return this._callWhenReady(function(){var t=[];return e.localForage.iterate(function(e){t.push(e)}).then(function(){return Promise.resolve(t)})})}},{key:"destroy",value:function(t){var r=this;return this._callWhenReady(function(){if(t instanceof u.default.Collection){var n=function(){if(!t.models.length)return{v:Promise.resolve()};var r=[];return e.each(e.clone(t.models),function(e){e.store&&r.push(e.destroy())}),{v:Promise.all(r)}}();if("object"===("undefined"==typeof n?"undefined":a(n)))return n.v}if(!t.id&&!t.cid)return Promise.reject(new Error("Invalid model passed to store"));var i=t.cid;return r.localForage.removeItem(i).then(function(){return Promise.resolve(t.toJSON())})})}},{key:"_callWhenReady",value:function(e){var t=this;return this.ready.then(function(){return e.bind(t)()})}}],[{key:"_getDriverOrder",value:function(e){return e.map(function(e){switch(e){case"indexeddb":return d.default.INDEXEDDB;case"websql":return d.default.WEBSQL;case"localstorage":return d.default.LOCALSTORAGE;default:return"object"===("undefined"==typeof e?"undefined":a(e))&&e._driver?e._driver:console.error("No such db driver!")}})}}]),t}();t.default=l}).call(t,r(1))},function(e,r){e.exports=t},function(e,t){e.exports=r},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=r(3),s=n(o),u=r(1),c=n(u),d=r(2),l=n(d),f=s.default.Collection.extend({constructor:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{});return this.store=e.store||this.store||new l.default,e.model||this.model?void s.default.Collection.prototype.constructor.apply(this,arguments):void console.error("Collection's model must be provided")},comparator:function(e){return e.metadata.created_on},size:function(){return Promise.resolve(this.length)},save:function(e,t){return this.sync("create",e||this,t)},destroy:function(e,t){return this.sync("delete",e||this,t)},fetch:function(e){e=c.default.extend({parse:!0},e);var t=this;return this.sync("read",this,e).then(function(r){var n=e.reset?"reset":"set";t[n](r,e),t.trigger("sync",t,r,e)})},sync:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.remote?this._syncRemote(e,t,r):this.store?(this.trigger("request",t,null,r),this.store.sync(e,t,r)):Promise.reject(new Error("Trying to locally sync a collection without a store"))},_syncRemote:function(e,t,r){t.synchronising=!0;var n=function(){switch(e){case"create":if(!t.models.length)return{v:Promise.resolve()};var n=[];return c.default.each(t.models,function(e){e.store&&n.push(e.save(null,r))}),{v:Promise.all(n)};case"update":return t.synchronising=!1,{v:Promise.reject(new Error("Updating the model is not possible yet."))};case"read":return t.synchronising=!1,{v:Promise.reject(new Error("Reading the model is not possible yet."))};case"delete":return t.synchronising=!1,{v:Promise.reject(new Error("Deleting the model is not possible yet."))};default:return t.synchronising=!1,{v:Promise.reject(new Error("No such remote sync option: "+e))}}}();if("object"===("undefined"==typeof n?"undefined":a(n)))return n.v},_getSubmission:function(){var e=[],t=[];return this.models.forEach(function(r){var n=r._getSubmission(),a=i(n,2),o=a[0],s=a[1];e.push(o),c.default.extend(t,s)}),[e,t]},_prepareModel:function(e){if(this._isModel(e))return e.collection||(e.collection=this),e;var t=e.attributes;e=e?c.default.clone(e):{},e.collection=this,e.store=this.store;var r=new this.model(t,e);return r.validationError?(this.trigger("invalid",this,r.validationError,e),!1):r}});t.default=f},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=r(3),s=n(o),u=r(7),c=n(u),d=r(1),l=n(d),f=r(8),h=r(9),m=n(h),p=r(10),v=n(p),y=r(11),g=n(y),_=r(2),b=n(_),w=r(12),S=n(w),x=r(5),P=n(x),E=s.default.Model.extend({Media:g.default,Occurrence:S.default,host_url:null,api_key:null,user:null,password:null,constructor:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.id=t.id,this.cid=t.cid||m.default.getNewUUID(),this.setParent(t.parent||this.parent),this.store=t.store||this.store||new b.default,this.keys=t.keys||this.keys,t.Media&&(this.Media=t.Media),t.Occurrence&&(this.Occurrence=t.Occurrence),t.onSend&&(this.onSend=t.onSend),this.host_url=t.host_url||this.host_url,this.api_key=t.api_key||this.api_key,this.user=t.user||this.user,this.password=t.password||this.password,this.attributes={};var r={date:new Date,location_type:"latlon"},n=l.default.extend(r,e);t.collection&&(this.collection=t.collection),t.parse&&(n=this.parse(n,t)||{}),n=l.default.defaults({},n,l.default.result(this,"defaults")),this.set(n,t),this.changed={},this.metadata=this._getDefaultMetadata(t),this.occurrences=this._parseModels(t.occurrences,this.Occurrence),this.samples=this._parseModels(t.samples,this.constructor),this.media=this._parseModels(t.media,this.Media),this.initialize.apply(this,arguments)},setParent:function(e){if(e){var t=this;this.parent=e,this.parent.on("destroy",function(){t.destroy({noSave:!0})})}},addSample:function(e){e&&(e.setParent(this),this.samples.push(e))},addOccurrence:function(e){e&&(e.setParent(this),this.occurrences.push(e))},addMedia:function(e){e&&(e.setParent(this),this.media.add(e))},validate:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.remote?this.validateRemote(e,t):null},validateRemote:function(e){var t=l.default.extend({},this.attributes,e),r={},n={},i={},a={};if(t.location||(r.location="can't be blank"),t.location_type||(r.location_type="can't be blank"),t.date){var o=new Date(t.date);("Invalid Date"===o||o>new Date)&&(r.date=new Date(o)>new Date?"future date":"invalid")}else r.date="can't be blank";this.samples.length||this.occurrences.length||(r.occurrences="no occurrences"),this.samples.length&&this.samples.each(function(e){var t=e.validateRemote();if(t){var r=e.cid;n[r]=t}}),this.occurrences.length&&this.occurrences.each(function(e){var t=e.validateRemote();if(t){var r=e.cid;i[r]=t}}),this.media.length&&this.media.each(function(e){var t=e.validateRemote();if(t){var r=e.cid;a[r]=t}});var s={};return l.default.isEmpty(a)||(s.media=a),l.default.isEmpty(i)||(s.occurrences=i),l.default.isEmpty(n)||(s.samples=n),l.default.isEmpty(r)||(s.sample=r),l.default.isEmpty(s)?null:s},sync:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.remote?this._syncRemote(e,t,r):this.store?(this.trigger("request",t,null,r),this.store.sync(e,t,r)):Promise.reject(new Error("Trying to locally sync a model without a store"))},_syncRemote:function(e,t,r){if(!this.host_url)return Promise.reject(new Error('A "url" property or function must be specified'));switch(t.synchronising=!0,e){case"create":return this._create(t,r).then(function(e){return t.synchronising=!1,e}).catch(function(e){return t.synchronising=!1,Promise.reject(e)});case"update":return t.synchronising=!1,Promise.reject(new Error("Updating the model is not possible yet."));case"read":return t.synchronising=!1,Promise.reject(new Error("Reading the model is not possible yet."));case"delete":return t.synchronising=!1,Promise.reject(new Error("Deleting the model is not possible yet."));default:return t.synchronising=!1,Promise.reject(new Error("No such remote sync option: "+e))}},_create:function(e,t){var r=this;return r._getModelData(e).then(function(n){return r._ajaxModel(n,e,t)})},_ajaxModel:function(e,t,r){var n=this,i=new Promise(function(i,o){var u=r.timeout||n.timeout||3e4;u="function"==typeof u?u():u;var c=n.host_url+f.API_BASE+f.API_VER+f.API_SAMPLES_PATH,d=r.xhr=s.default.ajax({url:c,type:"POST",data:e,headers:{authorization:n.getUserAuth(),"x-api-key":n.api_key},processData:!1,contentType:!1,timeout:u});d.done(function(e){return i(e)}),d.fail(function(e,r,n){if("Conflict"===n){var s=function(){var t={data:{id:null,external_key:null,occurrences:[]}};return e.responseJSON.errors.forEach(function(e){t.data.id=e.sample_id,t.data.external_key=e.sample_external_key,t.data.occurrences.push({id:e.id,external_key:e.external_key})}),i(t),{v:void 0}}();if("object"===("undefined"==typeof s?"undefined":a(s)))return s.v}var u=new Error(n);if(e.responseJSON&&e.responseJSON.errors){var c=e.responseJSON.errors.reduce(function(e,t){return""+e+t.title+"\n"},"");u=new Error(c)}t.trigger("error",u),o(u)}),t.trigger("request",t,d,r)});return i},_remoteCreateParse:function(e,t){function r(e){n[e.external_key]=e.id,e.samples&&e.samples.forEach(function(e){return r(e)}),e.occurrences&&e.occurrences.forEach(function(e){return r(e)})}var n={};r(t),this._setNewRemoteID(e,n)},_setNewRemoteID:function(e,t){var r=this,n=t[e.cid];n&&(e.id=n),e.samples&&e.samples.forEach(function(e){return r._setNewRemoteID(e,t)}),e.occurrences&&e.occurrences.forEach(function(e){return r._setNewRemoteID(e,t)}),e.media&&e.media.forEach(function(e){return r._setNewRemoteID(e,t)})},_getModelData:function(e){if(!e)throw new Error("No model passed to _getModelData.");var t=this,r=e._getSubmission(),n=i(r,2),a=n[0],o=n[1];return a.type="samples",this.onSend?this.onSend(a,o).then(function(e){var r=i(e,2),n=r[0],a=r[1];return t._normaliseModelData(n,a)}):this._normaliseModelData(a,o)},_normaliseModelData:function(e,t){var r=this,n=JSON.stringify({data:e});if(t.length){var i=function(){var e=new FormData;return e.append("submission",n),{v:r._mediaAppend(t,e).then(function(){return Promise.resolve(e)})}}();if("object"===("undefined"==typeof i?"undefined":a(i)))return i.v}return Promise.resolve(n)},_mediaAppend:function(e,t){var r=[];return e.forEach(function(e){var n=new Promise(function(r){function n(e,n,i,s){var u=a,c=a;a.match(/image.*/)?u=a.split("/")[1]:c="image/"+c,s||(s=m.default.dataURItoBlob(i,c)),t.append(o,s,o+"."+u),r()}var i=e.getURL(),a=e.get("type"),o=e.cid;m.default.isDataURL(i)?n(null,null,i):!function(){var e=new XMLHttpRequest;e.open("GET",i,!0),e.responseType="blob",e.onload=function(){n(null,null,null,e.response)},e.send()}()});r.push(n)}),Promise.all(r)},_getSubmission:function(){var e=this,t="function"==typeof this.keys?this.keys():this.keys,r=c.default.extend(!0,E.keys,t),n=l.default.clone(this.media.models),a={id:this.id,external_key:this.cid,survey_id:this.metadata.survey_id,input_form:this.metadata.input_form,fields:{},media:[]};Object.keys(this.attributes).forEach(function(t){var n=e.attributes[t];if(n){if(!r[t])return"email"!==t&&console.warn("Indicia: no such key: "+t),void(a.fields[t]=n);var i=r[t].id||t;r[t].values&&(n="function"==typeof r[t].values?r[t].values(n,a,e):r[t].values[n]),n&&(a.fields[i]=n)}});var o=this.occurrences._getSubmission(),s=i(o,2),u=s[0],d=s[1];a.occurrences=u,n=n.concat(d);var f=this.samples._getSubmission(),h=i(f,2),m=h[0],p=h[1];a.samples=m,n=n.concat(p);var v=this.media._getSubmission(),y=i(v,1),g=y[0];return a.media=g,[a,n]},toJSON:function(){var e=void 0;this.occurrences?e=this.occurrences.toJSON():(e=[],console.warn("toJSON occurrences missing"));var t=void 0;this.samples?t=this.samples.toJSON():(t=[],console.warn("toJSON samples missing"));var r=void 0;this.media?r=this.media.toJSON():(r=[],console.warn("toJSON media missing"));var n={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,occurrences:e,samples:t,media:r};return n},getSyncStatus:function(){var e=this.metadata;return this.synchronising?f.SYNCHRONISING:this.id>=0?e.synced_on?e.synced_on<e.updated_on?e.synced_on<e.server_on?f.CONFLICT:f.CHANGED_LOCALLY:e.synced_on<e.server_on?f.CHANGED_SERVER:f.SYNCED:f.SERVER:f.LOCAL},getOccurrence:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.occurrences.at(e)},getSample:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.samples.at(e)},getMedia:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.media.at(e)},getUserAuth:function(){if(!this.user||!this.password)return null;var e="function"==typeof this.user?this.user():this.user,t="function"==typeof this.password?this.password():this.password,r=btoa(e+":"+t);return"Basic  "+r},_parseModels:function(e,t){if(!e)return new P.default([],{model:t});var r=this,n=[];return l.default.each(e,function(e){if(e instanceof t)e.setParent(r),n.push(e);else{var i=l.default.extend(e,{parent:r}),a=new t(e.attributes,i);n.push(a)}}),new P.default(n,{model:t})},isNew:function(){return!this.id},fetch:function(e){var t=this,r=this,n=new Promise(function(n,i){return e=l.default.extend({parse:!0},e),t.sync("read",t,e).then(function(t){return r.id=t.id,r.metadata=t.metadata,!!r.set(t.attributes,e)&&(r.occurrences=r._parseModels(t.occurrences,r.Occurrence),r.samples=r._parseModels(t.samples,E),r.media=r._parseModels(t.media,r.Media),r.trigger("sync",r,t,e),n(r),null)}).catch(i)});return n},_getDefaultMetadata:function(e){var t="function"==typeof this.metadata?this.metadata():this.metadata,r=new Date,n={survey_id:e.survey_id,input_form:e.input_form,created_on:r,updated_on:r,synced_on:null,server_on:null};return c.default.extend(!0,n,t,e.metadata)}});l.default.extend(E.prototype,v.default),E.keys={date:{id:"date"},location:{id:"entered_sref"},location_type:{id:"entered_sref_system",values:{british:"OSGB",irish:"OSIE",latlon:4326}},form:{id:"input_form"},group:{id:"group_id"}},t.default=E},function(e,t){e.exports=n},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.API_BASE="api/",t.API_VER="v1",t.API_SAMPLES_PATH="/samples",t.API_REPORTS_PATH="/reports",t.SYNCHRONISING=0,t.SYNCED=1,t.LOCAL=2,t.SERVER=3,t.CHANGED_LOCALLY=4,t.CHANGED_SERVER=5,t.CONFLICT=-1},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,r="x"===e?t:3&t|8;return r.toString(16)})},n=function(e,t){for(var r=atob(e.split(",")[1]),n=[],i=0;i<r.length;i++)n.push(r.charCodeAt(i));return new Blob([new Uint8Array(n)],{type:t})},i=function(e){if(!e)return!1;var t=e.toString(),r=/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i;return!!t.match(r)},a=function(e){var t=e,r=new Date,n="0",i="0",a=/\d{2}\/\d{2}\/\d{4}$/,o=/\d{4}-\d{1,2}-\d{1,2}$/,s=/\d{1,2}-\d{1,2}-\d{4}$/,u=[];if("string"==typeof t){if(u=t.split("-"),a.test(t))return t;if(o.test(t))t=new Date(parseInt(u[0],10),parseInt(u[1],10)-1,parseInt(u[2],10));else{if(!s.test(t))throw new Error("Unknown date format");t=new Date(parseInt(u[2],10),parseInt(u[1],10)-1,parseInt(u[0],10))}}return r=t||r,n=("0"+r.getDate()).slice(-2),i=("0"+(r.getMonth()+1)).slice(-2),n+"/"+i+"/"+r.getFullYear()};t.default={getNewUUID:r,dataURItoBlob:n,isDataURL:i,formatDate:a}},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=r(1),o=n(a),s={save:function(e,t,r){var n=this,a=void 0;null==e||"object"===("undefined"==typeof e?"undefined":i(e))?(a=e,r=t):(a||(a={}),a[e]=t),r=o.default.extend({validate:!0,parse:!0},r);var s=r.wait;if(a&&!s){if(!this.set(a,r))return!1}else if(!this._validate(a,r))return!1;var u=new Promise(function(i,u){var c=n.attributes;a&&s&&(n.attributes=o.default.extend({},c,a));var d="create";!n.isNew()&&r.remote&&(d=r.patch?"patch":"update"),"patch"!==d||r.attrs||(r.attrs=a),n.parent&&!r.remote?n.parent.save(e,t,r).then(function(){n.attributes=c,n.trigger("sync",n,null,r),i(n)}).catch(u):n.sync(d,n,r).then(function(e){if(r.remote){n._remoteCreateParse(n,e.data);var t=new Date;return n.metadata.server_on=t,n.metadata.updated_on=t,n.metadata.synced_on=t,n.attributes=c,void n.save().then(function(){n.trigger("sync",n,e,r),i(n)})}n.trigger("sync",n,e,r),i(n)}).catch(function(e){n.trigger("error",e),u(e)}),n.attributes=c});return u},destroy:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this,r=this.collection,n=new Promise(function(n,i){function a(){t.stopListening(),t.trigger("destroy",t,r,e),e.noSave?(t.trigger("sync",t,null,e),n(t)):t.parent.save(null,e).then(function(){t.trigger("sync",t,null,e),n(t)})}t.parent?e.remote?t.sync("delete",t,e).then(a):a():t.sync("delete",t,e).then(function(){t.stopListening(),t.trigger("destroy",t,r,e),t.trigger("sync",t,null,e),n(t)}).catch(i)});return n}};t.default=s},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=r(3),s=n(o),u=r(1),c=n(u),d=r(9),l=n(d),f=r(10),h=n(f),m=100,p=100,v=s.default.Model.extend({constructor:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=e;if("string"==typeof e){var n=e;return void(r={data:n})}this.id=t.id,this.cid=t.cid||l.default.getNewUUID(),this.setParent(t.parent||this.parent),this.attributes={},t.collection&&(this.collection=t.collection),t.parse&&(r=this.parse(r,t)||{}),r=c.default.defaults({},r,c.default.result(this,"defaults")),this.set(r,t),this.changed={},t.metadata?this.metadata=t.metadata:this.metadata={created_on:new Date},this.initialize.apply(this,arguments)},sync:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.remote?this._syncRemote(e,t,r):Promise.reject(new Error("Local sync is not possible yet."))},_syncRemote:function(){return Promise.reject(new Error("Remote sync is not possible yet."))},getURL:function(){return this.get("data")},setParent:function(e){if(e){var t=this;this.parent=e,this.parent.on("destroy",function(){t.destroy({noSave:!0})})}},resize:function(e,t){var r=this,n=this,i=new Promise(function(i,o){v.resize(r.getURL(),r.get("type"),e,t).then(function(e){var t=a(e,2),r=t[0],o=t[1];n.set("data",o),i([r,o])}).catch(o)});return i},addThumbnail:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=this,n=new Promise(function(n,i){var o=/^data:/i;return o.test(e.getURL())?void v.resize(e.getURL(),e.get("type"),m||t.width,m||t.width).then(function(e){var t=a(e,2),i=t[1];r.set("thumbnail",i),n()}).catch(i):void v.getDataURI(e.getURL(),{width:m||t.width,height:p||t.height}).then(function(e){r.set("thumbnail",e[0]),n()}).catch(i)});return n},validate:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.remote?this.validateRemote(e,t):null},validateRemote:function(e){var t=c.default.extend({},this.attributes,e),r={};return t.data||(r.data="can't be empty"),t.type||(r.type="can't be empty"),c.default.isEmpty(r)?null:r},toJSON:function(){var e={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes};return e},_getSubmission:function(){var e={id:this.id,name:this.cid};return[e]}});c.default.extend(v.prototype,h.default),c.default.extend(v,{getDataURI:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=new Promise(function(r,n){if("string"==typeof e){var o=function(){var n=e.replace(/.*\.([a-z]+)$/i,"$1");return"jpg"===n&&(n="jpeg"),v.resize(e,n,t.width,t.height).then(function(e){var t=a(e,2),i=t[0],o=t[1];r([o,n,i.width,i.height])}),{v:void 0}}();if("object"===("undefined"==typeof o?"undefined":i(o)))return o.v}if(!window.FileReader)return void n(new Error("No File Reader"));var s=new FileReader;s.onload=function(n){t.width||t.height?v.resize(n.target.result,e.type,t.width,t.height).then(function(t){var n=a(t,2),i=n[0],o=n[1];r([o,e.type,i.width,i.height])}):!function(){var t=new window.Image;t.onload=function(){var i=e.type.replace(/.*\/([a-z]+)$/i,"$1");r([n.target.result,i,t.width,t.height])},t.src=n.target.result}()},s.readAsDataURL(e)});return r},resize:function(e,t,r,n){var i=new Promise(function(i){var a=new window.Image;a.onload=function(){var e=a.width,o=a.height,s=r||e,u=n||o,c=null;c=e>o?e/s:o/u,e/=c,o/=c;var d=document.createElement("canvas");d.width=e,d.height=o,d.getContext("2d").drawImage(a,0,0,e,o),i([a,d.toDataURL(t)])},a.src=e});return i}}),t.default=v},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=r(3),o=n(a),s=r(1),u=n(s),c=r(7),d=n(c),l=r(9),f=n(l),h=r(10),m=n(h),p=r(11),v=n(p),y=r(5),g=n(y),_=o.default.Model.extend({Media:v.default,constructor:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this,i=t;this.id=r.id,this.cid=r.cid||f.default.getNewUUID(),this.setParent(r.parent||this.parent),this.keys=r.keys||this.keys,r.Media&&(this.Media=r.Media),this.attributes={},r.collection&&(this.collection=r.collection),r.parse&&(i=this.parse(i,r)||{}),i=u.default.defaults({},i,u.default.result(this,"defaults")),this.set(i,r),this.changed={},this.metadata=this._getDefaultMetadata(r),r.media?!function(){var t=[];u.default.each(r.media,function(r){if(r instanceof e.Media)r.setParent(n),t.push(r);else{var i=u.default.extend(r,{parent:n});t.push(new e.Media(r.attributes,i))}}),e.media=new g.default(t,{model:e.Media})}():this.media=new g.default([],{model:this.Media}),this.initialize.apply(this,arguments)},setParent:function(e){if(e){var t=this;this.parent=e,this.parent.on("destroy",function(){t.destroy({noSave:!0})})}},addMedia:function(e){e&&(e.setParent(this),this.media.add(e))},getMedia:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.media.at(e)},validate:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.remote?this.validateRemote(e,t):null},validateRemote:function(e){var t=u.default.extend({},this.attributes,e),r={},n={};t.taxon||(n.taxon="can't be blank"),this.media.length&&this.media.each(function(e){var t=e.validateRemote();if(t){var n=e.cid;r[n]=t}});var i={};return u.default.isEmpty(r)||(i.media=r),u.default.isEmpty(n)||(i.occurrence=n),u.default.isEmpty(i)?null:i},toJSON:function(){var e=void 0;this.media?e=this.media.toJSON():(e=[],console.warn("toJSON media missing"));var t={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,media:e};return t},_getSubmission:function(){var e=this,t="function"==typeof this.keys?this.keys():this.keys,r=d.default.extend(!0,_.keys,t),n=u.default.clone(this.media.models),a={id:this.id,external_key:this.cid,fields:{},media:[]};this.metadata.training&&(a.training=this.metadata.training),this.metadata.release_status&&(a.release_status=this.metadata.release_status),this.metadata.record_status&&(a.record_status=this.metadata.record_status),this.metadata.sensitive&&(a.sensitive=this.metadata.sensitive),this.metadata.confidential&&(a.confidential=this.metadata.confidential),this.metadata.sensitivity_precision&&(a.sensitivity_precision=this.metadata.sensitivity_precision),Object.keys(this.attributes).forEach(function(t){var n=e.attributes[t];if(n){if(!r[t])return"email"!==t&&console.warn("Indicia: no such key: "+t),void(a.fields[t]=n);var i=r[t].id||t;r[t].values&&(n="function"==typeof r[t].values?r[t].values(n,a,e):r[t].values[n]),n&&(a.fields[i]=n)}});var o=this.media._getSubmission(),s=i(o,1),c=s[0];return a.media=c,[a,n]},sync:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.remote?this._syncRemote(e,t,r):Promise.reject(new Error("Local sync is not possible yet."))},_syncRemote:function(){return Promise.reject(new Error("Remote sync is not possible yet."))},_getDefaultMetadata:function(e){var t="function"==typeof this.metadata?this.metadata():this.metadata;e.metadata=e.metadata||{};var r=new Date,n={training:e.training,created_on:r,updated_on:r,synced_on:null,server_on:null};return d.default.extend(!0,n,t,e.metadata)}});u.default.extend(_.prototype,m.default),_.keys={taxon:{id:"taxa_taxon_list_id"}},t.default=_},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(7),s=n(o),u=r(8),c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e),this.host_url=t.host_url||this.host_url,this.user=t.user||this.user,this.password=t.password||this.password,this.report=t.report||this.report,this.api_key=t.api_key||this.api_key,this.params=t.params||this.params,this.timeout=t.timeout||18e4}return a(e,[{key:"run",value:function(e){var t=this,r=this,n=new Promise(function(n,i){var a=t.host_url+u.API_BASE+u.API_VER+u.API_REPORTS_PATH+t.report;e=s.default.extend(e||r.params,{api_key:r.api_key}),s.default.get({url:a,data:e,timeout:r.timeout,headers:{authorization:r.getUserAuth(),"x-api-key":r.api_key},success:n,error:function e(t,r,n){var e=new Error(n);if(t.responseJSON&&t.responseJSON.errors){var a=t.responseJSON.errors.reduce(function(e,t){return""+e+t.title+"\n"},"");e=new Error(a)}i(e)}})});return n}},{key:"getUserAuth",value:function(){if(!this.user||!this.password)return null;var e="function"==typeof this.user?this.user():this.user,t="function"==typeof this.password?this.password():this.password,r=btoa(e+":"+t);return"Basic  "+r}}]),e}();t.default=c}])});