/*!
 * 
 * indicia 4.3.0
 * Indicia JavaScript SDK.
 * https://github.com/Indicia-Team/indicia-js
 * Author Karolis Kazlauskis
 * Released under the GNU GPL v3 license.
 * http://www.gnu.org/licenses/gpl.html
 * 
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("underscore"),require("backbone"),require("localforage"),require("jquery")):"function"==typeof define&&define.amd?define("Indicia",["_","Backbone","localforage","$"],t):"object"==typeof exports?exports.Indicia=t(require("underscore"),require("backbone"),require("localforage"),require("jquery")):e.Indicia=t(e._,e.Backbone,e.localforage,e.$)}(this,function(e,t,r,n){return function(e){function t(n){if(r[n])return r[n].exports;var i=r[n]={exports:{},id:n,loaded:!1};return e[n].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function i(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=r(1),s=i(a),o=r(2),u=i(o),c=r(5),d=i(c),l=r(6),f=i(l),h=r(12),m=i(h),p=r(11),v=i(p),y=r(13),g=i(y),_=r(8),b=n(_),w={VERSION:"4.3.0",Store:u.default,Collection:d.default,Sample:f.default,Occurrence:m.default,Media:v.default,Report:g.default};s.default.extend(w,b),t.default=w},function(t,r){t.exports=e},function(e,t,r){(function(e){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(3),u=n(o),c=r(4),d=n(c),l=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,t);var r=this;this.localForage=null,this.ready=new Promise(function(n,i){var s=new Promise(function(t){e.driverOrder&&"object"===a(e.driverOrder[0])?d.default.defineDriver(e.driverOrder[0]).then(t):t()});s.then(function(){var a={name:e.name||"indicia",storeName:e.storeName||"models"};e.version&&(a.version=e.version);var s=e.driverOrder||["indexeddb","websql","localstorage"],o=t._getDriverOrder(s),u=e.LocalForage||d.default;r.localForage=u.createInstance(a),r.localForage.setDriver(o).then(function(){n(r.localForage)}).catch(i)})})}return s(t,[{key:"sync",value:function(e,t,r){switch(e){case"read":return t.cid?this.find(t,r):this.findAll(t,r);case"create":return this.create(t,r);case"update":return this.update(t,r);case"delete":return this.destroy(t,r);default:return Promise.reject(new Error("Local Sync method not found "+e))}}},{key:"save",value:function(t,r){var n=this;return this._callWhenReady(function(){if(t instanceof u.default.Collection){if(!t.models.length)return Promise.resolve();var i=[];return e.each(t.models,function(e){e.store&&i.push(e.save(null,r))}),Promise.all(i)}if(!t.id&&!t.cid)return Promise.reject(new Error("Invalid model passed to store"));var a=t.cid;return n.localForage.setItem(a,t.toJSON()).then(function(){return Promise.resolve()})})}},{key:"create",value:function(e,t){return this.update(e,t)}},{key:"update",value:function(e,t){return this.save(e,t)}},{key:"find",value:function(e){var t=this;return this._callWhenReady(function(){return t.localForage.getItem(e.cid).then(function(t){return t?t:Promise.reject("LocalForage entry with "+e.cid+" as key not found")})})}},{key:"findAll",value:function(){var e=this;return this._callWhenReady(function(){var t=[];return e.localForage.iterate(function(e){t.push(e)}).then(function(){return Promise.resolve(t)})})}},{key:"destroy",value:function(t){var r=this;return this._callWhenReady(function(){if(t instanceof u.default.Collection){if(!t.models.length)return Promise.resolve();var n=[];return e.each(e.clone(t.models),function(e){e.store&&n.push(e.destroy())}),Promise.all(n)}if(!t.id&&!t.cid)return Promise.reject(new Error("Invalid model passed to store"));var i=t.cid;return r.localForage.removeItem(i).then(function(){return Promise.resolve(t.toJSON())})})}},{key:"_callWhenReady",value:function(e){var t=this;return this.ready.then(function(){return e.bind(t)()})}}],[{key:"_getDriverOrder",value:function(e){return e.map(function(e){switch(e){case"indexeddb":return d.default.INDEXEDDB;case"websql":return d.default.WEBSQL;case"localstorage":return d.default.LOCALSTORAGE;default:return"object"===("undefined"==typeof e?"undefined":a(e))&&e._driver?e._driver:console.error("No such db driver!")}})}}]),t}();t.default=l}).call(t,r(1))},function(e,r){e.exports=t},function(e,t){e.exports=r},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=r(3),s=n(a),o=r(1),u=n(o),c=r(2),d=n(c),l=s.default.Collection.extend({constructor:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{});return this.store=e.store||this.store||new d.default,e.model||this.model?void s.default.Collection.prototype.constructor.apply(this,arguments):void console.error("Collection's model must be provided")},comparator:function(e){return e.metadata.created_on},size:function(){return Promise.resolve(this.length)},save:function(e,t){return this.sync("create",e||this,t)},destroy:function(e,t){return this.sync("delete",e||this,t)},fetch:function(e){e=u.default.extend({parse:!0},e);var t=this;return this.sync("read",this,e).then(function(r){var n=e.reset?"reset":"set";t[n](r,e);try{t.trigger("sync",t,r,e)}catch(e){}})},sync:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(r.remote)return this._syncRemote(e,t,r);if(!this.store)return Promise.reject(new Error("Trying to locally sync a collection without a store"));try{this.trigger("request",t,null,r)}catch(e){}return this.store.sync(e,t,r)},_syncRemote:function(e,t,r){switch(t.synchronising=!0,e){case"create":if(!t.models.length)return Promise.resolve();var n=[];return u.default.each(t.models,function(e){e.store&&n.push(e.save(null,r))}),Promise.all(n);case"update":return t.synchronising=!1,Promise.reject(new Error("Updating the model is not possible yet."));case"read":return t.synchronising=!1,Promise.reject(new Error("Reading the model is not possible yet."));case"delete":return t.synchronising=!1,Promise.reject(new Error("Deleting the model is not possible yet."));default:return t.synchronising=!1,Promise.reject(new Error("No such remote sync option: "+e))}},_getSubmission:function(e){var t=[],r=[];return this.models.forEach(function(n){var a=n._getSubmission(e),s=i(a,2),o=s[0],u=s[1];t.push(o),r=r.concat(u)}),[t,r]},_prepareModel:function(e){if(this._isModel(e))return e.collection||(e.collection=this),e;var t=e.attributes;e=e?u.default.clone(e):{},e.collection=this,e.store=this.store;var r=new this.model(t,e);return r.validationError?(this.trigger("invalid",this,r.validationError,e),!1):r}});t.default=l},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=r(3),s=n(a),o=r(7),u=n(o),c=r(1),d=n(c),l=r(8),f=r(9),h=n(f),m=r(10),p=n(m),v=r(11),y=n(v),g=r(2),_=n(g),b=r(12),w=n(b),S=r(5),x=n(S),P=s.default.Model.extend({Media:y.default,Occurrence:w.default,host_url:null,api_key:null,user:null,password:null,constructor:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.id=t.id,this.cid=t.cid||h.default.getNewUUID(),this.setParent(t.parent||this.parent),this.store=t.store||this.store||new _.default,this.keys=t.keys||this.keys,t.Media&&(this.Media=t.Media),t.Occurrence&&(this.Occurrence=t.Occurrence),t.onSend&&(this.onSend=t.onSend),this.host_url=t.host_url||this.host_url,this.api_key=t.api_key||this.api_key,this.user=t.user||this.user,this.password=t.password||this.password,this.attributes={};var r={date:new Date,location_type:"latlon"},n=d.default.extend(r,e);t.collection&&(this.collection=t.collection),t.parse&&(n=this.parse(n,t)||{}),n=d.default.defaults({},n,d.default.result(this,"defaults")),this.set(n,t),this.changed={},this.metadata=this._getDefaultMetadata(t),this.occurrences=this._parseModels(t.occurrences,this.Occurrence),this.samples=this._parseModels(t.samples,this.constructor),this.media=this._parseModels(t.media,this.Media),this.initialize.apply(this,arguments)},setParent:function(e){if(e){var t=this;this.parent=e,this.parent.on("destroy",function(){t.destroy({noSave:!0})})}},addSample:function(e){e&&(e.setParent(this),this.samples.push(e))},addOccurrence:function(e){e&&(e.setParent(this),this.occurrences.push(e))},addMedia:function(e){e&&(e.setParent(this),this.media.add(e))},validate:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.remote?this.validateRemote(e,t):null},validateRemote:function(e){var t=d.default.extend({},this.attributes,e),r={},n={},i={},a={};if(t.location||(r.location="can't be blank"),t.location_type||(r.location_type="can't be blank"),t.date){var s=new Date(t.date);("Invalid Date"===s||s>new Date)&&(r.date=new Date(s)>new Date?"future date":"invalid")}else r.date="can't be blank";this.samples.length||this.occurrences.length||(r.occurrences="no occurrences"),this.samples.length&&this.samples.each(function(e){var t=e.validateRemote();if(t){var r=e.cid;n[r]=t}}),this.occurrences.length&&this.occurrences.each(function(e){var t=e.validateRemote();if(t){var r=e.cid;i[r]=t}}),this.media.length&&this.media.each(function(e){var t=e.validateRemote();if(t){var r=e.cid;a[r]=t}});var o={};return d.default.isEmpty(a)||(o.media=a),d.default.isEmpty(i)||(o.occurrences=i),d.default.isEmpty(n)||(o.samples=n),d.default.isEmpty(r)||(o.attributes=r),d.default.isEmpty(o)?null:o},sync:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(r.remote)return this._syncRemote(e,t,r);if(!this.store)return Promise.reject(new Error("Trying to locally sync a model without a store"));try{this.trigger("request",t,null,r)}catch(e){}return this.store.sync(e,t,r)},_syncRemote:function(e,t,r){if(!this.host_url)return Promise.reject(new Error('A "url" property or function must be specified'));switch(t.synchronising=!0,e){case"create":return this._create(t,r).then(function(e){return t.synchronising=!1,e}).catch(function(e){return t.synchronising=!1,Promise.reject(e)});case"update":return t.synchronising=!1,Promise.reject(new Error("Updating the model is not possible yet."));case"read":return t.synchronising=!1,Promise.reject(new Error("Reading the model is not possible yet."));case"delete":return t.synchronising=!1,Promise.reject(new Error("Deleting the model is not possible yet."));default:return t.synchronising=!1,Promise.reject(new Error("No such remote sync option: "+e))}},_create:function(e,t){var r=this;return r._getModelData(e).then(function(n){return r._ajaxModel(n,e,t)})},_ajaxModel:function(e,t,r){var n=this,i=new Promise(function(i,a){var o=r.timeout||n.timeout||3e4;o="function"==typeof o?o():o;var u=n.host_url+l.API_BASE+l.API_VER+l.API_SAMPLES_PATH,c=r.xhr=s.default.ajax({url:u,type:"POST",data:e,headers:{authorization:n.getUserAuth(),"x-api-key":n.api_key},processData:!1,contentType:!1,timeout:o});c.done(function(e){return i(e)}),c.fail(function(e,r,n){if("Conflict"===n){var s={data:{id:null,external_key:null,occurrences:[]}};return e.responseJSON.errors.forEach(function(e){s.data.id=e.sample_id,s.data.external_key=e.sample_external_key,s.data.occurrences.push({id:e.id,external_key:e.external_key})}),void i(s)}var o=new Error(n);if(e.responseJSON&&e.responseJSON.errors){var u=e.responseJSON.errors.reduce(function(e,t){return""+e+t.title+"\n"},"");o=new Error(u)}try{t.trigger("error:remote",o)}catch(e){}a(o)});try{t.trigger("request:remote",t,c,r)}catch(e){}});return i},_remoteCreateParse:function(e,t){function r(e){n[e.external_key]=e.id,e.samples&&e.samples.forEach(function(e){return r(e)}),e.occurrences&&e.occurrences.forEach(function(e){return r(e)})}var n={};r(t),this._setNewRemoteID(e,n)},_setNewRemoteID:function(e,t){var r=this,n=t[e.cid];n&&(e.id=n),e.samples&&e.samples.forEach(function(e){return r._setNewRemoteID(e,t)}),e.occurrences&&e.occurrences.forEach(function(e){return r._setNewRemoteID(e,t)}),e.media&&e.media.forEach(function(e){return r._setNewRemoteID(e,t)})},_getModelData:function(e){if(!e)throw new Error("No model passed to _getModelData.");var t=this,r=e._getSubmission(),n=i(r,2),a=n[0],s=n[1];return a.type="samples",this.onSend?this.onSend(a,s).then(function(e){var r=i(e,2),n=r[0],a=r[1];return t._normaliseModelData(n,a)}):this._normaliseModelData(a,s)},_normaliseModelData:function(e,t){var r=JSON.stringify({data:e});if(t.length){var n=new FormData;return n.append("submission",r),this._mediaAppend(t,n).then(function(){return Promise.resolve(n)})}return Promise.resolve(r)},_mediaAppend:function(e,t){var r=[];return e.forEach(function(e){var n=new Promise(function(r){function n(e,n,i,o){var u=a,c=a;a.match(/image.*/)?u=a.split("/")[1]:c="image/"+c,o||(o=h.default.dataURItoBlob(i,c)),t.append(s,o,s+"."+u),r()}var i=e.getURL(),a=e.get("type"),s=e.cid;if(h.default.isDataURL(i))n(null,null,i);else{var o=new XMLHttpRequest;o.open("GET",i,!0),o.responseType="blob",o.onload=function(){n(null,null,null,o.response)},o.send()}});r.push(n)}),Promise.all(r)},_getSubmission:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this,r="function"==typeof this.keys?this.keys():this.keys,n=u.default.extend(!0,P.keys,r),a=d.default.clone(this.media.models),s={id:this.id,external_key:this.cid,survey_id:this.metadata.survey_id,input_form:this.metadata.input_form,fields:{},media:[]};Object.keys(this.attributes).forEach(function(e){var r=t.attributes[e];if(r){if(!n[e])return"email"!==e&&console.warn("Indicia: no such key: "+e),void(s.fields[e]=r);var i=n[e].id||e;n[e].values&&(r="function"==typeof n[e].values?n[e].values(r,s,t):d.default.isArray(r)?r.map(function(t){return n[e].values[t]}):n[e].values[r]),r&&(s.fields[i]=r)}});var o=d.default.extend({},e);this.metadata.training&&(o.training=this.metadata.training),this.metadata.release_status&&(o.release_status=this.metadata.release_status),this.metadata.record_status&&(o.record_status=this.metadata.record_status),this.metadata.sensitive&&(o.sensitive=this.metadata.sensitive),this.metadata.confidential&&(o.confidential=this.metadata.confidential),this.metadata.sensitivity_precision&&(o.sensitivity_precision=this.metadata.sensitivity_precision);var c=this.occurrences._getSubmission(o),l=i(c,2),f=l[0],h=l[1];s.occurrences=f,a=a.concat(h);var m=this.samples._getSubmission(o),p=i(m,2),v=p[0],y=p[1];s.samples=v,a=a.concat(y);var g=this.media._getSubmission(o),_=i(g,1),b=_[0];return s.media=b,[s,a]},toJSON:function(){var e=void 0;this.occurrences?e=this.occurrences.toJSON():(e=[],console.warn("toJSON occurrences missing"));var t=void 0;this.samples?t=this.samples.toJSON():(t=[],console.warn("toJSON samples missing"));var r=void 0;this.media?r=this.media.toJSON():(r=[],console.warn("toJSON media missing"));var n={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,occurrences:e,samples:t,media:r};return n},getSyncStatus:function(){var e=this.metadata;return this.synchronising?l.SYNCHRONISING:this.id>=0?e.synced_on?e.synced_on<e.updated_on?e.synced_on<e.server_on?l.CONFLICT:l.CHANGED_LOCALLY:e.synced_on<e.server_on?l.CHANGED_SERVER:l.SYNCED:l.SERVER:l.LOCAL},getOccurrence:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.occurrences.at(e)},getSample:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.samples.at(e)},getMedia:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.media.at(e)},getUserAuth:function(){if(!this.user||!this.password)return null;var e="function"==typeof this.user?this.user():this.user,t="function"==typeof this.password?this.password():this.password,r=btoa(e+":"+t);return"Basic  "+r},_parseModels:function(e,t){if(!e)return new x.default([],{model:t});var r=this,n=[];return d.default.each(e,function(e){if(e instanceof t)e.setParent(r),n.push(e);else{var i=d.default.extend(e,{parent:r}),a=new t(e.attributes,i);n.push(a)}}),new x.default(n,{model:t})},isNew:function(){return!this.id},fetch:function(e){var t=this,r=this,n=new Promise(function(n,i){return e=d.default.extend({parse:!0},e),t.sync("read",t,e).then(function(t){if(r.id=t.id,r.metadata=t.metadata,!r.set(t.attributes,e))return!1;r.occurrences=r._parseModels(t.occurrences,r.Occurrence),r.samples=r._parseModels(t.samples,P),r.media=r._parseModels(t.media,r.Media);try{r.trigger("sync",r,t,e)}catch(e){}return n(r),null}).catch(i)});return n},_getDefaultMetadata:function(e){var t="function"==typeof this.metadata?this.metadata():this.metadata,r=new Date,n={survey_id:e.survey_id,input_form:e.input_form,created_on:r,updated_on:r,synced_on:null,server_on:null};return u.default.extend(!0,n,t,e.metadata)}});d.default.extend(P.prototype,p.default),P.keys={date:{id:"date"},sample_method_id:{id:"sample_method_id"},location:{id:"entered_sref"},location_type:{id:"entered_sref_system",values:{british:"OSGB",irish:"OSIE",channel:"utm30ed50",latlon:4326}},form:{id:"input_form"},group:{id:"group_id"},comment:{id:"comment"}},t.default=P},function(e,t){e.exports=n},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.API_BASE="api/",t.API_VER="v1",t.API_SAMPLES_PATH="/samples",t.API_REPORTS_PATH="/reports",t.SYNCHRONISING=0,t.SYNCED=1,t.LOCAL=2,t.SERVER=3,t.CHANGED_LOCALLY=4,t.CHANGED_SERVER=5,t.CONFLICT=-1},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,r="x"===e?t:3&t|8;return r.toString(16)})},i=function(e,t){for(var r=atob(e.split(",")[1]),n=[],i=0;i<r.length;i++)n.push(r.charCodeAt(i));return new Blob([new Uint8Array(n)],{type:t})},a=function(e){if(!e)return!1;var t=e.toString(),r=/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i;return!!t.match(r)},s=function(e){function t(e){for(var t={},r="Boolean Number String Function Array Date RegExp Object".split(" "),n=0;n<r.length;n++)t["[object "+r[n]+"]"]=r[n].toLowerCase();return null==e?String(e):t[toString.call(e)]||"object"}function n(e){return e&&"object"===("undefined"==typeof e?"undefined":r(e))&&"setInterval"in e}if(!e||"object"!==t(e)||e.nodeType||n(e))return!1;if(e.constructor&&!hasOwn.call(e,"constructor")&&!hasOwn.call(e.constructor.prototype,"isPrototypeOf"))return!1;var i=void 0;for(i in e);return void 0===i||hasOwn.call(e,i)},o=function(e){for(var t in e)return!1;return!0},u=function(e){var t=e,r=new Date,n=0,i=0,a=/\d{2}\/\d{2}\/\d{4}$/,s=/\d{4}-\d{1,2}-\d{1,2}$/,o=/\d{1,2}-\d{1,2}-\d{4}$/,u=[];if("string"==typeof t){if(u=t.split("-"),a.test(t))return t;s.test(t)?t=new Date(window.parseInt(u[0]),window.parseInt(u[1])-1,window.parseInt(u[2])):o.test(t)&&(t=new Date(window.parseInt(u[2]),window.parseInt(u[1])-1,window.parseInt(u[0])))}return r=t||r,n=("0"+r.getDate()).slice(-2),i=("0"+(r.getMonth()+1)).slice(-2),n+"/"+i+"/"+r.getFullYear()};t.default={getNewUUID:n,dataURItoBlob:i,isDataURL:a,isPlainObject:s,isEmptyObject:o,formatDate:u}},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=r(1),s=n(a),o={save:function(e,t,r){var n=this,a=void 0;null==e||"object"===("undefined"==typeof e?"undefined":i(e))?(a=e,r=t):(a={})[e]=t,r=s.default.extend({validate:!0,parse:!0},r);var o=r.wait;if(a&&!o){if(!this.set(a,r))return!1}else if(!this._validate(a,r))return!1;var u=n.attributes;a&&o&&(n.attributes=s.default.extend({},u,a));var c="create";return!n.isNew()&&r.remote&&(c=r.patch?"patch":"update"),"patch"!==c||r.attrs||(r.attrs=a),n.parent&&!r.remote?n.parent.save(e,t,r).then(function(){n.attributes=u;try{n.trigger("sync",n,null,r)}catch(e){}return n}).catch(function(e){try{n.trigger("error",e)}catch(e){}return Promise.reject(e)}):n.sync(c,n,r).then(function(e){if(r.remote){n._remoteCreateParse(n,e.data);var t=new Date;return n.metadata.server_on=t,n.metadata.updated_on=t,n.metadata.synced_on=t,n.attributes=u,n.save().then(function(){try{n.trigger("sync:remote",n,e,r)}catch(e){}return n})}try{n.trigger("sync",n,e,r)}catch(e){}return n}).catch(function(e){try{n.trigger("error",e)}catch(e){}return Promise.reject(e)})},destroy:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this,r=this.collection,n=new Promise(function(n,i){function a(){t.stopListening();try{t.trigger("destroy",t,r,e)}catch(e){}if(e.noSave){try{t.trigger("sync",t,null,e)}catch(e){}n(t)}else t.parent.save(null,e).then(function(){try{t.trigger("sync",t,null,e)}catch(e){}n(t)})}t.parent?e.remote?t.sync("delete",t,e).then(a):a():t.sync("delete",t,e).then(function(){t.stopListening();try{t.trigger("destroy",t,r,e)}catch(e){}try{t.trigger("sync",t,null,e)}catch(e){}n(t)}).catch(i)});return n}};t.default=o},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=r(3),s=n(a),o=r(1),u=n(o),c=r(9),d=n(c),l=r(10),f=n(l),h=100,m=100,p=s.default.Model.extend({constructor:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=e;if("string"==typeof e){var n=e;return void(r={data:n})}this.id=t.id,this.cid=t.cid||d.default.getNewUUID(),this.setParent(t.parent||this.parent),this.attributes={},t.collection&&(this.collection=t.collection),t.parse&&(r=this.parse(r,t)||{}),r=u.default.defaults({},r,u.default.result(this,"defaults")),this.set(r,t),this.changed={},t.metadata?this.metadata=t.metadata:this.metadata={created_on:new Date},this.initialize.apply(this,arguments)},sync:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.remote?this._syncRemote(e,t,r):Promise.reject(new Error("Local sync is not possible yet."))},_syncRemote:function(){return Promise.reject(new Error("Remote sync is not possible yet."))},getURL:function(){return this.get("data")},setParent:function(e){if(e){var t=this;this.parent=e,this.parent.on("destroy",function(){t.destroy({noSave:!0})})}},resize:function(e,t){var r=this,n=this,a=new Promise(function(a,s){p.resize(r.getURL(),r.get("type"),e,t).then(function(e){var t=i(e,2),r=t[0],s=t[1];n.set("data",s),a([r,s])}).catch(s)});return a},addThumbnail:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=this,n=new Promise(function(n,a){var s=/^data:/i;return s.test(e.getURL())?void p.resize(e.getURL(),e.get("type"),h||t.width,h||t.width).then(function(e){var t=i(e,2),a=t[1];r.set("thumbnail",a),n()}).catch(a):void p.getDataURI(e.getURL(),{width:h||t.width,height:m||t.height}).then(function(e){r.set("thumbnail",e[0]),n()}).catch(a)});return n},validate:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.remote?this.validateRemote(e,t):null},validateRemote:function(e){var t=u.default.extend({},this.attributes,e),r={};return t.data||(r.attributes||(r.attributes={}),r.attributes.data="can't be empty"),t.type||(r.attributes||(r.attributes={}),r.attributes.type="can't be empty"),u.default.isEmpty(r)?null:r},toJSON:function(){var e={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes};return e},_getSubmission:function(){var e={id:this.id,name:this.cid};return[e]}});u.default.extend(p.prototype,f.default),u.default.extend(p,{getDataURI:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=new Promise(function(r,n){if("string"==typeof e){var a=e.replace(/.*\.([a-z]+)$/i,"$1");return"jpg"===a&&(a="jpeg"),void p.resize(e,a,t.width,t.height).then(function(e){var t=i(e,2),n=t[0],s=t[1];r([s,a,n.width,n.height])})}if(!window.FileReader)return void n(new Error("No File Reader"));var s=new FileReader;s.onload=function(n){if(t.width||t.height)p.resize(n.target.result,e.type,t.width,t.height).then(function(t){var n=i(t,2),a=n[0],s=n[1];r([s,e.type,a.width,a.height])});else{var a=new window.Image;a.onload=function(){var t=e.type.replace(/.*\/([a-z]+)$/i,"$1");r([n.target.result,t,a.width,a.height])},a.src=n.target.result}},s.readAsDataURL(e)});return r},resize:function(e,t,r,n){var i=new Promise(function(i){var a=new window.Image;a.onload=function(){var e=a.width,s=a.height,o=r||e,u=n||s,c=null;c=e>s?e/o:s/u,e/=c,s/=c;var d=document.createElement("canvas");d.width=e,d.height=s,d.getContext("2d").drawImage(a,0,0,e,s),i([a,d.toDataURL(t)])},a.src=e});return i}}),t.default=p},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=r(3),s=n(a),o=r(1),u=n(o),c=r(7),d=n(c),l=r(9),f=n(l),h=r(10),m=n(h),p=r(11),v=n(p),y=r(5),g=n(y),_=s.default.Model.extend({Media:v.default,constructor:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this,i=t;if(this.id=r.id,this.cid=r.cid||f.default.getNewUUID(),this.setParent(r.parent||this.parent),this.keys=r.keys||this.keys,r.Media&&(this.Media=r.Media),this.attributes={},r.collection&&(this.collection=r.collection),r.parse&&(i=this.parse(i,r)||{}),i=u.default.defaults({},i,u.default.result(this,"defaults")),this.set(i,r),this.changed={},this.metadata=this._getDefaultMetadata(r),r.media){var a=[];u.default.each(r.media,function(t){if(t instanceof e.Media)t.setParent(n),a.push(t);else{var r=u.default.extend(t,{parent:n});a.push(new e.Media(t.attributes,r))}}),this.media=new g.default(a,{model:this.Media})}else this.media=new g.default([],{model:this.Media});this.initialize.apply(this,arguments)},setParent:function(e){if(e){var t=this;this.parent=e,this.parent.on("destroy",function(){t.destroy({noSave:!0})})}},addMedia:function(e){e&&(e.setParent(this),this.media.add(e))},getMedia:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.media.at(e)},validate:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.remote?this.validateRemote(e,t):null},validateRemote:function(e){var t=u.default.extend({},this.attributes,e),r={},n={};t.taxon||(n.taxon="can't be blank"),this.media.length&&this.media.each(function(e){var t=e.validateRemote();if(t){var n=e.cid;r[n]=t}});var i={};return u.default.isEmpty(r)||(i.media=r),u.default.isEmpty(n)||(i.attributes=n),u.default.isEmpty(i)?null:i},toJSON:function(){var e=void 0;this.media?e=this.media.toJSON():(e=[],console.warn("toJSON media missing"));var t={id:this.id,cid:this.cid,metadata:this.metadata,attributes:this.attributes,media:e};return t},_getSubmission:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this,r="function"==typeof this.keys?this.keys():this.keys,n=d.default.extend(!0,_.keys,r),a=u.default.clone(this.media.models),s={id:this.id,external_key:this.cid,fields:{},media:[]};(this.metadata.training||e.training)&&(s.training=this.metadata.training||e.training),(this.metadata.release_status||e.release_status)&&(s.release_status=this.metadata.release_status||e.release_status),(this.metadata.record_status||e.record_status)&&(s.record_status=this.metadata.record_status||e.record_status),(this.metadata.sensitive||e.sensitive)&&(s.sensitive=this.metadata.sensitive||e.sensitive),(this.metadata.confidential||e.confidential)&&(s.confidential=this.metadata.confidential||e.confidential),(this.metadata.sensitivity_precision||e.sensitivity_precision)&&(s.sensitivity_precision=this.metadata.sensitivity_precision||e.sensitivity_precision),Object.keys(this.attributes).forEach(function(e){var r=t.attributes[e];if(r){if(!n[e])return"email"!==e&&console.warn("Indicia: no such key: "+e),void(s.fields[e]=r);var i=n[e].id||e;n[e].values&&(r="function"==typeof n[e].values?n[e].values(r,s,t):u.default.isArray(r)?r.map(function(t){return n[e].values[t]}):n[e].values[r]),r&&(s.fields[i]=r)}});var o=this.media._getSubmission(),c=i(o,1),l=c[0];return s.media=l,[s,a]},sync:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.remote?this._syncRemote(e,t,r):Promise.reject(new Error("Local sync is not possible yet."))},_syncRemote:function(){return Promise.reject(new Error("Remote sync is not possible yet."))},_getDefaultMetadata:function(e){var t="function"==typeof this.metadata?this.metadata():this.metadata;e.metadata=e.metadata||{};var r=new Date,n={training:e.training,created_on:r,updated_on:r,synced_on:null,server_on:null};return d.default.extend(!0,n,t,e.metadata)}});u.default.extend(_.prototype,m.default),_.keys={taxon:{id:"taxa_taxon_list_id"},comment:{id:"comment"}},t.default=_},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(7),o=n(s),u=r(8),c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e),this.host_url=t.host_url||this.host_url,this.user=t.user||this.user,
this.password=t.password||this.password,this.report=t.report||this.report,this.api_key=t.api_key||this.api_key,this.params=t.params||this.params,this.timeout=t.timeout||18e4}return a(e,[{key:"run",value:function(e){var t=this,r=this,n=new Promise(function(n,i){var a=t.host_url+u.API_BASE+u.API_VER+u.API_REPORTS_PATH+t.report;e=o.default.extend(e||r.params,{api_key:r.api_key}),o.default.get({url:a,data:e,timeout:r.timeout,headers:{authorization:r.getUserAuth(),"x-api-key":r.api_key},success:n,error:function e(t,r,n){var e=new Error(n);if(t.responseJSON&&t.responseJSON.errors){var a=t.responseJSON.errors.reduce(function(e,t){return""+e+t.title+"\n"},"");e=new Error(a)}i(e)}})});return n}},{key:"getUserAuth",value:function(){if(!this.user||!this.password)return null;var e="function"==typeof this.user?this.user():this.user,t="function"==typeof this.password?this.password():this.password,r=btoa(e+":"+t);return"Basic  "+r}}]),e}();t.default=c}])});